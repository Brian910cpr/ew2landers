<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>910CPR – Live CPR & Medical Training Schedule</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <meta name="description" content="Live CPR and medical training schedule for 910CPR in Wilmington, Burgaw, Jacksonville, and Southeastern North Carolina. View real dates, times, locations and register in one click.">

  <style>
    :root {
      --bg-top: #ffffff;
      --bg-bottom: #e9f4ff;
      --accent: #0b74d1;
      --accent-soft: #e0eefc;
      --accent-dark: #074a86;
      --border-subtle: #d0d7e2;
      --text-main: #122033;
      --text-muted: #5d6a7c;
      --text-soft: #7b8796;
      --danger: #b3261e;
      --danger-soft: #fdecec;
      --radius-xl: 18px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: var(--text-main);
      background: linear-gradient(to bottom, var(--bg-top), var(--bg-bottom));
      min-height: 100vh;
    }

    a {
      color: var(--accent-dark);
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }

    .page {
      max-width: 1120px;
      margin: 0 auto;
      padding: 16px 16px 40px;
    }

    header {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 20px;
    }

    @media (min-width: 720px) {
      header {
        flex-direction: row;
        align-items: flex-start;
        justify-content: space-between;
      }
    }

    .brand-block {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .brand-title {
      font-size: 1.6rem;
      font-weight: 700;
      letter-spacing: 0.02em;
    }

    .brand-sub {
      font-size: 0.9rem;
      color: var(--text-soft);
    }

    .back-link {
      font-size: 0.9rem;
      align-self: flex-start;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: #ffffffcc;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .back-link span.icon {
      font-size: 1rem;
    }

    h1 {
      font-size: 1.4rem;
      margin: 10px 0 4px;
    }

    .hero-copy {
      font-size: 0.95rem;
      color: var(--text-muted);
      max-width: 640px;
      line-height: 1.4;
    }

    .note-banner {
      margin-top: 6px;
      padding: 10px 12px;
      border-radius: 12px;
      background: var(--accent-soft);
      font-size: 0.85rem;
      color: var(--accent-dark);
    }

    .controls-box {
      margin-top: 20px;
      padding: 12px;
      border-radius: var(--radius-xl);
      background: #ffffffcc;
      border: 1px solid var(--border-subtle);
      display: grid;
      gap: 12px;
    }

    @media (min-width: 720px) {
      .controls-box {
        grid-template-columns: 1.2fr 1fr;
        align-items: center;
      }
    }

    .filters-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-width: 160px;
      flex: 1 1 160px;
    }

    .filter-label {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--text-soft);
    }

    select {
      padding: 7px 9px;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      font-size: 0.9rem;
      background: #ffffff;
      color: var(--text-main);
      min-height: 34px;
    }

    .secondary-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      justify-content: flex-start;
    }

    .toggle-label {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.85rem;
      color: var(--text-soft);
    }

    .toggle-label input {
      accent-color: var(--accent);
    }

    .chip-button {
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: #f5f7fb;
      padding: 6px 10px;
      font-size: 0.8rem;
      cursor: pointer;
    }

    .chip-button:hover {
      background: #e8eef7;
    }

    .status-bar {
      margin-top: 18px;
      font-size: 0.85rem;
      color: var(--text-soft);
      display: flex;
      justify-content: space-between;
      gap: 10px;
      align-items: baseline;
    }

    .status-bar strong {
      color: var(--text-main);
    }

    .schedule-grid {
      margin-top: 18px;
      display: grid;
      grid-template-columns: minmax(0, 1fr);
      gap: 14px;
    }

    @media (min-width: 880px) {
      .schedule-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    .class-card {
      background: #ffffff;
      border-radius: var(--radius-xl);
      border: 1px solid var(--border-subtle);
      padding: 14px 14px 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      box-shadow: 0 6px 18px rgba(15, 32, 54, 0.06);
    }

    .class-header {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .class-course {
      font-size: 0.95rem;
      font-weight: 600;
    }

    .class-date {
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    .class-location {
      font-size: 0.85rem;
      color: var(--text-soft);
    }

    .past-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      border-radius: 999px;
      background: var(--danger-soft);
      color: var(--danger);
      font-size: 0.75rem;
      margin-top: 2px;
    }

    .class-footer {
      margin-top: 6px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    @media (min-width: 520px) {
      .class-footer {
        flex-direction: row;
      }
    }

    .btn-primary,
    .btn-secondary {
      display: inline-flex;
      justify-content: center;
      align-items: center;
      text-align: center;
      flex: 1 1 auto;
      padding: 8px 10px;
      border-radius: 999px;
      font-size: 0.85rem;
      font-weight: 600;
      border: none;
      cursor: pointer;
    }

    .btn-primary {
      background: var(--accent);
      color: #ffffff;
    }

    .btn-primary:hover {
      background: var(--accent-dark);
      text-decoration: none;
    }

    .btn-secondary {
      background: #f5f7fb;
      color: var(--text-main);
      border: 1px solid var(--border-subtle);
    }

    .btn-secondary:hover {
      background: #e8eef7;
      text-decoration: none;
    }

    .empty-state {
      margin-top: 22px;
      padding: 14px 14px;
      border-radius: var(--radius-xl);
      background: #ffffffcc;
      border: 1px dashed var(--border-subtle);
      font-size: 0.9rem;
      color: var(--text-soft);
    }

    .empty-state strong {
      color: var(--text-main);
    }

    .footer-note {
      margin-top: 26px;
      font-size: 0.8rem;
      color: var(--text-soft);
    }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <div class="brand-block">
        <a class="back-link" href="https://910cpr.com">
          <span class="icon">←</span>
          <span>Back to 910CPR.com</span>
        </a>
        <div>
          <div class="brand-title">910CPR – Live CPR & Medical Training Schedule</div>
          <div class="brand-sub">
            Wilmington • Burgaw • Jacksonville • Southeastern North Carolina
          </div>
        </div>
      </div>
    </header>

    <main>
      <section>
        <h1>Pick your class, then tap once to register</h1>
        <p class="hero-copy">
          This page reads directly from your latest Enrollware export
          (<code>data/schedule.json</code>). Every refresh uses the newest JSON, so when the
          export is current, this schedule is current.
        </p>
        <div class="note-banner">
          Students land here → see real dates, times, and locations → tap one button to
          register. If a date is already in the past, the main button will change to
          “Registration closed – see other times”.
        </div>

        <div class="controls-box">
          <div class="filters-row">
            <div class="filter-group">
              <div class="filter-label">Filter by course</div>
              <select id="courseFilter">
                <option value="">All courses</option>
              </select>
            </div>
            <div class="filter-group">
              <div class="filter-label">Filter by area</div>
              <select id="locationFilter">
                <option value="">All locations</option>
              </select>
            </div>
          </div>
          <div class="secondary-controls">
            <label class="toggle-label">
              <input type="checkbox" id="hidePastToggle" checked>
              <span>Hide past classes</span>
            </label>
            <button type="button" id="clearFilters" class="chip-button">Clear filters</button>
          </div>
        </div>

        <div class="status-bar">
          <div id="scheduleStatus">Loading schedule…</div>
          <div id="generatedAt"></div>
        </div>

        <div id="classesContainer" class="schedule-grid"></div>
        <div id="emptyState" class="empty-state" style="display:none;">
          <strong>No classes match your filters.</strong> Try clearing filters or check back
          after the next <code>schedule.json</code> update from Enrollware.
        </div>

        <p class="footer-note">
          This page is powered by your Enrollware export → <code>schedule.json</code> →
          static HTML. If this page looks empty but you know you have classes, the problem
          is the JSON (or export), not the page.
        </p>
      </section>
    </main>
  </div>

  <script>
    const SCHEDULE_URL = "data/schedule.json";

    const courseFilterEl = document.getElementById("courseFilter");
    const locationFilterEl = document.getElementById("locationFilter");
    const hidePastToggleEl = document.getElementById("hidePastToggle");
    const clearFiltersEl = document.getElementById("clearFilters");
    const statusEl = document.getElementById("scheduleStatus");
    const generatedAtEl = document.getElementById("generatedAt");
    const classesContainerEl = document.getElementById("classesContainer");
    const emptyStateEl = document.getElementById("emptyState");

    let allSessions = [];
    let courseMap = new Map();
    let courseScheduleUrlMap = new Map();

    function parseStartDate(raw) {
      if (!raw) return null;
      if (raw.includes("Select a Program Below")) return null;
      if (raw.toLowerCase().includes("start your class today")) return null;
      try {
        const cleaned = raw.replace(/\s*\([^)]*\)\s*$/, "");
        const d = new Date(cleaned);
        if (isNaN(d.getTime())) return null;
        return d;
      } catch (e) {
        return null;
      }
    }

    function buildFilters() {
      const courseIdsWithSessions = new Set();
      const locations = new Set();

      for (const s of allSessions) {
        if (s.course_id != null) {
          courseIdsWithSessions.add(String(s.course_id));
        }
        if (s.location_short) {
          locations.add(s.location_short);
        }
      }

      courseFilterEl.innerHTML = "";
      const anyCourseOpt = document.createElement("option");
      anyCourseOpt.value = "";
      anyCourseOpt.textContent = "All courses";
      courseFilterEl.appendChild(anyCourseOpt);

      const sortedCourseIds = Array.from(courseIdsWithSessions).sort((a, b) => {
        const nameA = courseMap.get(Number(a)) || "";
        const nameB = courseMap.get(Number(b)) || "";
        return nameA.localeCompare(nameB);
      });

      for (const id of sortedCourseIds) {
        const opt = document.createElement("option");
        opt.value = id;
        opt.textContent = courseMap.get(Number(id)) || ("Course #" + id);
        courseFilterEl.appendChild(opt);
      }

      locationFilterEl.innerHTML = "";
      const anyLocationOpt = document.createElement("option");
      anyLocationOpt.value = "";
      anyLocationOpt.textContent = "All locations";
      locationFilterEl.appendChild(anyLocationOpt);

      const sortedLocations = Array.from(locations).sort((a, b) => a.localeCompare(b));
      for (const loc of sortedLocations) {
        const opt = document.createElement("option");
        opt.value = loc;
        opt.textContent = loc;
        locationFilterEl.appendChild(opt);
      }
    }

    function renderSchedule() {
      const selectedCourseId = courseFilterEl.value || "";
      const selectedLocation = locationFilterEl.value || "";
      const hidePast = hidePastToggleEl.checked;
      const now = new Date();

      let visibleCount = 0;
      classesContainerEl.innerHTML = "";

      for (const s of allSessions) {
        if (selectedCourseId && String(s.course_id) !== selectedCourseId) continue;
        if (selectedLocation && s.location_short !== selectedLocation) continue;

        const isPast = s._startDate && s._startDate < now;
        if (hidePast && isPast) continue;

        visibleCount++;

        const card = document.createElement("article");
        card.className = "class-card";

        const header = document.createElement("div");
        header.className = "class-header";

        const titleEl = document.createElement("div");
        titleEl.className = "class-course";
        const courseName = courseMap.get(Number(s.course_id)) || s.course_name || "CPR / First Aid";
        titleEl.textContent = courseName;

        const dateEl = document.createElement("div");
        dateEl.className = "class-date";
        dateEl.textContent = s.start_display || "Flexible dates – call for options";

        const locEl = document.createElement("div");
        locEl.className = "class-location";
        locEl.textContent = s.location_short || s.location || "Location to be arranged";

        header.appendChild(titleEl);
        header.appendChild(dateEl);
        header.appendChild(locEl);

        if (isPast) {
          const pastBadge = document.createElement("div");
          pastBadge.className = "past-badge";
          pastBadge.textContent = "Past date";
          header.appendChild(pastBadge);
        }

        card.appendChild(header);

        const footer = document.createElement("div");
        footer.className = "class-footer";

        const primaryLink = document.createElement("a");
        primaryLink.className = "btn-primary";
        primaryLink.href = s.register_url || "#";
        primaryLink.target = "_blank";
        primaryLink.rel = "noopener";

        primaryLink.textContent = isPast
          ? "Registration closed – see other times"
          : "Register for this class";

        footer.appendChild(primaryLink);

        const courseUrl = courseScheduleUrlMap.get(s.course_id) || s.register_url || null;
        if (courseUrl) {
          const secondaryLink = document.createElement("a");
          secondaryLink.className = "btn-secondary";
          secondaryLink.href = courseUrl;
          secondaryLink.target = "_blank";
          secondaryLink.rel = "noopener";
          secondaryLink.textContent = "See other times for this course";
          footer.appendChild(secondaryLink);
        }

        card.appendChild(footer);

        classesContainerEl.appendChild(card);
      }

      if (visibleCount === 0) {
        emptyStateEl.style.display = "block";
      } else {
        emptyStateEl.style.display = "none";
      }

      statusEl.textContent = visibleCount === 0
        ? "No matching classes found."
        : visibleCount + " class" + (visibleCount === 1 ? "" : "es") + " shown.";
    }

    async function initSchedule() {
      statusEl.textContent = "Loading schedule…";

      try {
        const res = await fetch(SCHEDULE_URL, { cache: "no-store" });
        if (!res.ok) {
          throw new Error("HTTP " + res.status);
        }
        const data = await res.json();

        courseMap = new Map();
        if (Array.isArray(data.courses)) {
          for (const c of data.courses) {
            if (c && typeof c.id === "number") {
              courseMap.set(c.id, c.name || ("Course #" + c.id));
            }
          }
        }

        const rawClasses =
          data.classes ||
          data.sessions ||
          data.items ||
          data.class_list ||
          [];

        allSessions = [];
        courseScheduleUrlMap = new Map();

        for (const item of rawClasses) {
          if (!item) continue;

          const courseId = item.course_id;

          if (!item.id) {
            if (courseId != null && item.register_url) {
              if (!courseScheduleUrlMap.has(courseId)) {
                courseScheduleUrlMap.set(courseId, item.register_url);
              }
            }
            continue;
          }

          const copy = Object.assign({}, item);
          copy._startDate = parseStartDate(copy.start_display);
          allSessions.push(copy);
        }

        if (allSessions.length === 0) {
          statusEl.textContent = "No classes found in schedule.json.";
          classesContainerEl.innerHTML = "";
          emptyStateEl.style.display = "block";
        } else {
          statusEl.textContent = allSessions.length + " total class"
            + (allSessions.length === 1 ? "" : "es") + " loaded.";
          emptyStateEl.style.display = "none";
        }

        if (data.generated_at) {
          const d = new Date(data.generated_at);
          if (!isNaN(d.getTime())) {
            generatedAtEl.textContent =
              "Last updated from Enrollware: " + d.toLocaleString();
          }
        }

        buildFilters();
        renderSchedule();
      } catch (err) {
        console.error("Error loading schedule.json", err);
        statusEl.textContent = "Error loading schedule.json – check the file path or JSON syntax.";
        classesContainerEl.innerHTML = "";
        emptyStateEl.style.display = "block";
      }
    }

    courseFilterEl.addEventListener("change", renderSchedule);
    locationFilterEl.addEventListener("change", renderSchedule);
    hidePastToggleEl.addEventListener("change", renderSchedule);

    clearFiltersEl.addEventListener("click", () => {
      courseFilterEl.value = "";
      locationFilterEl.value = "";
      hidePastToggleEl.checked = true;
      renderSchedule();
    });

    initSchedule();
  </script>
</body>
</html>
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>910CPR – Class Schedule</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <meta name="description" content="910CPR live CPR & medical training schedule. Browse by course family (BLS, ACLS, PALS, Heartsaver, HSI, Red Cross, USCG), then choose your course and class date.">

  <style>
    :root {
      --bg-top: #ffffff;
      --bg-bottom: #e9f4ff;
      --accent: #0b74d1;
      --accent-soft: #e0eefc;
      --accent-dark: #074a86;
      --border-subtle: #d0d7e2;
      --text-main: #122033;
      --text-muted: #5d6a7c;
      --text-soft: #7b8796;
      --danger: #b3261e;
      --danger-soft: #fdecec;
      --radius-xl: 18px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: var(--text-main);
      background: linear-gradient(to bottom, var(--bg-top), var(--bg-bottom));
      min-height: 100vh;
    }

    a {
      color: var(--accent-dark);
      text-decoration: none;
    }
    a:hover { text-decoration: underline; }

    .page {
      max-width: 1120px;
      margin: 0 auto;
      padding: 16px 16px 40px;
    }

    header {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 18px;
    }

    @media (min-width: 720px) {
      header {
        flex-direction: row;
        align-items: flex-start;
        justify-content: space-between;
      }
    }

    .brand-block {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .back-link {
      font-size: 0.9rem;
      align-self: flex-start;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: #ffffffcc;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .back-link span.icon { font-size: 1rem; }

    .brand-title {
      font-size: 1.5rem;
      font-weight: 700;
      letter-spacing: 0.02em;
    }

    .brand-sub {
      font-size: 0.9rem;
      color: var(--text-soft);
    }

    h1 {
      font-size: 1.3rem;
      margin: 10px 0 4px;
    }

    .hero-copy {
      font-size: 0.95rem;
      color: var(--text-muted);
      max-width: 640px;
      line-height: 1.4;
    }

    .note-banner {
      margin-top: 6px;
      padding: 10px 12px;
      border-radius: 12px;
      background: var(--accent-soft);
      font-size: 0.85rem;
      color: var(--accent-dark);
    }

    .controls-box {
      margin-top: 18px;
      padding: 10px 12px;
      border-radius: var(--radius-xl);
      background: #ffffffcc;
      border: 1px solid var(--border-subtle);
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
    }

    .toggle-label {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.85rem;
      color: var(--text-soft);
    }
    .toggle-label input { accent-color: var(--accent); }

    .status-bar {
      margin-top: 12px;
      font-size: 0.85rem;
      color: var(--text-soft);
      display: flex;
      justify-content: space-between;
      gap: 10px;
      align-items: baseline;
    }
    .status-bar strong { color: var(--text-main); }

    .families-root {
      margin-top: 16px;
    }

    details.family {
      margin-bottom: 10px;
      border-radius: var(--radius-xl);
      border: 1px solid var(--border-subtle);
      background: #ffffff;
      box-shadow: 0 6px 16px rgba(15,32,54,0.06);
    }

    details.family > summary {
      list-style: none;
      cursor: pointer;
      padding: 10px 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    details.family > summary::-webkit-details-marker { display: none; }

    .family-title {
      font-size: 0.95rem;
      font-weight: 600;
    }

    .family-sub {
      font-size: 0.8rem;
      color: var(--text-soft);
    }

    .family-count {
      font-size: 0.8rem;
      color: var(--text-soft);
    }

    .family-inner {
      padding: 8px 12px 10px;
      border-top: 1px solid var(--border-subtle);
    }

    details.course {
      margin-bottom: 6px;
      border-radius: 12px;
      border: 1px solid #e0e5f0;
      background: #f9fbff;
    }

    details.course > summary {
      list-style: none;
      cursor: pointer;
      padding: 7px 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
      font-size: 0.9rem;
    }
    details.course > summary::-webkit-details-marker { display: none; }

    .course-name {
      font-weight: 500;
    }

    .course-count {
      font-size: 0.8rem;
      color: var(--text-soft);
    }

    .course-inner {
      padding: 8px 10px 9px;
      border-top: 1px solid #e0e5f0;
    }

    .session-row {
      display: grid;
      grid-template-columns: minmax(0, 1.6fr) minmax(0, 1.4fr);
      gap: 6px;
      align-items: center;
      padding: 6px 4px;
      font-size: 0.86rem;
    }

    @media (max-width: 640px) {
      .session-row {
        grid-template-columns: minmax(0,1fr);
        align-items: flex-start;
      }
    }

    .session-meta {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .session-date { color: var(--text-main); }
    .session-loc  { color: var(--text-soft); font-size: 0.82rem; }

    .past-chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      border-radius: 999px;
      background: var(--danger-soft);
      color: var(--danger);
      font-size: 0.75rem;
      margin-top: 2px;
    }

    .session-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      justify-content: flex-end;
    }

    .btn {
      display: inline-flex;
      justify-content: center;
      align-items: center;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 0.8rem;
      font-weight: 600;
      border: none;
      cursor: pointer;
      text-decoration: none;
    }

    .btn-primary {
      background: var(--accent);
      color: #ffffff;
    }
    .btn-primary:hover { background: var(--accent-dark); text-decoration: none; }

    .btn-secondary {
      background: #f5f7fb;
      color: var(--text-main);
      border: 1px solid var(--border-subtle);
    }
    .btn-secondary:hover { background: #e8eef7; text-decoration: none; }

    .course-footer-link {
      margin-top: 6px;
      font-size: 0.8rem;
      color: var(--text-soft);
    }

    .empty-state {
      margin-top: 18px;
      padding: 12px 14px;
      border-radius: var(--radius-xl);
      background: #ffffffcc;
      border: 1px dashed var(--border-subtle);
      font-size: 0.9rem;
      color: var(--text-soft);
    }
    .empty-state strong { color: var(--text-main); }

    .footer-note {
      margin-top: 24px;
      font-size: 0.8rem;
      color: var(--text-soft);
    }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <div class="brand-block">
        <a class="back-link" href="https://910cpr.com">
          <span class="icon">←</span>
          <span>Back to 910CPR.com</span>
        </a>
        <div>
          <div class="brand-title">910CPR – Live CPR & Medical Training Schedule</div>
          <div class="brand-sub">
            Grouped by course family → course → class date/time.
          </div>
        </div>
      </div>
    </header>

    <main>
      <section>
        <h1>Pick a course family, then open your course and class time</h1>
        <p class="hero-copy">
          This schedule reads directly from <code>data/schedule.json</code> built from your Enrollware export.
          Families match how your brain already sorts things: BLS, ACLS, PALS, Heartsaver, HSI, Red Cross, USCG, and more.
        </p>
        <div class="note-banner">
          Open a FAMILY → choose a COURSE → then open a DATE/TIME. Future classes show
          “Register for this class.” Past dates flip to “Registration closed – see other times.”
        </div>

        <div class="controls-box">
          <label class="toggle-label">
            <input type="checkbox" id="hidePastToggle" checked>
            <span>Hide past class dates</span>
          </label>
          <div id="generatedAt"></div>
        </div>

        <div class="status-bar">
          <div id="scheduleStatus">Loading schedule…</div>
          <div></div>
        </div>

        <div id="familiesRoot" class="families-root"></div>

        <div id="emptyState" class="empty-state" style="display:none;">
          <strong>No class dates match the current view.</strong>
          If you know there are classes available, check that <code>schedule.json</code>
          has current sessions and that “Hide past dates” isn’t removing them.
        </div>

        <p class="footer-note">
          This page is powered by your Enrollware export → <code>schedule.json</code> →
          static HTML. If families show up but there are no dates, the export/JSON is the
          place to look, not this page.
        </p>
      </section>
    </main>
  </div>

  <script>
    const SCHEDULE_URL = "data/schedule.json";

    const hidePastToggleEl = document.getElementById("hidePastToggle");
    const generatedAtEl = document.getElementById("generatedAt");
    const statusEl = document.getElementById("scheduleStatus");
    const familiesRootEl = document.getElementById("familiesRoot");
    const emptyStateEl = document.getElementById("emptyState");

    let allSessions = [];
    let courseMap = new Map();          // course_id -> course name
    let courseScheduleUrlMap = new Map(); // course_id -> “see other times” URL

    function parseStartDate(raw) {
      if (!raw) return null;
      const lower = raw.toLowerCase();
      if (lower.includes("select a program below")) return null;
      if (lower.includes("start your class today")) return null;
      try {
        const cleaned = raw.replace(/\s*\([^)]*\)\s*$/, "");
        const d = new Date(cleaned);
        if (isNaN(d.getTime())) return null;
        return d;
      } catch (e) {
        return null;
      }
    }

    function inferFamilyName(courseName) {
      if (!courseName) return "Other Courses";
      const n = courseName.toLowerCase();

      if (n.includes("bls")) return "BLS & Healthcare Provider CPR";
      if (n.includes("acls")) return "ACLS – Advanced Cardiac Life Support";
      if (n.includes("pals")) return "PALS – Pediatric Advanced Life Support";
      if (n.includes("heartsaver")) return "AHA Heartsaver CPR, AED & First Aid";
      if (n.includes("hsi")) return "HSI CPR & First Aid";
      if (n.includes("red cross") || n.includes("arc")) return "Red Cross CPR & BLS";
      if (n.includes("uscg") || n.includes("coast guard") || n.includes("mariner") || n.includes("elementary first aid"))
        return "USCG / Maritime Courses";

      return "Other Courses";
    }

    // Sort families in a human order
    const FAMILY_ORDER = [
      "BLS & Healthcare Provider CPR",
      "ACLS – Advanced Cardiac Life Support",
      "PALS – Pediatric Advanced Life Support",
      "AHA Heartsaver CPR, AED & First Aid",
      "HSI CPR & First Aid",
      "Red Cross CPR & BLS",
      "USCG / Maritime Courses",
      "Other Courses"
    ];

    function sortFamilies(families) {
      return families.sort((a, b) => {
        const idxA = FAMILY_ORDER.indexOf(a);
        const idxB = FAMILY_ORDER.indexOf(b);
        if (idxA === -1 && idxB === -1) return a.localeCompare(b);
        if (idxA === -1) return 1;
        if (idxB === -1) return -1;
        return idxA - idxB;
      });
    }

    function buildTree(hidePast) {
      const now = new Date();
      const families = {}; // { familyName: { courseId: { name, sessions[] } } }

      for (const s of allSessions) {
        if (!s.course_id) continue;
        const isPast = s._startDate && s._startDate < now;
        if (hidePast && isPast) continue;

        const courseId = s.course_id;
        const courseName = courseMap.get(courseId) || s.course_name || "CPR / First Aid";

        const familyName = inferFamilyName(courseName);
        if (!families[familyName]) {
          families[familyName] = {};
        }
        if (!families[familyName][courseId]) {
          families[familyName][courseId] = {
            name: courseName,
            sessions: []
          };
        }
        families[familyName][courseId].sessions.push(s);
      }

      // Sort sessions in each course by date
      Object.values(families).forEach(courseGroup => {
        Object.values(courseGroup).forEach(course => {
          course.sessions.sort((a, b) => {
            if (!a._startDate && !b._startDate) return 0;
            if (!a._startDate) return 1;
            if (!b._startDate) return -1;
            return a._startDate - b._startDate;
          });
        });
      });

      return families;
    }

    function renderSchedule() {
      const hidePast = hidePastToggleEl.checked;
      const tree = buildTree(hidePast);

      familiesRootEl.innerHTML = "";
      let totalVisibleSessions = 0;

      const familyNames = sortFamilies(Object.keys(tree));
      if (familyNames.length === 0) {
        emptyStateEl.style.display = "block";
        statusEl.textContent = "No class dates found for the current view.";
        return;
      } else {
        emptyStateEl.style.display = "none";
      }

      familyNames.forEach(familyName => {
        const courses = tree[familyName];
        const courseIds = Object.keys(courses);
        if (courseIds.length === 0) return;

        let familySessionCount = 0;
        courseIds.forEach(cid => {
          familySessionCount += courses[cid].sessions.length;
        });
        if (familySessionCount === 0) return;

        totalVisibleSessions += familySessionCount;

        const familyDetails = document.createElement("details");
        familyDetails.className = "family";

        const familySummary = document.createElement("summary");
        const titleBox = document.createElement("div");
        const title = document.createElement("div");
        title.className = "family-title";
        title.textContent = familyName;
        const sub = document.createElement("div");
        sub.className = "family-sub";
        sub.textContent = courseIds.length + " course" + (courseIds.length === 1 ? "" : "s");
        titleBox.appendChild(title);
        titleBox.appendChild(sub);

        const count = document.createElement("div");
        count.className = "family-count";
        count.textContent = familySessionCount + " date" + (familySessionCount === 1 ? "" : "s");

        familySummary.appendChild(titleBox);
        familySummary.appendChild(count);
        familyDetails.appendChild(familySummary);

        const familyInner = document.createElement("div");
        familyInner.className = "family-inner";

        courseIds
          .sort((a, b) => courses[a].name.localeCompare(courses[b].name))
          .forEach(cid => {
            const course = courses[cid];
            if (!course.sessions || course.sessions.length === 0) return;

            const courseDetails = document.createElement("details");
            courseDetails.className = "course";

            const courseSummary = document.createElement("summary");
            const cName = document.createElement("div");
            cName.className = "course-name";
            cName.textContent = course.name;
            const cCount = document.createElement("div");
            cCount.className = "course-count";
            cCount.textContent = course.sessions.length + " date" + (course.sessions.length === 1 ? "" : "s");
            courseSummary.appendChild(cName);
            courseSummary.appendChild(cCount);

            courseDetails.appendChild(courseSummary);

            const courseInner = document.createElement("div");
            courseInner.className = "course-inner";

            course.sessions.forEach(s => {
              const isPast = s._startDate && s._startDate < new Date();

              const row = document.createElement("div");
              row.className = "session-row";

              const meta = document.createElement("div");
              meta.className = "session-meta";

              const dateEl = document.createElement("div");
              dateEl.className = "session-date";
              dateEl.textContent = s.start_display || "Flexible dates – call for options";

              const locEl = document.createElement("div");
              locEl.className = "session-loc";
              locEl.textContent = s.location_short || s.location || "Location to be arranged";

              meta.appendChild(dateEl);
              meta.appendChild(locEl);

              if (isPast) {
                const pastChip = document.createElement("div");
                pastChip.className = "past-chip";
                pastChip.textContent = "Past date";
                meta.appendChild(pastChip);
              }

              const actions = document.createElement("div");
              actions.className = "session-actions";

              const mainBtn = document.createElement("a");
              mainBtn.className = "btn btn-primary";
              mainBtn.target = "_blank";
              mainBtn.rel = "noopener";

              const courseUrl = courseScheduleUrlMap.get(s.course_id) || s.register_url || "#";

              if (isPast) {
                mainBtn.textContent = "Registration closed – see other times";
                mainBtn.href = courseUrl;
              } else {
                mainBtn.textContent = "Register for this class";
                mainBtn.href = s.register_url || courseUrl || "#";
              }

              actions.appendChild(mainBtn);

              row.appendChild(meta);
              row.appendChild(actions);
              courseInner.appendChild(row);
            });

            const courseUrl = courseScheduleUrlMap.get(Number(cid));
            if (courseUrl) {
              const footerLink = document.createElement("div");
              footerLink.className = "course-footer-link";
              const link = document.createElement("a");
              link.href = courseUrl;
              link.target = "_blank";
              link.rel = "noopener";
              link.textContent = "See full schedule for this course on Enrollware →";
              footerLink.appendChild(link);
              courseInner.appendChild(footerLink);
            }

            courseDetails.appendChild(courseInner);
            familyInner.appendChild(courseDetails);
          });

        familyDetails.appendChild(familyInner);
        familiesRootEl.appendChild(familyDetails);
      });

      if (totalVisibleSessions === 0) {
        emptyStateEl.style.display = "block";
        statusEl.textContent = "No class dates found for the current view.";
      } else {
        emptyStateEl.style.display = "none";
        statusEl.textContent =
          totalVisibleSessions + " class date" + (totalVisibleSessions === 1 ? "" : "s") + " shown.";
      }
    }

    async function initSchedule() {
      statusEl.textContent = "Loading schedule…";

      try {
        const res = await fetch(SCHEDULE_URL, { cache: "no-store" });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();

        courseMap = new Map();
        if (Array.isArray(data.courses)) {
          for (const c of data.courses) {
            if (c && typeof c.id === "number") {
              courseMap.set(c.id, c.name || ("Course #" + c.id));
            }
          }
        }

        const rawClasses =
          data.classes ||
          data.sessions ||
          data.items ||
          data.class_list ||
          [];

        allSessions = [];
        courseScheduleUrlMap = new Map();

        for (const item of rawClasses) {
          if (!item) continue;
          const courseId = item.course_id;

          if (!item.id) {
            if (courseId != null && item.register_url) {
              if (!courseScheduleUrlMap.has(courseId)) {
                courseScheduleUrlMap.set(courseId, item.register_url);
              }
            }
            continue;
          }

          const copy = Object.assign({}, item);
          copy._startDate = parseStartDate(copy.start_display);
          allSessions.push(copy);
        }

        if (data.generated_at) {
          const d = new Date(data.generated_at);
          if (!isNaN(d.getTime())) {
            generatedAtEl.textContent =
              "Last Enrollware export: " + d.toLocaleString();
          }
        }

        if (allSessions.length === 0) {
          statusEl.textContent = "No classes found in schedule.json.";
          emptyStateEl.style.display = "block";
          familiesRootEl.innerHTML = "";
          return;
        }

        renderSchedule();
      } catch (err) {
        console.error("Error loading schedule.json", err);
        statusEl.textContent = "Error loading schedule.json – check file path or JSON syntax.";
        emptyStateEl.style.display = "block";
        familiesRootEl.innerHTML = "";
      }
    }

    hidePastToggleEl.addEventListener("change", renderSchedule);

    initSchedule();
  </script>
</body>
</html>
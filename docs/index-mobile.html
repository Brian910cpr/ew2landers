<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>910CPR — Schedule (Mobile)</title>
  <meta name="description" content="Mobile schedule: live & blended CPR, BLS, ACLS, PALS & First Aid classes with fast certificates — powered by 910CPR." />
  <style>
    :root{
      --bg1:#ffffff;
      --bg2:#f0f6ff;
      --ink:#0d1b2a;
      --muted:#5b6b7a;
      --line:#d7e3f0;
      --brand:#0b5fa5;
      --brand2:#084a7f;
      --shadow: 0 10px 30px rgba(10,40,80,.12);
      --radius:16px;
      --headerH: 64px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--ink);
      background: linear-gradient(180deg, var(--bg1), var(--bg2));
    }

    .bg-center{
      position: fixed;
      inset: 0;
      pointer-events:none;
      z-index: 0;
      opacity:.08;
      background: url("./assets/images/910CPR_wave.jpg") center 120px / 900px no-repeat;
    }
    .corner{
      position: fixed;
      right: 12px;
      bottom: 12px;
      width: 70px;
      height: 70px;
      opacity: .9;
      pointer-events:none;
      z-index: 0;
      background: url("./assets/images/theme/default-corner.png") bottom right / contain no-repeat;
    }
    .top{
      position: sticky;
      top:0;
      z-index: 50;
      height: var(--headerH);
      background: rgba(255,255,255,.92);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--line);
    }
    .top-inner{
      height:100%;
      padding: 10px 12px;
      display:flex;
      align-items:center;
      gap: 10px;
    }
    .logo{
      width: 26px;
      height: 26px;
      border-radius: 6px;
      object-fit: cover;
    }
    .title{
      font-weight: 900;
      font-size: 14px;
      line-height: 1.1;
    }
    .sub{
      font-size: 11px;
      color: var(--muted);
      line-height: 1.1;
      margin-top: 2px;
    }
    .spacer{flex:1}
    .btn{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: #fff;
      color: var(--ink);
      text-decoration:none;
      font-weight: 900;
      font-size: 12px;
      box-shadow: 0 6px 18px rgba(20,60,120,.10);
      white-space: nowrap;
    }
    .btn.primary{
      background: var(--brand);
      color:#fff;
      border-color: transparent;
    }
    .btn img{width:16px;height:16px;object-fit:contain}
    .main{
      position:relative;
      z-index: 2;
      padding: 14px 12px 56px;
      max-width: 720px;
      margin: 0 auto;
    }
    .panel{
      background: rgba(255,255,255,.92);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 12px;
    }
    .h{
      font-weight: 900;
      font-size: 13px;
      margin: 0 0 6px;
    }
    .hint{
      margin:0;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.35;
    }
    .notice{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      background: #f3f8ff;
      border: 1px dashed #c6dcf6;
      color: #315a86;
      font-size: 13px;
    }

    .search{
      margin-top: 10px;
      width:100%;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid var(--line);
      outline:none;
      font-size: 14px;
      background: #fff;
    }
    .cards{
      margin-top: 12px;
      display:flex;
      flex-direction: column;
      gap: 12px;
    }

    .course{
      border-radius: 18px;
      border: 1px solid var(--line);
      overflow:hidden;
      background:#fff;
      box-shadow: 0 10px 26px rgba(10,40,80,.10);
    }
    .head{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      padding: 12px 12px;
      background: linear-gradient(90deg, #0b4f86, #0b5fa5);
      color:#fff;
    }
    .head .twrap{
      min-width:0;
      flex:1;
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .head .t{
      font-weight: 900;
      font-size: 14px;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      line-height: 1.2;
    }
    .head .s{
      font-size: 12px;
      opacity:.85;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      line-height: 1.2;
    }
    .actions{
      display:flex;
      align-items:center;
      gap: 8px;
      flex-shrink:0;
    }
    .pillBtn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.25);
      background: rgba(255,255,255,.12);
      color:#fff;
      cursor:pointer;
      font-weight: 900;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: .4px;
      white-space: nowrap;
    }
    .pillBtn:hover{background: rgba(255,255,255,.20)}
    .pillLink{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.25);
      background: rgba(255,255,255,.12);
      color:#fff;
      font-weight: 900;
      font-size: 12px;
      text-decoration:none;
      text-transform: uppercase;
      letter-spacing: .4px;
      white-space: nowrap;
    }
    .pillLink:hover{background: rgba(255,255,255,.20)}

    .courseBody{
      display:none;
      padding: 12px 12px 14px;
      background: #fff;
    }
    .sessions{
      display:flex;
      flex-direction: column;
      gap: 10px;
    }
    .session{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: #fff;
    }
    .when{
      min-width:0;
      flex:1;
      display:flex;
      flex-direction: column;
      gap: 2px;
    }
    .when strong{font-size: 13px;}
    .when small{
      color: var(--muted);
      font-size: 12px;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .reg{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding: 10px 14px;
      border-radius: 999px;
      border: 0;
      background: #0b7a4a;
      color: #fff;
      font-weight: 900;
      cursor:pointer;
      text-decoration:none;
      white-space: nowrap;
    }
    .reg:hover{filter:brightness(.95)}
    .moreBtn{background:#0b5fa5}
    .moreRow{background:#f7fbff}

    .menuRow{
      display:flex;
      gap: 8px;
      overflow-x:auto;
      padding: 10px 0 4px;
      scrollbar-width: none;
    }
    .menuRow::-webkit-scrollbar{display:none}
  </style>
</head>

<body>
  <div class="bg-center"></div>
  <div class="corner"></div>

  <header class="top">
    <div class="top-inner">
      <img class="logo" src="./assets/images/910CPR_wave.jpg" alt="910CPR">
      <div style="min-width:0">
        <div class="title">910CPR — Schedule</div>
        <div class="sub">Live &amp; blended classes with fast certificates</div>
      </div>
      <div class="spacer"></div>
      <a class="btn" href="./index.html">Desktop</a>
    </div>
  </header>

  <main class="main">
    <div class="menuRow">
      <a class="btn" href="./onsite.html"><img src="./assets/images/classroom_icon.png" alt="">Group Class Quote / Inquiry</a>
      <a class="btn primary" href="tel:+19103955193"><img src="./assets/images/phone_icon.png" alt="">Call / Text</a>
      <a class="btn" href="mailto:info@910cpr.com"><img src="./assets/images/email_icon.png" alt="">Email help</a>
    </div>

    <section class="panel">
      <div class="h">Filter</div>
      <p class="hint">Only upcoming sessions are shown. Courses are collapsed by default — expand the one you want.</p>
      <input id="search" class="search" placeholder="Search within titles (BLS, ACLS, Heartsaver…)" />
    </section>

    <div id="status" class="notice">Loading schedule…</div>
    <div id="cards" class="cards"></div>
  </main>

  <!-- AI Frontdesk embed -->
  <embeddable-voice id="1cf9bf8f-38da-437e-abfb-efa1ce9a02ff"></embeddable-voice>
  <script src="https://cdn.247aireceptionist.com/script.js"></script>

  <script>
    const SCHEDULE_JSON_URL = "./data/schedule.json";

    // Per-course paging: start with 10, then add +10 each time you click "See more times…"
    const VISIBLE_LIMIT = new Map(); // courseKey -> number
    function getLimit(key, total){
      const cur = VISIBLE_LIMIT.get(String(key));
      const base = Math.min(10, total);
      return Math.min(cur ?? base, total);
    }
    function bumpLimit(key, total){
      const next = Math.min(getLimit(key, total) + 10, total);
      VISIBLE_LIMIT.set(String(key), next);
      return next;
    }

    const elSearch = document.getElementById("search");
    const elStatus = document.getElementById("status");
    const elCards  = document.getElementById("cards");

    let GROUPS = [];
    let QUERY = "";

    function withCacheBust(url){
      const u = new URL(url, window.location.href);
      u.searchParams.set("_", String(Date.now()));
      return u.toString();
    }

    async function loadJson(url){
      const res = await fetch(withCacheBust(url), { cache:"no-store" });
      if (!res.ok) throw new Error(`Failed to load ${url} (${res.status})`);
      return await res.json();
    }

    function stripToText(input){
      const s = String(input ?? "");
      if (!/[<>]/.test(s)) return s.trim();
      const tmp = document.createElement("div");
      tmp.innerHTML = s;
      return (tmp.textContent || "").replace(/\s+/g," ").trim();
    }

    function pickCourseKey(row){
      const v = row.ct_id || row.ctId || row.courseTypeId || row.course_type_id || row.courseTypeID || row.courseType ||
                row.course_id || row.courseId || row.courseID || row.course ||
                row.course_slug || row.courseSlug || row.course_url || row.courseUrl ||
                row.schedule_url || row.scheduleUrl || row.title || row.course_name || row.courseName || "unknown";
      return String(v);
    }
    function pickCourseTitle(row){
      return row.title || row.course_name || row.courseName || row.course_title || row.courseTitle || "Course";
    }
    function pickCourseSubtitle(row){
      return row.subtitle || row.course_subtitle || row.courseSubtitle || row.course_tagline || "";
    }
    function pickLocation(row){
      return row.location || row.location_name || row.locationName || row.city_state ||
             row.cityState || row.site || row.address || "Location TBD";
    }
    function pickRegisterUrl(row){
      return row.register_url || row.registerUrl || row.enroll_url || row.enrollUrl ||
             row.url || row.enroll || row.link || "";
    }
    function pickScheduleUrl(row){
      return row.schedule_url || row.scheduleUrl || row.course_url || row.courseUrl || "";
    }

    function toMillis(row){
      const dt = row.datetime || row.date_time || row.dateTime || row.start || row.start_time || row.startTime || row.when || row.date || "";
      if (!dt) return null;
      const s = String(dt).replace(" at ", " ").trim();
      const d = new Date(s);
      if (!isNaN(d.getTime())) return d.getTime();
      const d2 = new Date(String(dt));
      return isNaN(d2.getTime()) ? null : d2.getTime();
    }

    function fmtWhen(ms){
      const d = new Date(ms);
      const opts = { weekday:"long", month:"long", day:"numeric", year:"numeric", hour:"numeric", minute:"2-digit" };
      return d.toLocaleString(undefined, opts);
    }

    function isUpcoming(row, nowMs){
      if (typeof row?.is_past === "boolean") return !row.is_past;
      const ms = toMillis(row);
      return ms != null && ms >= nowMs;
    }

    function buildGroups(rows){
      const now = Date.now();
      const map = new Map();

      for (const r of (rows || [])){
        if (!isUpcoming(r, now)) continue;

        const key = String(pickCourseKey(r));
        const title = stripToText(pickCourseTitle(r));

        if (!map.has(key)){
          map.set(key, {
            key,
            title,
            subtitle: stripToText(pickCourseSubtitle(r)),
            scheduleUrl: pickScheduleUrl(r),
            sessions: []
          });
        }
        map.get(key).sessions.push(r);
      }

      const list = Array.from(map.values());
      for (const g of list){
        g.sessions.sort((a,b)=>(toMillis(a) ?? 9e15) - (toMillis(b) ?? 9e15));
        g.nextMs = toMillis(g.sessions[0]) ?? 9e15;
      }
      list.sort((a,b)=>a.nextMs - b.nextMs);
      return list;
    }

    function setCollapsed(btn, collapsed){
      btn.dataset.collapsed = collapsed ? "true" : "false";
      btn.setAttribute("aria-expanded", collapsed ? "false" : "true");
      btn.textContent = collapsed ? "SHOW 10" : "HIDE";
    }

    function closeAllExcept(key){
      const buttons = document.querySelectorAll("button.pillBtn[data-key]");
      const bodies = document.querySelectorAll(".courseBody[data-key]");
      buttons.forEach(btn=>{
        if (btn.dataset.key !== key) setCollapsed(btn, true);
      });
      bodies.forEach(b=>{
        if (b.dataset.key !== key) b.style.display = "none";
      });
    }

    function render(){
      const q = QUERY.trim().toLowerCase();

      const groups = GROUPS.filter(g=>{
        if (!q) return true;
        const blob = `${g.title} ${g.subtitle}`.toLowerCase();
        return blob.includes(q);
      });

      elCards.innerHTML = "";

      if (!groups.length){
        elStatus.textContent = "No matching courses found.";
        return;
      }

      elStatus.textContent = `Showing ${groups.length} course(s).`;

      for (const g of groups){
        const card = document.createElement("article");
        card.className = "course";

        const head = document.createElement("div");
        head.className = "head";

        const left = document.createElement("div");
        left.className = "twrap";
        left.innerHTML = `
          <div class="t">${g.title}</div>
          <div class="s">${g.subtitle || ""}</div>
        `;

        const actions = document.createElement("div");
        actions.className = "actions";

        const toggle = document.createElement("button");
        toggle.type = "button";
        toggle.className = "pillBtn";
        toggle.dataset.key = String(g.key);
        toggle.dataset.collapsed = "true";
        toggle.setAttribute("aria-expanded","false");
        toggle.textContent = "SHOW 10";

        const more = document.createElement("a");
        more.className = "pillLink";
        more.textContent = "See all dates";
        more.href = g.scheduleUrl || "#";
        more.target = "_blank";
        more.rel = "noopener";
        if (!g.scheduleUrl) more.style.display = "none";

        actions.appendChild(toggle);
        actions.appendChild(more);

        head.appendChild(left);
        head.appendChild(actions);

        // Click the blue header to expand/collapse (don’t require hunting the SHOW button)
        head.style.cursor = "pointer";
        head.addEventListener("click", (ev) => {
          if (ev.target.closest("button,a")) return;
          toggle.click();
        });

        const body = document.createElement("div");
        body.className = "courseBody";
        body.dataset.key = String(g.key);

        const sessions = document.createElement("div");
        sessions.className = "sessions";
        sessions.dataset.key = String(g.key);

        const __limit = getLimit(g.key, g.sessions.length);

        for (const r of g.sessions.slice(0,__limit)){
          const ms = toMillis(r);
          const when = ms ? fmtWhen(ms) : "Date/time";
          const where = pickLocation(r);
          const regUrl = pickRegisterUrl(r);

          const row = document.createElement("div");
          row.className = "session";
          row.innerHTML = `
            <div class="when">
              <strong>${when}</strong>
              <small>${where}</small>
            </div>
          `;

          const a = document.createElement("a");
          a.className = "reg";
          a.textContent = "Register";
          a.href = regUrl || (g.scheduleUrl || "#");
          a.target = "_blank";
          a.rel = "noopener";
          row.appendChild(a);

          sessions.appendChild(row);
        }

        // Bottom pager: show next 10 without leaving the page
        if (g.sessions.length > __limit){
          const moreRow = document.createElement("div");
          moreRow.className = "session moreRow";
          moreRow.innerHTML = `<div class="when"><strong>See more times…</strong><small>Show the next ${Math.min(10, g.sessions.length-__limit)} session(s)</small></div>`;
          const moreBtn = document.createElement("button");
          moreBtn.type = "button";
          moreBtn.className = "reg moreBtn";
          moreBtn.textContent = `Show next ${Math.min(10, g.sessions.length-__limit)}`;
          moreBtn.addEventListener("click", (ev) => {
            ev.preventDefault();
            ev.stopPropagation();
            bumpLimit(g.key, g.sessions.length);
            render();
            // keep this course open
            const btn = document.querySelector(`button.pillBtn[data-key="${String(g.key)}"]`);
            const sess = document.querySelector(`.sessions[data-key="${String(g.key)}"]`);
            const body2 = document.querySelector(`.courseBody[data-key="${String(g.key)}"]`);
            if (btn && sess && body2){
              body2.style.display = "block";
              btn.textContent = "HIDE";
              btn.dataset.collapsed = "false";
              btn.setAttribute("aria-expanded","true");
            }
          });
          moreRow.appendChild(moreBtn);
          sessions.appendChild(moreRow);
        }

        body.appendChild(sessions);

        toggle.addEventListener("click", (ev)=>{
          ev.preventDefault();
          ev.stopPropagation();
          const collapsed = toggle.dataset.collapsed === "true";
          closeAllExcept(String(g.key));
          if (collapsed){
            body.style.display = "block";
            setCollapsed(toggle, false);
          } else {
            body.style.display = "none";
            setCollapsed(toggle, true);
          }
        });

        card.appendChild(head);
        card.appendChild(body);
        elCards.appendChild(card);
      }
    }

    async function boot(){
      try{
        const rows = await loadJson(SCHEDULE_JSON_URL);
        GROUPS = buildGroups(rows);

        elStatus.textContent = `Loaded ${GROUPS.length} course(s).`;
        render();
      }catch(err){
        console.error(err);
        elStatus.textContent = "Could not load schedule. Please use the Enrollware backup scheduler.";
        elCards.innerHTML = `<div class="notice">
          Backup schedule: <a href="https://coastalcprtraining.enrollware.com/schedule" target="_blank" rel="noopener">https://coastalcprtraining.enrollware.com/schedule</a>
        </div>`;
      }
    }

    elSearch.addEventListener("input", ()=>{
      QUERY = elSearch.value || "";
      render();
    });

    boot();
  </script>
</body>
</html>
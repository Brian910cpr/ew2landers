<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>910CPR ‚Äî Schedule (Mobile)</title>
  <meta name="description" content="Mobile schedule ‚Äî powered by 910CPR" />

  <style>
    :root{
      --bg1:#ffffff;
      --bg2:#eaf4ff;
      --ink:#0b1b2b;
      --muted:#5b6a79;
      --card:#ffffff;
      --line:#e3e8ef;
      --shadow: 0 10px 30px rgba(0,0,0,.08);
      --radius2:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--ink);
      background: linear-gradient(180deg,var(--bg1),var(--bg2));
    }
    a{color:inherit}

    .topbar{
      position:sticky; top:0; z-index:10;
      background: linear-gradient(90deg,#0a1a2b,#102b4a);
      color:#fff;
      padding:12px 14px;
      display:flex;
      flex-direction:column;
      gap:10px;
      box-shadow: 0 6px 18px rgba(0,0,0,.2);
    }
    .row1{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      min-width:0;
    }
    .logoDot{
      width:16px;height:16px;border-radius:6px;background:#fff;
      flex:0 0 auto;
    }
    .brandText{min-width:0}
    .brandText .t{
      font-weight:950;
      font-size:13px;
      line-height:1.15;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 68vw;
    }
    .brandText .s{
      font-size:11px;
      opacity:.85;
      margin-top:2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 78vw;
    }
    .chipRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .chip{
      display:inline-flex; align-items:center; justify-content:center;
      padding:9px 12px;
      border-radius:999px;
      background: rgba(255,255,255,.12);
      border: 1px solid rgba(255,255,255,.18);
      text-decoration:none;
      font-weight:850;
      font-size:12px;
      white-space:nowrap;
    }

    .wrap{
      max-width: 760px;
      margin: 12px auto 50px;
      padding: 0 12px;
    }

    .panel{
      background: var(--card);
      border:1px solid var(--line);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      overflow:hidden;
      margin-bottom: 12px;
    }
    .panelHeader{
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg,#ffffff,#f7fbff);
    }
    .panelHeader .title{
      margin:0;
      font-weight:950;
      font-size:14px;
    }
    .panelHeader .hint{
      margin:6px 0 0;
      font-size:12px;
      color:var(--muted);
      line-height:1.35;
    }

    .filters{
      padding: 12px 14px 14px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .filters input, .filters select{
      width:100%;
      padding: 11px 12px;
      border-radius: 12px;
      border: 1px solid var(--line);
      outline:none;
      font-size:13px;
      background:#fff;
    }

    .notice{
      padding: 10px 14px;
      border:1px dashed #c9d8ea;
      background:#f7fbff;
      color:#18314a;
      border-radius: 14px;
      font-size:12px;
      line-height:1.4;
      margin: 12px 0;
    }
    .error{
      padding: 12px 14px;
      border-radius: 14px;
      border:1px solid #ffd2c1;
      background:#fff5f1;
      color:#5b1f0b;
      line-height:1.35;
      font-size:13px;
      margin: 14px 0;
    }

    .courseCard{
      border:1px solid var(--line);
      border-radius: var(--radius2);
      overflow:hidden;
      background:#fff;
      box-shadow: 0 10px 24px rgba(0,0,0,.06);
      margin: 12px 0 16px;
    }
    .courseTop{
      padding: 12px 14px;
      background: linear-gradient(90deg,#0b4f92,#0b6aa6);
      color:#fff;
    }
    .courseTop h3{
      margin:0;
      font-size:14px;
      line-height:1.2;
      font-weight:950;
      letter-spacing:.2px;
    }
    .courseTop .desc{
      margin:6px 0 0;
      font-size:12px;
      opacity:.92;
      line-height:1.25;
    }
    .courseTop img{
      height: 20px;
      width: auto;
      vertical-align: middle;
      margin-right: 6px;
      border-radius: 4px;
      background: rgba(255,255,255,.08);
    }
    .courseTop .badge{
      margin-top:10px;
      display:inline-flex;
      font-size:11px;
      font-weight:950;
      padding:6px 10px;
      border-radius:999px;
      background: rgba(255,255,255,.14);
      border: 1px solid rgba(255,255,255,.22);
    }

    .controls{
      display:flex;
      gap:10px;
      justify-content:space-between;
      align-items:center;
      padding: 10px 12px;
      border-bottom: 1px solid var(--line);
      background:#fff;
      flex-wrap:wrap;
    }

    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding: 10px 12px;
      border-radius: 12px;
      border:1px solid var(--line);
      background:#fff;
      text-decoration:none;
      font-weight:950;
      font-size:12px;
      white-space:nowrap;
      width:100%;
    }
    button.btn{font-family:inherit}
    .btnPrimary{
      background: #0d6b63;
      border-color:#0d6b63;
      color:#fff;
    }
    .btnPrimary:hover{background:#0b5e57}
    .btnGhost:hover{background:#f6f9fe}
    .btnToggle{
      width:auto;
      padding: 8px 10px;
      border-radius: 999px;
      font-size:11px;
      letter-spacing:.4px;
      text-transform:uppercase;
    }
    .btnInline{ width:auto; }

    .sessions{
      padding: 10px 12px 12px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .sessionRow{
      padding: 10px 10px;
      border-radius: 14px;
      border:1px solid var(--line);
      background:#fff;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .when{
      font-weight:950;
      font-size:13px;
      line-height:1.15;
    }
    .where{
      font-size:12px;
      color:var(--muted);
      line-height:1.2;
      word-break: break-word;
    }
    .btnRow{
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    .footer{
      padding: 18px 0 0;
      color: var(--muted);
      font-size:12px;
      text-align:center;
    }
  </style>
</head>

<body>
  <header class="topbar">
    <div class="row1">
      <div class="brand">
        <div class="logoDot" aria-hidden="true"></div>
        <div class="brandText">
          <div class="t">910CPR ‚Äî Schedule</div>
          <div class="s">Live &amp; blended classes with fast certificates</div>
        </div>
      </div>
      <a class="chip" href="./index.html" title="Desktop view">Desktop</a>
    </div>

    <div class="chipRow">
      <a class="chip" href="tel:+19103955193">üìû Call or text (910) 395-5193</a>
      <a class="chip" href="mailto:info@910cpr.com">‚úâÔ∏è Email help</a>
    </div>
  </header>

  <main class="wrap">
    <section class="panel">
      <div class="panelHeader">
        <p class="title">Filter</p>
        <p class="hint">Only upcoming sessions are shown. Courses are collapsed by default‚Äîexpand the one you want.</p>
      </div>
      <div class="filters">
        <select id="familySelect"></select>
        <input id="searchBox" type="search" placeholder="Search within titles (BLS, ACLS, Heartsaver‚Ä¶)" autocomplete="off" />
      </div>
    </section>

    <div id="status" class="notice">Loading schedule‚Ä¶</div>
    <div id="courseCards"></div>

    <div class="footer">
      No hidden URLs. If needed, you can always register directly through Enrollware.
    </div>
  </main>

  <script>
    const SCHEDULE_JSON_URL = "./data/schedule.json";
    const COURSE_DESC_JSON_URL = "./data/course-descriptions.json";

    const FAMILY_ORDER = [
      "BLS","ACLS","PALS","Heartsaver / CPR-AED","First Aid","OSHA","Stop the Bleed","Instructor","Other"
    ];

    // ---------- Date helpers ----------
    function _pickStartField(s) {
      return (
        s.start_ms || s.startMs || s.start_iso || s.startISO || s.start || s.start_datetime ||
        s.startDateTime || s.datetime || s.dateTime || s.when || s.class_start || null
      );
    }
    function toMillisFromRow(s) {
      const v = _pickStartField(s);
      if (v === null || v === undefined) return null;
      if (typeof v === "number" && Number.isFinite(v)) return v;
      if (typeof v === "string") {
        const t = Date.parse(v);
        return Number.isFinite(t) ? t : null;
      }
      return null;
    }
    function isUpcomingRow(s, nowMs) {
      if (typeof s?.is_past === "boolean") return !s.is_past;
      const ms = toMillisFromRow(s);
      if (ms === null) return false;
      return ms >= nowMs;
    }
    function sortRowsByStartAsc(a, b) {
      const am = toMillisFromRow(a);
      const bm = toMillisFromRow(b);
      return (am ?? 9e15) - (bm ?? 9e15);
    }
    function formatWhen(ms) {
      try{
        const d = new Date(ms);
        return d.toLocaleString(undefined, {
          weekday:"long", year:"numeric", month:"long", day:"numeric", hour:"numeric", minute:"2-digit"
        });
      }catch(e){
        return "Date/time";
      }
    }

    // ---------- Row field pickers ----------
    function pickRegisterUrl(row){
      return row.register_url || row.registerUrl || row.url || row.enroll_url || row.enrollUrl || row.enroll_link || row.enrollLink || row.register || row.enroll || "";
    }
    function pickScheduleUrl(row){
      return row.schedule_url || row.scheduleUrl || row.course_url || row.courseUrl || row.ct_url || row.ctUrl || "";
    }
    function pickCourseKey(row){
      return (
        row.course_number || row.courseNumber || row.course_id || row.courseId || row.ct_id || row.ctId ||
        row.courseTypeId || row.course_type_id || row.course_type || row.course_slug || row.courseSlug ||
        pickScheduleUrl(row) || row.title || row.course_name || row.courseName || row.name || null
      );
    }
    function pickCourseTitle(row){
      return row.title || row.course_name || row.courseName || row.course_title || row.courseTitle || row.name || "Course";
    }
    function pickLocation(row){
      return row.location || row.location_name || row.locationName || row.city_state || row.cityState || row.city || row.site || row.address || "Location TBD";
    }

    function classifyFamily(courseTitle){
      const t = String(courseTitle || "").toUpperCase();
      if (t.includes("ACLS")) return "ACLS";
      if (t.includes("PALS")) return "PALS";
      if (t.includes("BLS")) return "BLS";
      if (t.includes("HEARTSAVER") || t.includes("CPR/AED") || t.includes("CPR AED") || t.includes("CPR-AED")) return "Heartsaver / CPR-AED";
      if (t.includes("FIRST AID") || t.includes("FA/") || t.includes("FA ")) return "First Aid";
      if (t.includes("OSHA") || t.includes("USCG") || t.includes("COAST GUARD") || t.includes("DAN")) return "OSHA";
      if (t.includes("STOP THE BLEED")) return "Stop the Bleed";
      if (t.includes("INSTRUCTOR")) return "Instructor";
      return "Other";
    }

    // ---------- Safe HTML (so <img> in titles renders) ----------
    function sanitizeEnrollwareHtml(html) {
      const allowedTags = new Set(["IMG", "I", "B", "STRONG", "EM", "BR", "SPAN", "DIV", "SMALL"]);
      const allowedAttrs = new Set(["src", "alt", "title", "style", "class", "loading"]);

      const tpl = document.createElement("template");
      tpl.innerHTML = String(html || "");

      const walk = (node) => {
        if (node.nodeType === Node.COMMENT_NODE) { node.remove(); return; }
        if (node.nodeType === Node.ELEMENT_NODE) {
          const tag = node.tagName.toUpperCase();
          if (!allowedTags.has(tag)) {
            const text = document.createTextNode(node.textContent || "");
            node.replaceWith(text);
            return;
          }
          [...node.attributes].forEach(attr => {
            const name = attr.name.toLowerCase();
            if (name.startsWith("on")) { node.removeAttribute(attr.name); return; }
            if (!allowedAttrs.has(name)) { node.removeAttribute(attr.name); return; }
            if (tag === "IMG" && name === "src") {
              const v = (attr.value || "").trim();
              if (!(v.startsWith("http://") || v.startsWith("https://"))) node.removeAttribute("src");
            }
          });
        }
        [...node.childNodes].forEach(walk);
      };
      [...tpl.content.childNodes].forEach(walk);
      return tpl.innerHTML;
    }

    // ---------- Curtain labels ----------
    function setCollapsed(containerEl, toggleBtnEl, collapsed) {
      containerEl.style.display = collapsed ? "none" : "flex";
      toggleBtnEl.textContent = collapsed ? "SHOW 5" : "HIDE";
      toggleBtnEl.setAttribute("aria-expanded", collapsed ? "false" : "true");
      toggleBtnEl.dataset.collapsed = collapsed ? "true" : "false";
    }

    // Accordion: only one open at a time
    function closeAllCurtainsExcept(courseKeyToKeep){
      const wraps = document.querySelectorAll(".courseCard .sessions[data-course-key]");
      wraps.forEach(wrap => {
        const k = wrap.dataset.courseKey;
        if (k !== courseKeyToKeep) wrap.style.display = "none";
      });

      const toggles = document.querySelectorAll(".courseCard button[data-role='toggle'][data-course-key]");
      toggles.forEach(btn => {
        const k = btn.dataset.courseKey;
        if (k !== courseKeyToKeep){
          btn.textContent = "SHOW 5";
          btn.setAttribute("aria-expanded","false");
          btn.dataset.collapsed = "true";
        }
      });
    }

    // ---------- Grouping ----------
    function buildUpcomingIndex(scheduleRows, nowMs){
      const groups = new Map();
      for(const row of (scheduleRows || [])){
        const key = pickCourseKey(row);
        if(!key) continue;
        if(!isUpcomingRow(row, nowMs)) continue;

        if(!groups.has(key)){
          groups.set(key, {
            courseKey: key,
            courseTitle: pickCourseTitle(row),
            family: classifyFamily(pickCourseTitle(row)),
            scheduleUrl: pickScheduleUrl(row),
            sessions:[]
          });
        }
        const g = groups.get(key);
        if (!g.scheduleUrl) g.scheduleUrl = pickScheduleUrl(row);
        g.sessions.push(row);
      }
      for(const g of groups.values()){
        g.sessions.sort(sortRowsByStartAsc);
        g.nextStartMs = toMillisFromRow(g.sessions[0]) ?? 9e15;
      }
      const list = Array.from(groups.values());
      list.sort((A,B)=>A.nextStartMs - B.nextStartMs);
      return list;
    }

    function countFamilyInventory(groups){
      const m = new Map();
      for(const fam of FAMILY_ORDER) m.set(fam,0);
      for(const g of groups){
        m.set(g.family, (m.get(g.family)||0) + g.sessions.length);
      }
      return m;
    }

    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    const elStatus = document.getElementById("status");
    const elCards = document.getElementById("courseCards");
    const elFamilySelect = document.getElementById("familySelect");
    const elSearchBox = document.getElementById("searchBox");

    let COURSE_DESC = {};
    let ALL_GROUPS = [];
    let ACTIVE_FAMILY = "BLS";

    function pickCourseDescription(courseKey, courseTitle){
      return COURSE_DESC[courseKey] || COURSE_DESC[courseTitle] || "";
    }

    function renderFamilySelect(){
      const inv = countFamilyInventory(ALL_GROUPS);

      elFamilySelect.innerHTML = "";
      for(const fam of FAMILY_ORDER){
        const opt = document.createElement("option");
        const c = inv.get(fam) || 0;
        opt.value = fam;
        opt.textContent = `${fam} (${c})`;
        elFamilySelect.appendChild(opt);
      }

      if ((inv.get(ACTIVE_FAMILY)||0) === 0){
        for (const fam of FAMILY_ORDER){
          if ((inv.get(fam)||0) > 0){
            ACTIVE_FAMILY = fam;
            break;
          }
        }
      }
      elFamilySelect.value = ACTIVE_FAMILY;
    }

    function renderCards(){
      const q = String(elSearchBox.value || "").trim().toUpperCase();

      const groups = ALL_GROUPS
        .filter(g => g.family === ACTIVE_FAMILY)
        .filter(g => !q || String(g.courseTitle||"").toUpperCase().includes(q));

      elCards.innerHTML = "";

      if (groups.length === 0){
        elStatus.className = "notice";
        elStatus.textContent = "No upcoming sessions found for this filter.";
        return;
      }

      elStatus.className = "notice";
      elStatus.textContent = `Showing upcoming sessions for: ${ACTIVE_FAMILY}`;

      for(const g of groups){
        const card = document.createElement("div");
        card.className = "courseCard";

        const descRaw = pickCourseDescription(g.courseKey, g.courseTitle);
        const titleHtml = sanitizeEnrollwareHtml(g.courseTitle);
        const descHtml  = descRaw ? sanitizeEnrollwareHtml(descRaw) : "";

        const top = document.createElement("div");
        top.className = "courseTop";
        top.innerHTML = `
          <h3>${titleHtml}</h3>
          ${descHtml ? `<div class="desc">${descHtml}</div>` : ``}
          <div class="badge">Shown: ${g.sessions.length} upcoming</div>
        `;

        const controls = document.createElement("div");
        controls.className = "controls";

        const toggleBtn = document.createElement("button");
        toggleBtn.type = "button";
        toggleBtn.className = "btn btnGhost btnToggle";
        toggleBtn.style.cursor = "pointer";
        toggleBtn.dataset.role = "toggle";
        toggleBtn.dataset.courseKey = String(g.courseKey);

        const hasScheduleUrl = !!(g.scheduleUrl && String(g.scheduleUrl).trim());

        const moreDates = document.createElement("a");
        moreDates.className = "btn btnGhost btnInline";
        moreDates.textContent = "See even more dates";
        moreDates.href = g.scheduleUrl || "#";
        moreDates.target = "_blank";
        moreDates.rel = "noopener";
        if (!hasScheduleUrl) moreDates.style.display = "none";

        controls.appendChild(toggleBtn);
        controls.appendChild(moreDates);

        const sessions = document.createElement("div");
        sessions.className = "sessions";
        sessions.dataset.courseKey = String(g.courseKey);

        for(const row of g.sessions.slice(0, 5)){
          const ms = toMillisFromRow(row);
          const when = ms ? formatWhen(ms) : "Date/time";
          const where = pickLocation(row);
          const regUrl = pickRegisterUrl(row);

          const sr = document.createElement("div");
          sr.className = "sessionRow";
          sr.innerHTML = `
            <div class="when">${escapeHtml(when)}</div>
            <div class="where">${escapeHtml(where)}</div>
            <div class="btnRow">
              <a class="btn btnPrimary" href="${escapeHtml(regUrl || "#")}" target="_blank" rel="noopener">Register now</a>
            </div>
          `;
          sessions.appendChild(sr);
        }

        // default collapsed
        setCollapsed(sessions, toggleBtn, true);

        toggleBtn.addEventListener("click", () => {
          const isCollapsed = (toggleBtn.dataset.collapsed === "true");
          if (isCollapsed) {
            closeAllCurtainsExcept(String(g.courseKey));
            setCollapsed(sessions, toggleBtn, false);
          } else {
            setCollapsed(sessions, toggleBtn, true);
          }
        });

        card.appendChild(top);
        card.appendChild(controls);
        card.appendChild(sessions);
        elCards.appendChild(card);
      }
    }

    function withCacheBust(url){
      const u = new URL(url, window.location.href);
      u.searchParams.set("ts", String(Date.now()));
      return u.toString();
    }

    async function loadJson(url){
      const r = await fetch(withCacheBust(url), { cache:"no-store" });
      if(!r.ok) throw new Error(`HTTP ${r.status} while fetching ${url}`);
      return await r.json();
    }

    async function boot(){
      try {
        const [scheduleRows, descJson] = await Promise.all([
          loadJson(SCHEDULE_JSON_URL),
          loadJson(COURSE_DESC_JSON_URL).catch(() => ({}))
        ]);

        COURSE_DESC = descJson || {};
        ALL_GROUPS = buildUpcomingIndex(scheduleRows, Date.now());

        renderFamilySelect();
        renderCards();
      } catch (err) {
        // This is your "corrected appropriately" block, integrated properly:
        elStatus.className = "error";
        elStatus.textContent = "Schedule failed to load. Please refresh, or register directly through Enrollware.";
        console.error(err);

        // give the user a concrete escape hatch
        elCards.innerHTML = `
          <div class="error">
            <div style="font-weight:950;margin-bottom:6px;">Details</div>
            <div style="margin-bottom:10px;">${escapeHtml(err?.message || String(err))}</div>
            <a class="btn btnGhost" href="https://www.enrollware.com/site/coastalcprtraining/schedule#view=calendar" target="_blank" rel="noopener">
              Open Enrollware schedule (full URL)
            </a>
          </div>
        `;
      }
    }

    elFamilySelect.addEventListener("change", () => {
      ACTIVE_FAMILY = elFamilySelect.value;
      renderCards();
      window.scrollTo({ top: 0, behavior: "smooth" });
    });

    elSearchBox.addEventListener("input", renderCards);

    boot();
  </script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>910CPR ‚Äî Schedule (Mobile)</title>

  <style>
    :root{
      --bg1:#ffffff;
      --bg2:#eaf4ff;
      --ink:#0b1b2a;
      --muted:#5b6b7a;
      --line:#d7e3f0;
      --card:#ffffff;
      --brand:#0b5fa5;
      --brand2:#083b64;
      --ok:#0c6b52;
      --shadow: 0 10px 30px rgba(10,35,60,.10);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--ink);
      background: linear-gradient(180deg,var(--bg1),var(--bg2));
    }
    a{color:inherit}

    header{
      position: sticky;
      top:0;
      z-index: 50;
      background: linear-gradient(90deg,var(--brand2),var(--brand));
      color:#fff;
      padding: 12px 14px;
      box-shadow: 0 8px 24px rgba(0,0,0,.18);
    }
    .headRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .brand{
      min-width:0;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .brand img{
      height: 28px;
      width:auto;
      display:block;
      border-radius: 6px;
      background: rgba(255,255,255,.12);
      padding: 4px;
    }
    .brandText{
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .brandText .t{
      font-weight: 950;
      font-size: 13px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 56vw;
    }
    .brandText .s{
      font-size: 11px;
      opacity:.9;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 62vw;
    }
    .chipRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 10px;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding: 9px 12px;
      border-radius:999px;
      background: rgba(255,255,255,.14);
      border:1px solid rgba(255,255,255,.22);
      text-decoration:none;
      font-weight: 900;
      font-size: 12px;
      white-space:nowrap;
    }

    .themeCenter{
      position: fixed;
      inset: 0;
      pointer-events:none;
      background:
        url("./assets/images/910CPR_wave.jpg") center 180px / 650px auto no-repeat;
      opacity: 0.06;
      z-index: 0;
    }
    .themeCorner{
      position: fixed;
      right: 12px;
      bottom: 12px;
      width: 56px;
      height: 56px;
      border-radius: 16px;
      display:flex;
      align-items:center;
      justify-content:center;
      background: rgba(255,255,255,.75);
      border: 1px solid var(--line);
      box-shadow: var(--shadow);
      z-index: 40;
      text-decoration:none;
    }
    .themeCorner img{
      width: 40px;
      height: 40px;
      object-fit: contain;
      display:block;
      opacity: .9;
    }
    header, main{ position: relative; z-index: 1; }

    main{
      max-width: 860px;
      margin: 14px auto 36px;
      padding: 0 12px;
    }

    .panel{
      background: var(--card);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panelHead{
      padding: 12px 14px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg,#fff,#f7fbff);
    }
    .panelHead .h{
      margin:0;
      font-weight: 950;
      font-size: 14px;
    }
    .panelHead .p{
      margin:6px 0 0;
      font-size: 12px;
      color: var(--muted);
      line-height:1.35;
    }
    .filters{
      padding: 12px 14px 14px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    select,input{
      width:100%;
      padding: 11px 12px;
      border-radius: 12px;
      border:1px solid var(--line);
      font-size: 13px;
      outline:none;
      background:#fff;
    }

    .notice{
      margin: 12px 0;
      background:#f7fbff;
      border:1px dashed #c7d9ee;
      border-radius: 14px;
      padding: 10px 12px;
      color:#18314a;
      font-size: 13px;
      line-height:1.35;
    }
    .error{
      margin: 12px 0;
      background:#fff5f1;
      border:1px solid #ffd2c1;
      border-radius: 14px;
      padding: 12px 12px;
      color:#5b1f0b;
      font-size: 13px;
      line-height:1.35;
    }

    .course{
      border:1px solid var(--line);
      border-radius: var(--radius);
      overflow:hidden;
      background:#fff;
      box-shadow: var(--shadow);
      margin: 12px 0;
    }
    .courseHead{
      padding: 12px 14px;
      background: linear-gradient(90deg,var(--brand2),var(--brand));
      color:#fff;
      display:flex;
      flex-wrap:wrap;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px 12px;
      width: 100%;
    }
    .courseTitle{
      flex: 1 1 260px;
      min-width: 0;
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .courseTitle .t{
      font-size: 14px;
      font-weight: 950;
      line-height:1.2;
      white-space: normal !important;
      overflow: visible !important;
      text-overflow: clip !important;
      overflow-wrap:anywhere;
      word-break:break-word;
    }
    .courseTitle .s{
      font-size: 12px;
      opacity:.92;
      line-height:1.25;
      white-space: normal !important;
      overflow: visible !important;
      text-overflow: clip !important;
      overflow-wrap:anywhere;
      word-break:break-word;
    }
    .courseTitle .t img,
    .courseTitle .s img{
      height: 18px;
      width:auto;
      vertical-align: middle;
      border-radius:4px;
      background: rgba(255,255,255,.12);
      margin-right:6px;
    }
    .courseActions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
      margin-left:auto;
    }
    .pillBtn, .pillLink{
      background: rgba(255,255,255,.14);
      border: 1px solid rgba(255,255,255,.25);
      color:#fff;
      padding: 8px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 950;
      letter-spacing:.35px;
      text-transform:uppercase;
      cursor:pointer;
      white-space:nowrap;
      text-decoration:none;
      user-select:none;
    }

    .courseBody{ padding: 12px 14px; }
    .sessions{ display:flex; flex-direction:column; gap:10px; }

    /* MOBILE REAL ESTATE: compact row + right-side button */
    .session{
      border:1px solid var(--line);
      border-radius: 14px;
      padding: 10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .when{ min-width:0; }
    .when strong{ font-size: 13px; font-weight: 950; line-height:1.15; }
    .when small{
      font-size: 12px; color:var(--muted);
      overflow-wrap:anywhere; word-break:break-word;
      display:block;
    }
    .reg{
      flex: 0 0 auto;
      display:inline-flex;
      justify-content:center;
      align-items:center;
      background: var(--ok);
      color:#fff;
      text-decoration:none;
      padding: 10px 12px;
      border-radius: 999px;
      font-weight: 950;
      white-space:nowrap;
    }

    footer{
      margin-top: 14px;
      padding: 10px 0 0;
      text-align:center;
      color: var(--muted);
      font-size: 12px;
    }
  </style>
</head>

<body>
  <div class="themeCenter" aria-hidden="true"></div>
  <a class="themeCorner" href="tel:+19103955193" aria-label="Call 910CPR">
    <img src="./assets/images/910CPR_wave.jpg" alt="" />
  </a>

  <header>
    <div class="headRow">
      <div class="brand">
        <img src="./assets/images/910CPR_wave.jpg" alt="910CPR" />
        <div class="brandText">
          <div class="t">910CPR ‚Äî Schedule</div>
          <div class="s">Live &amp; blended classes with fast certificates</div>
        </div>
      </div>
      <a class="chip" href="./index.html">Desktop</a>
    </div>
    <div class="chipRow">
      
      <a class="chip" href="./onsite.html"><strong>Group Class Quote / Inquiry</strong></a>
<a class="chip" href="tel:+19103955193">üìû Call or text (910) 395-5193</a>
      <a class="chip" href="mailto:info@910cpr.com">‚úâÔ∏è Email help</a>
    </div>
  </header>

  <main>
    <section class="panel">
      <div class="panelHead">
        <p class="h">Filter</p>
        <p class="p">Only upcoming sessions are shown. Courses are collapsed by default ‚Äî expand the one you want.</p>
      </div>
      <div class="filters">
        <select id="familySelect"></select>
        <input id="searchBox" type="search" placeholder="Search within titles (BLS, ACLS, Heartsaver‚Ä¶)" />
      </div>
    </section>

    <div id="status" class="notice">Loading schedule‚Ä¶</div>
    <div id="courseCards"></div>

    </main>

  <script>
    
    // --- Family override rules (surgical) ---
    // Some provider-only cards come through as "American Heart Association" without a course keyword.
    // Treat that placeholder as CPR/AED so it doesn't land in "Other".
    function forceFamilyOverride(obj){
      const title = (obj && (obj.title || obj.name || obj.provider)) ? (obj.title || obj.name || obj.provider) : (obj || "");
      const t = (title || "").trim().toLowerCase();
      if(t === "american heart association") return "Heartsaver / CPR-AED";
      return null;
    }

const SCHEDULE_JSON_URL = "./data/schedule.json";
    const COURSE_DESC_JSON_URL = "./data/course-descriptions.json";
    const ENROLLWARE_SITE = "https://www.enrollware.com/site/coastalcprtraining/schedule";

    const FAMILY_ORDER = [
      "ACLS","BLS","PALS","Heartsaver / CPR-AED","First Aid","OSHA","Stop the Bleed","Instructor","Other"
    ];

    function withCacheBust(url){
      const u = new URL(url, window.location.href);
      u.searchParams.set("ts", String(Date.now()));
      return u.toString();
    }
    async function loadJson(url){
      const r = await fetch(withCacheBust(url), { cache:"no-store" });
      if(!r.ok) throw new Error(`HTTP ${r.status} while fetching ${url}`);
      return await r.json();
    }
    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    function sanitizeEnrollwareHtml(html) {
      const allowedTags = new Set(["IMG","I","B","STRONG","EM","BR","SPAN","SMALL","DIV"]);
      const allowedAttrs = new Set(["src","alt","title","style","class","loading"]);

      const tpl = document.createElement("template");
      tpl.innerHTML = String(html || "");

      const walk = (node) => {
        if (node.nodeType === Node.COMMENT_NODE) { node.remove(); return; }
        if (node.nodeType === Node.ELEMENT_NODE) {
          const tag = node.tagName.toUpperCase();
          if (!allowedTags.has(tag)) {
            const text = document.createTextNode(node.textContent || "");
            node.replaceWith(text);
            return;
          }
          [...node.attributes].forEach(attr => {
            const name = attr.name.toLowerCase();
            if (name.startsWith("on")) { node.removeAttribute(attr.name); return; }
            if (!allowedAttrs.has(name)) { node.removeAttribute(attr.name); return; }
            if (tag === "IMG" && name === "src") {
              const v = (attr.value || "").trim();
              if (!(v.startsWith("http://") || v.startsWith("https://"))) node.removeAttribute("src");
            }
          });
        }
        [...node.childNodes].forEach(walk);
      };
      [...tpl.content.childNodes].forEach(walk);
      return tpl.innerHTML;
    }

    function _pickStartField(s){
      return (
        s.start_ms || s.startMs || s.start_iso || s.startISO || s.start || s.start_datetime ||
        s.startDateTime || s.datetime || s.dateTime || s.when || s.class_start || null
      );
    }
    function toMillis(row){
      const v = _pickStartField(row);
      if (v == null) return null;
      if (typeof v === "number" && Number.isFinite(v)) return v;
      if (typeof v === "string"){
        const t = Date.parse(v);
        return Number.isFinite(t) ? t : null;
      }
      return null;
    }
    function isUpcoming(row, nowMs){
      if (typeof row?.is_past === "boolean") return !row.is_past;
      const ms = toMillis(row);
      return ms != null && ms >= nowMs;
    }
    function fmtWhen(ms){
      const d = new Date(ms);
      return d.toLocaleString(undefined, {
        weekday:"long", year:"numeric", month:"long", day:"numeric", hour:"numeric", minute:"2-digit"
      });
    }

    function pickCourseKey(row){
      return row.course_number || row.courseNumber || row.course_id || row.courseId ||
             row.ct_id || row.ctId || row.courseTypeId || row.course_type_id ||
             row.course_slug || row.courseSlug || row.course_url || row.courseUrl ||
             row.schedule_url || row.scheduleUrl || row.title || row.course_name || row.courseName || "unknown";
    }
    function pickCourseTitle(row){
      return row.title || row.course_name || row.courseName || row.course_title || row.courseTitle || "Course";
    }
    function pickCourseSubtitle(row){
      return row.subtitle || row.course_subtitle || row.courseSubtitle || row.course_tagline || "";
    }
    function pickLocation(row){
      return row.location || row.location_name || row.locationName || row.city_state ||
             row.cityState || row.site || row.address || "Location TBD";
    }
    function pickRegisterUrl(row){
      return row.register_url || row.registerUrl || row.enroll_url || row.enrollUrl ||
             row.enroll_link || row.enrollLink || row.url || row.register || row.enroll || "";
    }
    function pickCtId(row){
      const v = row.ct_id || row.ctId || row.courseTypeId || row.course_type_id || row.course_type || null;
      if (v == null) return null;
      const n = Number(v);
      return Number.isFinite(n) ? n : null;
    }
    function pickScheduleUrl(row){
      return row.schedule_url || row.scheduleUrl || row.course_url || row.courseUrl || row.ct_url || row.ctUrl || "";
    }
    function inferScheduleUrl(row, courseKey){
      const direct = pickScheduleUrl(row);
      if (direct) return direct;
      const ct = pickCtId(row);
      if (ct) return `${ENROLLWARE_SITE}#ct${ct}`;
      const m = String(courseKey || "").match(/ct(\d{3,})/i);
      if (m && m[1]) return `${ENROLLWARE_SITE}#ct${m[1]}`;
      return "";
    }

    function classifyFamily(title){
      const t = String(title || "").toUpperCase();
      if (t.includes("ACLS")) return "ACLS";
      if (t.includes("PALS")) return "PALS";
      if (t.includes("BLS")) return "BLS";
      if (t.includes("HEARTSAVER") || t.includes("CPR/AED") || t.includes("CPR AED") || t.includes("CPR-AED")) return "Heartsaver / CPR-AED";
      if (t.includes("FIRST AID") || t.includes("FA/") || t.includes("FA ")) return "First Aid";
      if (t.includes("OSHA") || t.includes("USCG") || t.includes("COAST GUARD") || t.includes("DAN")) return "OSHA";
      if (t.includes("STOP THE BLEED")) return "Stop the Bleed";
      if (t.includes("INSTRUCTOR")) return "Instructor";
      return "Other";
    }

    function buildGroups(rows){
      const now = Date.now();
      const map = new Map();

      for (const r of (rows || [])){
        if (!isUpcoming(r, now)) continue;

        const key = String(pickCourseKey(r));
        const title = pickCourseTitle(r);
        const fam = classifyFamily(title);

        if (!map.has(key)){
          map.set(key, {
            key,
            title,
            subtitle: pickCourseSubtitle(r),
            family: fam,
            scheduleUrl: inferScheduleUrl(r, key),
            sessions: []
          });
        }
        const g = map.get(key);
        if (!g.scheduleUrl) g.scheduleUrl = inferScheduleUrl(r, key);
        g.sessions.push(r);
      }

      const list = Array.from(map.values());
      for (const g of list){
        g.sessions.sort((a,b)=>(toMillis(a) ?? 9e15) - (toMillis(b) ?? 9e15));
        g.nextMs = toMillis(g.sessions[0]) ?? 9e15;
      }
      list.sort((a,b)=>a.nextMs - b.nextMs);
      return list;
    }

    function countFamilies(groups){
      const m = new Map();
      for (const f of FAMILY_ORDER) m.set(f, 0);
      for (const g of groups){
        m.set(g.family, (m.get(g.family)||0) + g.sessions.length);
      }
      return m;
    }

    const elStatus = document.getElementById("status");
    const elCards = document.getElementById("courseCards");
    const elFamilySelect = document.getElementById("familySelect");
    const elSearchBox = document.getElementById("searchBox");

    let COURSE_DESC = {};
    let GROUPS = [];
    let ACTIVE_FAMILY = "BLS";

    function pickDesc(key, title){
      return COURSE_DESC[key] || COURSE_DESC[title] || "";
    }

    function renderFamilySelect(){
      const inv = countFamilies(GROUPS);
      elFamilySelect.innerHTML = "";
      for (const fam of FAMILY_ORDER){
        const opt = document.createElement("option");
        opt.value = fam;
        opt.textContent = `${fam} (${inv.get(fam)||0})`;
        elFamilySelect.appendChild(opt);
      }
      if ((inv.get(ACTIVE_FAMILY)||0) === 0){
        for (const fam of FAMILY_ORDER){
          if ((inv.get(fam)||0) > 0){ ACTIVE_FAMILY = fam; break; }
        }
      }
      elFamilySelect.value = ACTIVE_FAMILY;
    }

    function setCollapsed(sessionsEl, toggleBtn, collapsed){
      sessionsEl.style.display = collapsed ? "none" : "flex";
      toggleBtn.textContent = collapsed ? "SHOW 5" : "HIDE";
      toggleBtn.dataset.collapsed = collapsed ? "true" : "false";
      toggleBtn.setAttribute("aria-expanded", collapsed ? "false" : "true");
    }

    function closeAllExcept(key){
      document.querySelectorAll(".sessions[data-key]").forEach(el => {
        if (el.dataset.key !== key) el.style.display = "none";
      });
      document.querySelectorAll("button.pillBtn[data-key]").forEach(btn => {
        if (btn.dataset.key !== key){
          btn.textContent = "SHOW 5";
          btn.dataset.collapsed = "true";
          btn.setAttribute("aria-expanded","false");
        }
      });
    }

    function renderCards(){
      const q = String(elSearchBox.value || "").trim().toUpperCase();
      const list = GROUPS
        .filter(g => g.family === ACTIVE_FAMILY)
        .filter(g => !q || String(g.title||"").toUpperCase().includes(q));

      elCards.innerHTML = "";

      if (list.length === 0){
        elStatus.className = "notice";
        elStatus.textContent = "No upcoming sessions found for this filter.";
        return;
      }

      elStatus.className = "notice";
      elStatus.textContent = `Showing upcoming sessions for: ${ACTIVE_FAMILY}`;

      for (const g of list){
        const card = document.createElement("article");
        card.className = "course";

        const titleHtml = sanitizeEnrollwareHtml(g.title);
        const descHtml  = sanitizeEnrollwareHtml(pickDesc(g.key, g.title) || g.subtitle || "");

        const head = document.createElement("div");
        head.className = "courseHead";

        const left = document.createElement("div");
        left.className = "courseTitle";
        left.innerHTML = `
          <div class="t">${titleHtml}</div>
          ${descHtml ? `<div class="s">${descHtml}</div>` : ``}
        `;

        const actions = document.createElement("div");
        actions.className = "courseActions";

        const toggle = document.createElement("button");
        toggle.type = "button";
        toggle.className = "pillBtn";
        toggle.dataset.key = String(g.key);

        const more = document.createElement("a");
        more.className = "pillLink";
        more.textContent = "More dates";
        more.href = g.scheduleUrl || "#";
        more.target = "_blank";
        more.rel = "noopener";
        if (!g.scheduleUrl) more.style.display = "none";

        actions.appendChild(toggle);
        actions.appendChild(more);

        head.appendChild(left);
        head.appendChild(actions);

        const body = document.createElement("div");
        body.className = "courseBody";

        const sessions = document.createElement("div");
        sessions.className = "sessions";
        sessions.dataset.key = String(g.key);

        for (const r of g.sessions.slice(0,5)){
          const ms = toMillis(r);
          const when = ms ? fmtWhen(ms) : "Date/time";
          const where = pickLocation(r);
          const regUrl = pickRegisterUrl(r);

          const row = document.createElement("div");
          row.className = "session";
          row.innerHTML = `
            <div class="when">
              <strong>${escapeHtml(when)}</strong><br/>
              <small>${escapeHtml(where)}</small>
            </div>
            <a class="reg" href="${escapeHtml(regUrl || "#")}" target="_blank" rel="noopener">Register now</a>
          `;
          sessions.appendChild(row);
        }

        setCollapsed(sessions, toggle, true);

        toggle.addEventListener("click", () => {
          const isCollapsed = (toggle.dataset.collapsed === "true");
          if (isCollapsed){
            closeAllExcept(String(g.key));
            setCollapsed(sessions, toggle, false);
          } else {
            setCollapsed(sessions, toggle, true);
          }
        });

        body.appendChild(sessions);
        card.appendChild(head);
        card.appendChild(body);
        elCards.appendChild(card);
      }
    }

    async function boot(){
      try{
        const [scheduleRows, desc] = await Promise.all([
          loadJson(SCHEDULE_JSON_URL),
          load

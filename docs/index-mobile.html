<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>910CPR Schedule (Mobile)</title>

  <style>
    :root{
      --bg1:#ffffff;
      --bg2:#f3f7ff;
      --ink:#0f172a;
      --muted:#475569;
      --card:#ffffff;
      --line:#e2e8f0;
      --brand:#0b5b6b;
      --brand2:#0f766e;
      --warn:#b45309;
      --shadow: 0 10px 25px rgba(2, 8, 23, .08);
      --radius: 16px;
    }
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--ink);
      background: linear-gradient(180deg,var(--bg1),var(--bg2));
    }
    .top{
      background: linear-gradient(90deg,#0b1a2b,#0b2940);
      color:#fff;
      padding:12px 14px;
    }
    .top h1{margin:0;font-size:15px;}
    .top p{margin:4px 0 0;font-size:12px;opacity:.85;}
    .wrap{padding:14px;max-width:720px;margin:0 auto;}
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:12px;
      margin-bottom:12px;
    }
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;}
    .btn{
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      padding:10px 12px;border-radius:12px;border:1px solid var(--line);
      background:#fff;text-decoration:none;font-weight:800;font-size:14px;
    }
    .btnPrimary{
      background: linear-gradient(90deg,var(--brand),var(--brand2));
      color:#fff;border-color: transparent;
    }
    .btnWarn{border-color: rgba(180,83,9,.35); background:#fff7ed; color: var(--warn);}
    .search{
      width:100%;
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px 12px;
      font-size:14px;
      outline:none;
      margin-top:10px;
    }
    .pillRow{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;}
    .pill{
      font-size:13px;
      border:1px solid var(--line);
      background:#f8fafc;
      padding:7px 10px;
      border-radius:999px;
      cursor:pointer;
      user-select:none;
      font-weight:800;
      color:var(--muted);
    }
    .pill.active{border-color: rgba(11,91,107,.45); box-shadow: 0 0 0 3px rgba(11,91,107,.10); color:var(--ink); background:#fff;}
    .course{
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      margin-top:10px;
      background:#fff;
    }
    .title{font-size:16px;font-weight:900;margin:0 0 6px;}
    .meta{color:var(--muted);font-size:13px;margin:0 0 10px;line-height:1.35;}
    .sess{
      border-top:1px dashed #e2e8f0;
      padding-top:10px;
      margin-top:10px;
    }
    .d{font-weight:900;margin:0 0 4px;}
    .l{margin:0;color:var(--muted);font-size:13px;line-height:1.35;}
    .p{margin:8px 0 0;font-weight:900;font-size:13px;}
    .cta{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;}
    .empty{
      border:1px dashed #cbd5e1;
      background:#f8fafc;
      padding:14px;border-radius:14px;color:var(--muted);
    }
  </style>
</head>
<body>
  <div class="top">
    <h1>910CPR Schedule (Mobile)</h1>
    <p>Pick a family â†’ pick a class â†’ register</p>
  </div>

  <div class="wrap">
    <div class="card">
      <div class="row">
        <a class="btn" href="./index.html">â¬… Desktop view</a>
        <a class="btn" href="tel:+19103955193">ðŸ“ž Call/text</a>
      </div>
      <input id="q" class="search" placeholder="Search (BLS, ACLS, Heartsaver...)" />
      <div id="families" class="pillRow"></div>
      <div id="familyEmpty" class="empty" style="display:none;margin-top:10px;">
        No classes were found in schedule.json.
      </div>
    </div>

    <div class="card">
      <div id="courses"></div>
      <div id="courseEmpty" class="empty" style="display:none;">
        Choose a family to see classes.
      </div>
    </div>

    <div class="card">
      <div style="color:var(--muted);font-size:13px;line-height:1.4;">
        Full schedule:
        <a href="https://coastalcprtraining.enrollware.com/schedule" target="_blank" rel="noopener">
          Enrollware schedule
        </a>
      </div>
    </div>
  </div>

<script>
(function(){
  const SCHEDULE_URL = "./data/schedule.json";
  const elFamilies = document.getElementById("families");
  const elFamilyEmpty = document.getElementById("familyEmpty");
  const elCourses = document.getElementById("courses");
  const elCourseEmpty = document.getElementById("courseEmpty");
  const elQ = document.getElementById("q");

  function norm(s){ return (s||"").toString().trim(); }

  function inferFamily(title){
    const t = norm(title).toLowerCase();
    if (t.includes("acls")) return "ACLS";
    if (t.includes("pals")) return "PALS";
    if (t.includes("bls")) return "BLS";
    if (t.includes("heartsaver") || t.includes("cpr aed") || t.includes("cpr/aed")) return "Heartsaver / CPR-AED";
    if (t.includes("first aid") || t.includes("firstaid")) return "First Aid";
    if (t.includes("stop the bleed") || t.includes("bleed")) return "Stop the Bleed";
    if (t.includes("osha")) return "OSHA";
    if (t.includes("instructor")) return "Instructor";
    if (t.includes("asls")) return "ASLS";
    if (t.includes("elementary first aid") || t.includes("coast guard") || t.includes("maritime")) return "Maritime / USCG";
    return "Other";
  }

  function isFuture(row){
    const s = norm(row.start_iso);
    if (s){
      const d = new Date(s);
      if (!isNaN(d.getTime())) return d.getTime() >= Date.now() - 60*1000;
    }
    const dt = norm(row.date);
    const m = dt.match(/(20\d{2})/);
    if (m){
      const y = parseInt(m[1],10);
      if (!isNaN(y) && y >= (new Date()).getFullYear()) return true;
    }
    return false;
  }

  function fmtPrice(p){
    if (p === null || p === undefined || p === "") return "";
    const n = Number(p);
    if (!isNaN(n)) return "$" + n.toFixed(2).replace(".00","");
    return String(p);
  }

  function groupBy(arr, keyFn){
    const m = new Map();
    for (const x of arr){
      const k = keyFn(x);
      if (!m.has(k)) m.set(k, []);
      m.get(k).push(x);
    }
    return m;
  }

  function pickEnrollUrl(row){
    const u = norm(row.url);
    if (u) return u;
    if (row.id) return "https://coastalcprtraining.enrollware.com/enroll?id=" + row.id;
    return "https://coastalcprtraining.enrollware.com/schedule";
  }

  function courseScheduleUrl(row){
    const cn = norm(row.course_number);
    if (cn) return "https://coastalcprtraining.enrollware.com/schedule#ct" + cn;
    return "https://coastalcprtraining.enrollware.com/schedule";
  }

  let rows = [];
  let selectedFamily = null;
  let query = "";

  function renderFamilies(){
    elFamilies.innerHTML = "";
    const filtered = rows.filter(r => {
      const t = (norm(r.title) + " " + norm(r.date) + " " + norm(r.location)).toLowerCase();
      return !query || t.includes(query);
    });

    if (!filtered.length){
      elFamilyEmpty.style.display = "block";
      return;
    }
    elFamilyEmpty.style.display = "none";

    const famMap = groupBy(filtered, r => r.family);
    const fams = Array.from(famMap.keys()).sort((a,b)=>a.localeCompare(b));

    for (const fam of fams){
      const pill = document.createElement("div");
      pill.className = "pill" + (fam === selectedFamily ? " active" : "");
      pill.textContent = fam;
      pill.onclick = () => { selectedFamily = fam; renderFamilies(); renderCourses(); };
      elFamilies.appendChild(pill);
    }

    if (!selectedFamily && fams.length){
      selectedFamily = fams[0];
      renderFamilies();
      renderCourses();
    }
  }

  function renderCourses(){
    elCourses.innerHTML = "";
    if (!selectedFamily){
      elCourseEmpty.style.display = "block";
      return;
    }
    elCourseEmpty.style.display = "none";

    const famRows = rows.filter(r => r.family === selectedFamily);
    const qRows = famRows.filter(r => {
      const t = (norm(r.title) + " " + norm(r.date) + " " + norm(r.location)).toLowerCase();
      return !query || t.includes(query);
    });

    if (!qRows.length){
      elCourses.innerHTML = "<div class='empty'>No matches. Try a different search.</div>";
      return;
    }

    const courseMap = groupBy(qRows, r => norm(r.title));
    const courseTitles = Array.from(courseMap.keys()).sort((a,b)=>a.localeCompare(b));

    for (const title of courseTitles){
      const items = courseMap.get(title).slice();

      items.sort((a,b)=>{
        const af = isFuture(a), bf = isFuture(b);
        if (af !== bf) return af ? -1 : 1;
        const ad = new Date(norm(a.start_iso) || 0).getTime();
        const bd = new Date(norm(b.start_iso) || 0).getTime();
        if (!isNaN(ad) && !isNaN(bd) && ad !== bd) return ad - bd;
        return norm(a.date).localeCompare(norm(b.date));
      });

      const upcoming = items.filter(isFuture);
      const show = (upcoming.length ? upcoming : items).slice(0, 6);

      let p = "";
      for (const it of items){
        const fp = fmtPrice(it.price);
        if (fp){ p = fp; break; }
      }

      const box = document.createElement("div");
      box.className = "course";
      box.innerHTML =
        "<div class='title'>" + title + "</div>" +
        "<div class='meta'>" +
          (p ? ("Typical price: " + p + " â€¢ ") : "") +
          (upcoming.length ? (upcoming.length + " upcoming sessions") : "Past-only fallback") +
        "</div>";

      for (const it of show){
        const future = isFuture(it);
        const enrollUrl = pickEnrollUrl(it);
        const schedUrl = courseScheduleUrl(it);
        const priceTxt = fmtPrice(it.price);

        const s = document.createElement("div");
        s.className = "sess";
        s.innerHTML =
          "<div class='d'>" + (norm(it.date) || "Date/time TBD") + "</div>" +
          "<div class='l'>" + (norm(it.location) || "Location TBD") + "</div>" +
          (priceTxt ? ("<div class='p'>Price: " + priceTxt + "</div>") : "") +
          "<div class='cta'></div>";

        const cta = s.querySelector(".cta");

        if (future){
          const b1 = document.createElement("a");
          b1.className = "btn btnPrimary";
          b1.href = enrollUrl;
          b1.target = "_blank";
          b1.rel = "noopener";
          b1.textContent = "Register";
          cta.appendChild(b1);
        } else {
          const b2 = document.createElement("a");
          b2.className = "btn btnWarn";
          b2.href = schedUrl;
          b2.target = "_blank";
          b2.rel = "noopener";
          b2.textContent = "Date passed";
          cta.appendChild(b2);
        }

        const b3 = document.createElement("a");
        b3.className = "btn";
        b3.href = schedUrl;
        b3.target = "_blank";
        b3.rel = "noopener";
        b3.textContent = "More dates";
        cta.appendChild(b3);

        box.appendChild(s);
      }

      elCourses.appendChild(box);
    }
  }

  async function boot(){
    try{
      const res = await fetch(SCHEDULE_URL, { cache: "no-store" });
      if (!res.ok) throw new Error("HTTP " + res.status);
      rows = await res.json();
      if (!Array.isArray(rows)) rows = [];

      rows = rows.map(r => {
        const rr = Object.assign({}, r);
        rr.title = rr.title || rr.course_name || rr.courseTitle || "";
        rr.family = rr.family || inferFamily(rr.title);
        return rr;
      });

      renderFamilies();
      renderCourses();
    }catch(err){
      elFamilyEmpty.style.display = "block";
      elFamilyEmpty.textContent = "Could not load schedule.json (" + err.message + "). Check ./data/schedule.json is published.";
    }
  }

  elQ.addEventListener("input", ()=>{
    query = norm(elQ.value).toLowerCase();
    renderFamilies();
    renderCourses();
  });

  boot();
})();
</script>

</body>
</html>

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>910CPR — Mobile Schedule</title>

  <meta name="theme-color" content="#0b4b7a" />
  <style>
    :root{
      --bg1:#ffffff;
      --bg2:#eef6ff;
      --ink:#0f172a;
      --muted:#475569;
      --line:#d9e3ef;
      --card:#ffffff;
      --shadow: 0 10px 26px rgba(15,23,42,.10);
      --brand:#0b4b7a;
      --pill:#e8f2ff;
      --pillInk:#0b4b7a;
      --cta:#0f7a3a;
      --radius:18px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--ink);
      background: radial-gradient(1100px 520px at 18% 55%, rgba(11,75,122,.12), transparent 55%),
                  linear-gradient(180deg, var(--bg1), var(--bg2));
      min-height:100vh;
      -webkit-font-smoothing: antialiased;
    }
    a{ color:inherit; text-decoration:none; }

    /* “App” header */
    .appbar{
      position:sticky;
      top:0;
      z-index:50;
      padding: 10px 12px 12px;
      background: rgba(255,255,255,.82);
      backdrop-filter: blur(12px);
      border-bottom:1px solid var(--line);
    }
    .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .brand{
      display:flex; align-items:center; gap:10px; min-width:0;
    }
    .logo{
      width:40px; height:40px; border-radius:12px;
      border:1px solid rgba(11,75,122,.25);
      background: linear-gradient(135deg, rgba(11,75,122,.16), rgba(11,75,122,.04));
      display:flex; align-items:center; justify-content:center;
      overflow:hidden;
      flex:0 0 auto;
    }
    .logo img{ width:100%; height:100%; object-fit:contain; padding:6px; }
    .titleWrap{ min-width:0; }
    .title{
      margin:0;
      font-weight:950;
      font-size:14px;
      line-height:1.15;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .sub{
      margin:3px 0 0;
      color:var(--muted);
      font-size:11px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .pillBtn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      font-weight:900;
      font-size:12px;
      white-space:nowrap;
      box-shadow: 0 2px 0 rgba(15,23,42,.06);
    }
    .pillBtn.cta{
      border-color: rgba(15,122,58,.35);
      background: linear-gradient(180deg, rgba(15,122,58,.18), rgba(15,122,58,.06));
      color:#064a1f;
    }

    /* content */
    .wrap{ padding: 12px; padding-bottom: 18px; }

    .card{
      background: rgba(255,255,255,.86);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .sectionHd{
      padding:12px 12px 10px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, rgba(11,75,122,.06), transparent);
    }
    .sectionHd .kicker{
      margin:0;
      font-weight:950;
      font-size:13px;
    }
    .sectionHd .hint{
      margin:6px 0 0;
      color:var(--muted);
      font-size:12px;
      line-height:1.25;
    }

    .search{
      padding:10px 12px 12px;
      border-bottom:1px solid var(--line);
      background:rgba(255,255,255,.7);
    }
    input[type="search"]{
      width:100%;
      padding:10px 12px;
      border-radius: 12px;
      border:1px solid var(--line);
      outline:none;
      font-size:14px;
      background:#fff;
    }

    .chips{
      display:flex; gap:10px;
      padding:10px 12px 12px;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      border-bottom:1px solid var(--line);
      background: rgba(255,255,255,.72);
    }
    .chip{
      flex:0 0 auto;
      padding:10px 12px;
      border-radius: 999px;
      border:1px solid rgba(11,75,122,.20);
      background: var(--pill);
      color: var(--pillInk);
      font-weight:950;
      font-size:12px;
      display:inline-flex;
      gap:8px;
      align-items:center;
    }
    .chip.active{
      background: rgba(11,75,122,.14);
      border-color: rgba(11,75,122,.45);
    }
    .chip .count{
      background:#fff;
      border:1px solid rgba(11,75,122,.18);
      padding:4px 8px;
      border-radius:999px;
      font-size:11px;
    }

    .badgeRow{
      padding:10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid var(--line);
      background: rgba(255,255,255,.75);
    }
    .badge{
      font-weight:950;
      font-size:12px;
      color: var(--pillInk);
      background: var(--pill);
      border:1px dashed rgba(11,75,122,.26);
      padding:8px 10px;
      border-radius:999px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 70%;
    }

    .list{
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    details.course{
      border:1px solid var(--line);
      border-radius: 18px;
      background: rgba(255,255,255,.92);
      overflow:hidden;
      box-shadow: 0 6px 16px rgba(15,23,42,.06);
    }
    summary.course-sum{
      list-style:none;
      cursor:pointer;
      padding:12px;
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      background: linear-gradient(180deg, rgba(11,75,122,.08), rgba(11,75,122,.03));
      border-bottom:1px solid var(--line);
    }
    summary.course-sum::-webkit-details-marker{ display:none; }
    .c-left{ min-width:0; }
    .c-title{
      margin:0;
      font-weight:950;
      font-size:14px;
      line-height:1.2;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .c-sub{
      margin:5px 0 0;
      font-size:12px;
      color:var(--muted);
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .c-chip{
      font-weight:950;
      font-size:12px;
      border:1px solid rgba(11,75,122,.20);
      padding:6px 10px;
      border-radius:999px;
      background: rgba(255,255,255,.85);
      color: var(--brand);
      white-space:nowrap;
      flex:0 0 auto;
    }

    .session{
      padding:12px;
      border-top:1px solid var(--line);
      background: rgba(255,255,255,.96);
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    /* FIX: real values only */
    .s-dt{
      margin:0;
      font-weight:950;
      font-size:14px;
      line-height:1.25;
    }
    .s-loc{
      margin:0;
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .ctaBtn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:100%;
      padding:12px 12px;
      border-radius:999px;
      border:1px solid rgba(15,122,58,.35);
      background: linear-gradient(180deg, rgba(15,122,58,.18), rgba(15,122,58,.07));
      color:#064a1f;
      font-weight:950;
      box-shadow: 0 2px 0 rgba(0,0,0,.06);
    }

    .empty{ padding:14px 12px; color:var(--muted); font-size:13px; }
    .footer{
      margin-top:12px;
      padding:10px 6px 16px;
      text-align:center;
      color:rgba(71,85,105,.95);
      font-size:12px;
    }

    .corner{
      position:fixed;
      right:14px;
      bottom:12px;
      width:82px;
      height:82px;
      opacity:.10;
      pointer-events:none;
      filter: grayscale(100%);
    }
    .corner img{ width:100%; height:100%; object-fit:contain; }
  </style>
</head>

<body>
  <header class="appbar">
    <div class="row">
      <div class="brand">
        <div class="logo">
          <img src="./images/910cpr_round.png" alt="910CPR Logo" onerror="this.style.display='none'">
        </div>
        <div class="titleWrap">
          <p class="title">910CPR Schedule</p>
          <p class="sub">Tap a family → expand a course → register</p>
        </div>
      </div>
      <a class="pillBtn cta" href="tel:+19103955193">Call/Text</a>
    </div>

    <div class="row" style="margin-top:10px;">
      <a class="pillBtn" href="./index.html">Desktop view</a>
      <a class="pillBtn" href="mailto:info@910cpr.com">Email</a>
      <a class="pillBtn" href="https://910cpr.com/group" rel="noopener">Group Quote</a>
    </div>
  </header>

  <main class="wrap">
    <section class="card">
      <div class="sectionHd">
        <p class="kicker">Pick your class family</p>
        <p class="hint">Upcoming sessions first. No clutter. No “Date/Time” labels — just the actual date &amp; time.</p>
      </div>

      <div class="search">
        <input id="familySearch" type="search" placeholder="Search families (BLS, ACLS, Heartsaver...)" autocomplete="off" />
      </div>

      <div id="chips" class="chips">
        <div class="empty">Loading…</div>
      </div>

      <div class="badgeRow">
        <div id="badge" class="badge">Showing upcoming sessions</div>
        <a id="seeAll" class="pillBtn" href="#" rel="noopener">See all</a>
      </div>

      <div id="list" class="list">
        <div class="empty">Loading…</div>
      </div>
    </section>

    <div class="footer">
      © <span id="yr"></span> 910CPR
    </div>
  </main>

  <div class="corner" aria-hidden="true">
    <img src="./images/910cpr_wave.png" alt="" onerror="this.style.display='none'">
  </div>

  <script>
    (function(){
      const $ = (id)=>document.getElementById(id);
      $("yr").textContent = new Date().getFullYear();

      const chipsEl = $("chips");
      const listEl = $("list");
      const badgeEl = $("badge");
      const seeAllEl = $("seeAll");
      const familySearchEl = $("familySearch");

      let sessions = [];
      let families = [];
      let activeFamily = null;

      const s = (v)=> (v==null ? "" : String(v)).trim();

      function extractArray(payload){
        if (Array.isArray(payload)) return payload;
        const keys = ["sessions","classes","items","data","events"];
        for (const k of keys){
          if (payload && Array.isArray(payload[k])) return payload[k];
        }
        if (payload && Array.isArray(payload.upcoming)) return payload.upcoming;
        return [];
      }

      function toDateObj(item){
        const candidates = [
          item.datetime, item.dateTime, item.start, item.startTime, item.start_datetime,
          item.classDateTime, item.sessionDateTime
        ].map(s).filter(Boolean);

        for (const c of candidates){
          const d = new Date(c);
          if (!isNaN(d.getTime())) return d;
        }

        const dateStr = s(item.date || item.classDate || item.sessionDate || item.day);
        const timeStr = s(item.time || item.classTime || item.sessionTime || item.start_time);

        if (dateStr && timeStr){
          const d = new Date(dateStr + " " + timeStr);
          if (!isNaN(d.getTime())) return d;
        }
        if (dateStr){
          const d = new Date(dateStr);
          if (!isNaN(d.getTime())) return d;
        }
        return null;
      }

      function fmtDateTime(d){
        const datePart = d.toLocaleDateString(undefined, { weekday:"short", month:"short", day:"numeric" });
        const timePart = d.toLocaleTimeString(undefined, { hour:"numeric", minute:"2-digit" });
        return `${datePart} · ${timePart}`;
      }

      function fmtEndTimeMaybe(item, startDate){
        const endRaw = s(item.end || item.endTime || item.end_time);
        if (!endRaw) return "";
        let d = new Date(endRaw);
        if (isNaN(d.getTime()) && startDate){
          d = new Date(startDate.toDateString() + " " + endRaw);
        }
        if (isNaN(d.getTime())) return "";
        return d.toLocaleTimeString(undefined, { hour:"numeric", minute:"2-digit" });
      }

      function courseKey(item){
        return s(item.courseKey || item.course_id || item.courseId || item.course || item.course_name || item.title || item.name) || "Other";
      }
      function courseTitle(item){
        return s(item.courseTitle || item.course_title || item.title || item.name || item.course_name || item.course) || "Class";
      }
      function courseSubtitle(item){
        return s(item.subtitle || item.description || item.courseDescription || item.course_desc || item.sub) || "";
      }

      function familyKey(item){
        const direct = s(item.family || item.category || item.group || item.track);
        if (direct) return direct;

        const t = courseTitle(item).toUpperCase();
        const picks = [
          ["ACLS","ACLS"],
          ["BLS","BLS"],
          ["PALS","PALS"],
          ["HEARTSAVER","Heartsaver / CPR-AED"],
          ["FIRST AID","Heartsaver / CPR-AED"],
          ["OSHA","OSHA / Workplace"],
          ["USCG","USCG / Maritime"],
          ["RED CROSS","Red Cross"],
          ["HSI","HSI"]
        ];
        for (const [needle, label] of picks){
          if (t.includes(needle)) return label;
        }
        return "All";
      }

      function isUpcoming(item){
        const d = toDateObj(item);
        if (!d) return true;
        const now = new Date();
        return d.getTime() >= (now.getTime() - 1000*60*60*6);
      }

      function locationLine(item){
        const friendly = s(item.location_display || item.locationDisplay || item.locationText);
        if (friendly) return friendly;

        const city = s(item.city || item.town || item.locationCity);
        const state = s(item.state || item.locationState);
        const addr = s(item.address || item.addr || item.street);
        const place = s(item.locationShort || item.location_short || item.locationName || item.location || item.venue);

        const parts = [];
        if (city) parts.push(state ? `${city}, ${state}` : city);
        if (addr) parts.push(addr);
        if (place && !addr) parts.push(place);
        if (parts.length) return parts.join(" — ");
        return place || "Location on registration page";
      }

      function registerUrl(item){
        return s(item.enroll_url || item.enrollUrl || item.register_url || item.registerUrl || item.url || item.link);
      }

      function scheduleUrlForFamily(){
        return "https://910cpr.com/schedule";
      }

      function computeFamilies(items){
        const map = new Map();
        for (const it of items){
          const k = familyKey(it);
          map.set(k, (map.get(k)||0) + 1);
        }
        const arr = Array.from(map.entries()).map(([key,count])=>({ key, count }));
        const order = ["ACLS","BLS","PALS","Heartsaver / CPR-AED","HSI","Red Cross","OSHA / Workplace","USCG / Maritime","All"];
        arr.sort((a,b)=>{
          const ai = order.indexOf(a.key);
          const bi = order.indexOf(b.key);
          if (ai !== -1 || bi !== -1){
            return (ai === -1 ? 999 : ai) - (bi === -1 ? 999 : bi);
          }
          return a.key.localeCompare(b.key);
        });
        return arr;
      }

      function groupCourses(items){
        const map = new Map();
        for (const it of items){
          const ck = courseKey(it);
          if (!map.has(ck)){
            map.set(ck, { key: ck, title: courseTitle(it), sub: courseSubtitle(it), sessions: [] });
          }
          map.get(ck).sessions.push(it);
        }
        const arr = Array.from(map.values());
        for (const c of arr){
          c.sessions.sort((a,b)=>{
            const da = toDateObj(a); const db = toDateObj(b);
            return (da?da.getTime():0) - (db?db.getTime():0);
          });
        }
        arr.sort((a,b)=>{
          const na = a.sessions.find(isUpcoming) || a.sessions[0];
          const nb = b.sessions.find(isUpcoming) || b.sessions[0];
          const da = toDateObj(na); const db = toDateObj(nb);
          return (da?da.getTime():0) - (db?db.getTime():0);
        });
        return arr;
      }

      function escapeHtml(str){
        return String(str ?? "")
          .replaceAll("&","&amp;")
          .replaceAll("<","&lt;")
          .replaceAll(">","&gt;")
          .replaceAll('"',"&quot;")
          .replaceAll("'","&#039;");
      }
      function escapeAttr(str){
        return escapeHtml(str).replaceAll("`","&#096;");
      }

      function renderChips(){
        const q = s(familySearchEl.value).toLowerCase();
        const filtered = families.filter(f => !q || f.key.toLowerCase().includes(q));
        chipsEl.innerHTML = "";

        if (!filtered.length){
          chipsEl.innerHTML = `<div class="empty">No matching families.</div>`;
          return;
        }

        filtered.forEach(f=>{
          const div = document.createElement("div");
          div.className = "chip" + (f.key === activeFamily ? " active" : "");
          div.innerHTML = `${escapeHtml(f.key)} <span class="count">${f.count}</span>`;
          div.addEventListener("click", ()=>{
            activeFamily = f.key;
            renderChips();
            renderList();
          });
          chipsEl.appendChild(div);
        });
      }

      function renderList(){
        const base = sessions.filter(isUpcoming);
        const subset = (!activeFamily || activeFamily === "All") ? base : base.filter(it => familyKey(it) === activeFamily);

        badgeEl.textContent = activeFamily && activeFamily !== "All"
          ? `Upcoming: ${activeFamily}`
          : `Upcoming sessions`;

        seeAllEl.href = scheduleUrlForFamily(activeFamily);

        const courses = groupCourses(subset);
        listEl.innerHTML = "";

        if (!courses.length){
          listEl.innerHTML = `<div class="empty">No upcoming sessions found for this family.</div>`;
          return;
        }

        courses.forEach((c, idx)=>{
          const det = document.createElement("details");
          det.className = "course";
          if (idx === 0) det.open = true;

          const sum = document.createElement("summary");
          sum.className = "course-sum";
          sum.innerHTML = `
            <div class="c-left">
              <p class="c-title" title="${escapeAttr(c.title)}">${escapeHtml(c.title)}</p>
              <p class="c-sub" title="${escapeAttr(c.sub)}">${escapeHtml(c.sub || "Expand to see dates & locations")}</p>
            </div>
            <div class="c-chip">${c.sessions.length} dates</div>
          `;

          const body = document.createElement("div");

          c.sessions.forEach(it=>{
            const d = toDateObj(it);
            const dtLine = d ? fmtDateTime(d) : (s(it.date_text || it.dateText || it.when) || "Date/time on registration page");
            const endMaybe = d ? fmtEndTimeMaybe(it, d) : "";
            const dtFull = endMaybe ? `${dtLine} – ${endMaybe}` : dtLine;

            const loc = locationLine(it);
            const url = registerUrl(it);

            const row = document.createElement("div");
            row.className = "session";

            // *** IMPORTANT: real values only; no labels. ***
            row.innerHTML = `
              <p class="s-dt">${escapeHtml(dtFull)}</p>
              <p class="s-loc">${escapeHtml(loc)}</p>
              ${url ? `<a class="ctaBtn" href="${escapeAttr(url)}" rel="noopener">Register now</a>` : `<div class="ctaBtn" style="opacity:.55;">Register</div>`}
            `;
            body.appendChild(row);
          });

          det.appendChild(sum);
          det.appendChild(body);
          listEl.appendChild(det);
        });
      }

      async function load(){
        try{
          const res = await fetch("./data/schedule.json", { cache: "no-store" });
          if (!res.ok) throw new Error("HTTP " + res.status);
          const payload = await res.json();
          sessions = extractArray(payload);

          if (!sessions.length){
            chipsEl.innerHTML = `<div class="empty">Schedule loaded, but no sessions were found in schedule.json.</div>`;
            listEl.innerHTML = `<div class="empty">No sessions found.</div>`;
            return;
          }

          const upcoming = sessions.filter(isUpcoming);
          families = computeFamilies(upcoming);
          activeFamily = families.find(f=>f.key!=="All")?.key || "All";

          renderChips();
          renderList();
        }catch(err){
          chipsEl.innerHTML = `<div class="empty">Couldn’t load schedule.json.</div>`;
          listEl.innerHTML = `<div class="empty">Error loading schedule: ${escapeHtml(err.message || String(err))}</div>`;
        }
      }

      familySearchEl.addEventListener("input", renderChips);

      load();
    })();
  </script>
</body>
</html>
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>910CPR – Courses & Schedule</title>

<!-- GA4 -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-45PBWBK7KR"></script>
<script>
  window.dataLayer=window.dataLayer||[];
  function gtag(){dataLayer.push(arguments)}
  gtag('js',new Date()); gtag('config','G-45PBWBK7KR');
</script>

<!-- GTM -->
<script>
(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});
var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';
j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-K58Z4XD');
</script>
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-K58Z4XD" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>

<style>
:root{
  --ink:#0a1b2b; --bg:#f6f9fc; --card:#fff; --edge:#dce9f7; --hover:#f3f8ff;
  --bannerTop:#32415f; --bannerBot:#27354e; --bannerText:#f4f7fb;
}
*{box-sizing:border-box}
body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:var(--bg);color:var(--ink)}
.wrap{max-width:1100px;margin:auto;padding:20px}
.status{margin:0;padding:10px 16px;font-size:14px;border-bottom:1px solid var(--edge)}
.status.ok{background:#e8f7ee;color:#0a7d27;border-bottom-color:#cfe8d7}
.status.err{background:#fde9ec;color:#b00020;border-bottom-color:#f3c7cf}
.status .path{opacity:.8;font-family:ui-monospace,Menlo,Consolas,monospace}

/* Top-level placeholder headers (NEVER links) */
details.section{margin:12px 0;border-radius:12px;box-shadow:0 3px 10px rgba(0,0,0,.05);
  background:var(--card);border:1px solid var(--edge);overflow:hidden}
details.section>summary{cursor:pointer;list-style:none;padding:0}
.section-body{padding:14px 18px}
.ph-head{display:block;padding:14px 18px;border-bottom:1px solid var(--edge);
  background:linear-gradient(180deg,var(--bannerTop),var(--bannerBot));color:var(--bannerText)}
.ph-head .ph-title{font-weight:800;font-size:1.1rem}
.ph-head .ph-sub{font-size:12px;opacity:.9;margin-top:6px}
/* ensure placeholder header text can’t look “clickable link blue” */
.ph-head a{color:inherit;text-decoration:none;pointer-events:none}
.ph-head a[href]{cursor:default}

/* Mid-level courses */
details.course{margin:12px 0;border-radius:12px;border:1px solid var(--edge);
  background:var(--card);overflow:hidden}
details.course>summary{list-style:none;cursor:pointer;font-weight:700;padding:12px 16px;
  background:linear-gradient(180deg,#ffffff,#f7fbff);border-bottom:1px solid var(--edge)}
details.course[open]>summary{background:#f0f6ff}
details.course .body{padding:14px 16px}
.title-link{color:inherit;text-decoration:none}
.title-link:hover{text-decoration:underline}
.meta{font-size:12px;color:#466;margin:8px 0 0}
.btn{display:inline-block;margin-top:10px;border:1px solid var(--edge);border-radius:8px;
  padding:8px 12px;text-decoration:none;color:#0b66c3;background:var(--card)}

/* Imported Enrollware list */
.enrclass-list{list-style:none;padding:0;margin:12px 0}
.enrclass-list li{margin:6px 0}
.enrclass-list a{display:flex;flex-direction:column;gap:4px;border:1px solid var(--edge);
  border-radius:10px;padding:8px 10px;text-decoration:none;color:var(--ink);background:var(--card)}
.enrclass-list a:hover{background:var(--hover);border-color:#b9d6f9}
</style>
</head>

<body>
<div id="dbg" class="status">Loading…</div>
<div class="wrap"><h1>910CPR Courses & Schedule</h1></div>

<script>
const ENR_ORIGIN='https://coastalcprtraining.enrollware.com';
const isCt=id=>typeof id==='string' && /^ct\d{3,}$/i.test(id);
const ctHref=id=>`${ENR_ORIGIN}/schedule#${encodeURIComponent(id)}`;
const linkedTitle=(titleHTML,id)=>isCt(id)?`<a class="title-link" href="${ctHref(id)}">${titleHTML}</a>`:titleHTML;

/* Convert relative links/imgs inside fragments to absolute to Enrollware */
function absolutizeUrls(frag){
  frag.querySelectorAll('img,a').forEach(el=>{
    const attr=el.tagName==='IMG'?'src':'href';
    const v=el.getAttribute(attr); if(!v) return;
    if(/^https?:\/\//i.test(v)) return;
    const abs=v.startsWith('/') ? ENR_ORIGIN+v : ENR_ORIGIN+'/'+v.replace(/^\.?\//,'');
    el.setAttribute(attr,abs);
  });
  return frag;
}

/* Strip <a> from placeholder headings so they cannot link out */
function stripLinks(el){
  el.querySelectorAll('a').forEach(a=>{
    const span=document.createElement('span');
    span.innerHTML=a.innerHTML;
    a.replaceWith(span);
  });
  return el;
}

/* Find a ct##### anchor near/for this panel (several strategies) */
function getCtId(panel,root){
  // 1) direct anchor/name inside the panel
  let a=panel.querySelector('[id^="ct"],[name^="ct"]');
  if(a && isCt(a.id||a.getAttribute('name'))) return a.id||a.getAttribute('name');

  // 2) any link inside the panel already pointing to #ct
  const deepLink=panel.querySelector('a[href*="#ct"]');
  if(deepLink){
    const m=(deepLink.getAttribute('href')||'').match(/#(ct\d{3,})/i);
    if(m && isCt(m[1])) return m[1];
  }

  // 3) scan a few previous siblings
  let prev=panel.previousElementSibling;
  for(let i=0;i<8 && prev;i++){
    if(prev.matches?.('[id^="ct"],[name^="ct"]')){
      const id=prev.id||prev.getAttribute('name')||'';
      if(isCt(id)) return id;
    }
    const inner=prev.querySelector?.('[id^="ct"],[name^="ct"]');
    if(inner){
      const id=inner.id||inner.getAttribute('name')||'';
      if(isCt(id)) return id;
    }
    prev=prev.previousElementSibling;
  }

  // 4) walk the tree from root up to this panel and remember last ct#### seen
  const walker=document.createTreeWalker(root, NodeFilter.SHOW_ELEMENT, null);
  let last=''; while(walker.nextNode()){
    const el=walker.currentNode;
    if(el===panel) break;
    const id=el.id || el.getAttribute?.('name') || '';
    if(isCt(id)) last=id;
  }
  return last; // '' if none
}

function parseDateFromText(t){
  if(!t) return null;
  const s=String(t).replace(/\u00A0/g,' ').trim();
  const re=/^(?:[A-Za-z]+,\s*)?([A-Za-z]+)\s+(\d{1,2}),\s*(\d{4})\s+at\s+(\d{1,2}):(\d{2})\s*(AM|PM)/i;
  const m=s.match(re); if(!m) return null;
  const months={january:0,february:1,march:2,april:3,may:4,june:5,july:6,august:7,september:8,october:9,november:10,december:11};
  const mon=months[m[1].toLowerCase()]; if(mon==null) return null;
  let hr=+m[4],min=+m[5]; const ap=m[6].toUpperCase();
  if(ap==='PM'&&hr<12) hr+=12; if(ap==='AM'&&hr===12) hr=0;
  return new Date(+m[3],mon,+m[2],hr,min);
}

/* Trim to ~4 weeks / 10 items */
function limitUlToWindow(ul,maxDays=28,maxItems=10){
  if(!ul) return {ul,kept:0,total:0};
  const cutoff=new Date(); cutoff.setDate(cutoff.getDate()+maxDays);
  const lis=[...ul.querySelectorAll(':scope>li')];
  let kept=0,total=0;
  for(const li of lis){
    total++;
    const a=li.querySelector('a');
    const txt=(a?.textContent||li.textContent||'').trim();
    const dt=parseDateFromText(txt);
    const keep = (!dt) || (dt && dt<=cutoff && kept<maxItems);
    if(keep){ kept++; } else { li.remove(); }
  }
  return {ul,kept,total};
}

function wireCurtains(){
  document.querySelectorAll('details.section').forEach(sec=>{
    sec.addEventListener('toggle',()=>{
      if(sec.open){
        document.querySelectorAll('details.section').forEach(d=>{ if(d!==sec) d.open=false; });
        window.scrollTo({top:sec.getBoundingClientRect().top + window.scrollY - 12, behavior:'smooth'});
      }
    });
  });
  document.querySelectorAll('details.course').forEach(sub=>{
    sub.addEventListener('toggle',()=>{
      if(sub.open){
        window.scrollTo({top:sub.getBoundingClientRect().top + window.scrollY - 12, behavior:'smooth'});
      }
    });
  });
}

/* Load the static snapshot (must be committed to your repo) */
async function loadSnapshotHTML(){
  const here = location.pathname;
  const base = here.replace(/[^/]+$/,'');
  const tryPaths = [
    base + 'data/enrollware-schedule.html',
    '/ew2landers/data/enrollware-schedule.html'
  ];
  const tried=[];
  for(const url of tryPaths){
    try{
      const res=await fetch(url,{mode:'same-origin',credentials:'omit',cache:'no-cache'});
      if(res.ok){ return { html: await res.text(), url, tried }; }
      tried.push(url+' ('+res.status+')');
    }catch(e){ tried.push(url+' (fetch error)'); }
  }
  return { html:null, url:null, tried };
}

/* MAIN */
document.addEventListener('DOMContentLoaded', async()=>{
  const dbg=document.getElementById('dbg');
  const host=document.querySelector('.wrap');

  const load=await loadSnapshotHTML();
  if(!load.html){
    dbg.className='status err';
    dbg.innerHTML = `<strong>Could not load schedule snapshot.</strong><br/>
      <span class="path">Expected at docs/data/enrollware-schedule.html</span>`;
    console.error('Snapshot load failed. Tried:', load.tried || []);
    return;
  }

  const root=document.createElement('div'); root.innerHTML=load.html;
  const panels=[...root.querySelectorAll('.enrpanel')];
  if(!panels.length){
    dbg.className='status err';
    dbg.textContent='Found snapshot, but no .enrpanel elements. Check your saved HTML.';
    console.warn('No .enrpanel in snapshot at', load.url);
    return;
  }

  const sections=[]; let current=null;
  panels.forEach((p, idx)=>{
    const headingEl=p.querySelector('.enrpanel-heading,h1,h2,h3,h4');
    if(!headingEl) return;
    const headingFrag=headingEl.cloneNode(true);
    absolutizeUrls(headingFrag);

    // STRIP LINKS for placeholder heading (will apply if we choose it as placeholder)
    stripLinks(headingFrag);

    const titleHTML=headingFrag.innerHTML.trim();

    const bodyEl=p.querySelector('.enrpanel-body');
    const descClone=bodyEl?bodyEl.cloneNode(true):null;
    if(descClone){
      const u=descClone.querySelector('ul.enrclass-list');
      if(u) u.remove();          // remove schedule list from description clone
      absolutizeUrls(descClone); // fix relative URLs
    }
    const descHTML=descClone?(descClone.innerHTML||'').trim():'';

    const ul=p.querySelector('ul.enrclass-list');
    const hasDates=!!ul;

    if(!hasDates){
      // start a new section (placeholder header)
      current={ header:{titleHTML,descHTML}, courses:[] };
      sections.push(current);
      return;
    }

    // course panel
    if(!current){
      // If there's no placeholder yet, create a generic section
      current={ header:{titleHTML:'Courses',descHTML:''}, courses:[] };
      sections.push(current);
    }

    const ulClone=ul.cloneNode(true);
    absolutizeUrls(ulClone);
    const trimmed=limitUlToWindow(ulClone,28,10);
    const ctId=getCtId(p, root);
    current.courses.push({
      id: ctId, titleHTML, descHTML,
      ul: trimmed.ul, kept: trimmed.kept, total: trimmed.total
    });
  });

  // Render
  host.innerHTML = `<h1>910CPR Courses & Schedule</h1>
                    <p class="path">Snapshot: ${load.url || ''}</p>`;

  sections.forEach((sec, sIdx)=>{
    const secEl=document.createElement('details'); secEl.className='section';
    secEl.innerHTML=`
      <summary>
        <div class="ph-head">
          <div class="ph-title">${sec.header.titleHTML}</div>
          ${sec.header.descHTML?`<div class="ph-sub">${sec.header.descHTML}</div>`:''}
        </div>
      </summary>
      <div class="section-body"></div>`;
    const body=secEl.querySelector('.section-body');

    sec.courses.forEach((c, cIdx)=>{
      const course=document.createElement('details'); course.className='course';
      const titleLinked=linkedTitle(c.titleHTML,c.id);
      const url=isCt(c.id)?ctHref(c.id):`${ENR_ORIGIN}/schedule`;
      const hint = (c.total>c.kept)
        ? `<div class="meta">Showing ${c.kept} of ${c.total} upcoming (~4 weeks). <a class="btn" href="${url}">See all dates</a></div>`
        : `<div class="meta">All upcoming shown. <a class="btn" href="${url}">See all dates</a></div>`;

      course.innerHTML=`
        <summary>${titleLinked}</summary>
        <div class="body">
          <div class="desc">${c.descHTML}</div>
          <ul class="enrclass-list"></ul>
          ${hint}
        </div>`;
      course.querySelector('.enrclass-list').replaceWith(c.ul);
      body.appendChild(course);
    });

    host.appendChild(secEl);
  });

  dbg.className='status ok';
  dbg.innerHTML = `Rendered ${sections.length} top-level sections. 
    <span class="path">(${panels.length} panels parsed)</span>`;

  console.table(sections.map((s,i)=>({
    section:i+1,
    headerText: s.header.titleHTML.replace(/<[^>]+>/g,'').slice(0,80),
    courses: s.courses.length
  })));
  wireCurtains();
});
</script>

<!-- Voice widget -->
<embeddable-voice id="1cf9bf8f-38da-437e-abfb-efa1ce9a02ff"></embeddable-voice>
<script src="https://cdn.247aireceptionist.com/script.js"></script>
</body>
</html>

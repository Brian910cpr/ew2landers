<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>910CPR — Schedule</title>

  <style>
    :root{
      --bg1:#ffffff;
      --bg2:#eaf4ff;
      --card:#ffffff;
      --ink:#0b1b2a;
      --muted:#5b6b7a;
      --line:#d7e3f0;
      --brand:#0b5fa5;
      --shadow: 0 10px 30px rgba(10,35,60,.10);
      --radius:16px;
      --max: 1200px;
      --headerH: 64px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--ink);
      background: linear-gradient(180deg,var(--bg1),var(--bg2));
    }
    a{ color:inherit; }
    .wrap{ max-width: var(--max); margin:0 auto; padding: 18px; }

    /* HEADER */
    .topbar{
      position: sticky;
      top:0;
      z-index: 50;
      background: rgba(255,255,255,.85);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--line);
    }
    .topbar-inner{
      height: var(--headerH);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      max-width: var(--max);
      margin:0 auto;
      padding: 0 18px;
    }
    .brand{
      display:flex;
      flex-direction:column;
      line-height:1.15;
      min-width:0;
    }
    .brand strong{
      font-size: 16px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 64vw;
    }
    .brand span{ font-size: 12px; color:var(--muted); }

    .top-actions{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .btn{
      border:1px solid var(--line);
      background:#fff;
      border-radius: 999px;
      padding: 10px 12px;
      font-size: 13px;
      text-decoration:none;
      box-shadow: 0 1px 0 rgba(10,35,60,.04);
      white-space:nowrap;
    }
    .btn.primary{
      border-color: transparent;
      background: var(--brand);
      color:#fff;
    }

    /* LAYOUT */
    .layout{
      display:grid;
      grid-template-columns: 320px 1fr;
      gap: 18px;
      align-items:start;
      margin-top: 18px;
    }

    /* LEFT RAIL */
    .rail{
      background: var(--card);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
    }
    @media (min-width: 980px){
      .rail{
        position: sticky;
        top: calc(var(--headerH) + 18px);
        max-height: calc(100vh - (var(--headerH) + 36px));
        overflow:auto;
      }
    }

    .rail h3{
      margin: 4px 0 10px;
      font-size: 14px;
      letter-spacing:.2px;
    }
    .search{
      width:100%;
      border:1px solid var(--line);
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 14px;
      outline:none;
    }
    .family-list{ margin-top: 12px; display:flex; flex-direction:column; gap:10px; }
    .family{
      border:1px solid var(--line);
      border-radius: 14px;
      padding: 10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      cursor:pointer;
      background:#fff;
      user-select:none;
      transition: transform .04s ease, background .1s ease;
    }
    .family:hover{ background:#f7fbff; }
    .family:active{ transform: scale(.995); }
    .family.active{
      border-color: #b9d3ee;
      background:#eef6ff;
    }
    .family .meta{ display:flex; flex-direction:column; gap:2px; }
    .family .meta strong{ font-size: 14px; }
    .family .meta small{ font-size: 12px; color:var(--muted); }
    .badge{
      min-width: 44px;
      text-align:center;
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid var(--line);
      font-weight: 700;
      font-size: 13px;
      color:#123;
      background: #f4f8fd;
    }

    /* MAIN */
    .main{ display:flex; flex-direction:column; gap: 14px; }
    .panel{
      background: var(--card);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
    }
    .panel h2{ margin: 0 0 8px; font-size: 16px; }
    .hint{ margin:0; font-size: 13px; color: var(--muted); line-height:1.35; }

    .notice{
      background:#f7fbff;
      border:1px dashed #c7d9ee;
      border-radius: 14px;
      padding: 10px 12px;
      color:#18314a;
      font-size: 13px;
      line-height:1.35;
    }
    .error{
      background:#fff5f1;
      border:1px solid #ffd2c1;
      border-radius: 14px;
      padding: 12px 12px;
      color:#5b1f0b;
      font-size: 13px;
      line-height:1.35;
    }

    /* COURSE CARDS */
    .course{
      border:1px solid var(--line);
      border-radius: var(--radius);
      overflow:hidden;
      background:#fff;
    }
    .course-head{
      padding: 12px 14px;
      background: linear-gradient(90deg, #083b64, #0b5fa5);
      color:#fff;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
    }

    /* Title block: allow HTML (icons) + keep clean */
    .course-title{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:0;
    }
    .course-title .titleLine{
      font-size: 15px;
      font-weight: 800;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      display:flex;
      align-items:center;
      gap:8px;
      min-width:0;
    }
    .course-title .titleLine img{
      height: 18px;
      width: auto;
      vertical-align: middle;
      border-radius: 4px;
      background: rgba(255,255,255,.12);
      flex: 0 0 auto;
    }
    .course-title .subLine{
      font-size: 12px;
      opacity:.9;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* Minimal right cluster: SHOW 5 + More dates */
    .course-head-right{
      display:flex;
      align-items:center;
      gap:10px;
      flex: 0 0 auto;
    }
    .pillBtn{
      background: rgba(255,255,255,.14);
      border: 1px solid rgba(255,255,255,.28);
      color:#fff;
      padding: 8px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 900;
      letter-spacing:.4px;
      text-transform:uppercase;
      cursor:pointer;
      white-space:nowrap;
      user-select:none;
    }
    .pillBtn:hover{ background: rgba(255,255,255,.20); }
    .pillLink{
      background: rgba(255,255,255,.14);
      border: 1px solid rgba(255,255,255,.22);
      padding: 8px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight:700;
      text-decoration:none;
      white-space:nowrap;
      color:#fff;
    }
    .pillLink:hover{ background: rgba(255,255,255,.20); }

    .course-body{ padding: 12px 14px; }

    .sessions{ display:flex; flex-direction:column; gap:10px; }
    .session{
      border:1px solid var(--line);
      border-radius: 14px;
      padding: 10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .session .when{
      display:flex; flex-direction:column; gap:2px;
      min-width:0;
    }
    .session .when strong{ font-size: 13px; }
    .session .when small{
      font-size: 12px; color: var(--muted);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      max-width: 520px;
    }
    .reg{
      background: #0c6b52;
      color:#fff;
      border:0;
      padding: 10px 14px;
      border-radius: 999px;
      font-weight:800;
      text-decoration:none;
      white-space:nowrap;
    }

    /* RESPONSIVE */
    @media (max-width: 979px){
      .layout{ grid-template-columns: 1fr; }
      .session .when small{ max-width: 60vw; }
      .course-head-right{ gap:8px; }
      .pillBtn, .pillLink{ padding: 7px 9px; font-size: 11px; }
    }
  </style>
</head>

<body>
  <header class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <strong>CPR, BLS, ACLS &amp; First Aid — Wilmington / Burgaw</strong>
        <span>Live &amp; blended classes with fast certificates — powered by 910CPR</span>
      </div>

      <div class="top-actions">
        <a class="btn" href="./index-mobile.html">Mobile view</a>
        <a class="btn primary" href="tel:+19103955193">Call or text (910) 395-5193</a>
        <a class="btn" href="mailto:info@910cpr.com">Email 910CPR</a>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section class="layout">

      <aside class="rail">
        <h3>Step 1: Choose a class family</h3>
        <input id="familySearch" class="search" placeholder="Search (BLS, ACLS, Heartsaver, OSHA…)" />
        <div id="familyList" class="family-list"></div>
      </aside>

      <section class="main">
        <div class="panel">
          <h2>Step 2: Pick the exact class</h2>
          <p class="hint">Upcoming sessions are shown first. Courses are collapsed by default — expand the one you want.</p>
        </div>

        <div id="status" class="notice">Loading schedule…</div>
        <div id="courseCards"></div>
      </section>

    </section>
  </main>

  <script>
    const SCHEDULE_JSON_URL = "./data/schedule.json";
    const COURSE_DESC_JSON_URL = "./data/course-descriptions.json";

    const FAMILY_ORDER = [
      "ACLS","BLS","PALS","Heartsaver / CPR-AED","First Aid","OSHA","Stop the Bleed","Instructor","Other"
    ];

    function withCacheBust(url){
      const u = new URL(url, window.location.href);
      u.searchParams.set("ts", String(Date.now()));
      return u.toString();
    }
    async function loadJson(url){
      const r = await fetch(withCacheBust(url), { cache:"no-store" });
      if(!r.ok) throw new Error(`HTTP ${r.status} while fetching ${url}`);
      return await r.json();
    }
    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    // Allow Enrollware HTML in title (icons/logos), but sanitized
    function sanitizeEnrollwareHtml(html) {
      const allowedTags = new Set(["IMG", "I", "B", "STRONG", "EM", "BR", "SPAN", "SMALL"]);
      const allowedAttrs = new Set(["src", "alt", "title", "style", "class", "loading"]);

      const tpl = document.createElement("template");
      tpl.innerHTML = String(html || "");

      const walk = (node) => {
        if (node.nodeType === Node.COMMENT_NODE) { node.remove(); return; }
        if (node.nodeType === Node.ELEMENT_NODE) {
          const tag = node.tagName.toUpperCase();
          if (!allowedTags.has(tag)) {
            const text = document.createTextNode(node.textContent || "");
            node.replaceWith(text);
            return;
          }
          [...node.attributes].forEach(attr => {
            const name = attr.name.toLowerCase();
            if (name.startsWith("on")) { node.removeAttribute(attr.name); return; }
            if (!allowedAttrs.has(name)) { node.removeAttribute(attr.name); return; }
            if (tag === "IMG" && name === "src") {
              const v = (attr.value || "").trim();
              if (!(v.startsWith("http://") || v.startsWith("https://"))) node.removeAttribute("src");
            }
          });
        }
        [...node.childNodes].forEach(walk);
      };
      [...tpl.content.childNodes].forEach(walk);
      return tpl.innerHTML;
    }

    // --- Time parsing (handles most schedule.json shapes)
    function _pickStartField(s){
      return (
        s.start_ms || s.startMs || s.start_iso || s.startISO || s.start || s.start_datetime ||
        s.startDateTime || s.datetime || s.dateTime || s.when || s.class_start || null
      );
    }
    function toMillis(row){
      const v = _pickStartField(row);
      if (v == null) return null;
      if (typeof v === "number" && Number.isFinite(v)) return v;
      if (typeof v === "string"){
        const t = Date.parse(v);
        return Number.isFinite(t) ? t : null;
      }
      return null;
    }
    function isUpcoming(row, nowMs){
      if (typeof row?.is_past === "boolean") return !row.is_past;
      const ms = toMillis(row);
      return ms != null && ms >= nowMs;
    }
    function fmtWhen(ms){
      const d = new Date(ms);
      return d.toLocaleString(undefined, {
        weekday:"long", year:"numeric", month:"long", day:"numeric", hour:"numeric", minute:"2-digit"
      });
    }

    // --- Field pickers (use whatever schedule.json provides)
    function pickCourseKey(row){
      return row.course_number || row.courseNumber || row.course_id || row.courseId ||
             row.ct_id || row.ctId || row.courseTypeId || row.course_type_id ||
             row.course_slug || row.courseSlug || row.course_url || row.courseUrl ||
             row.schedule_url || row.scheduleUrl || row.title || row.course_name || row.courseName || "unknown";
    }
    function pickCourseTitle(row){
      return row.title || row.course_name || row.courseName || row.course_title || row.courseTitle || "Course";
    }
    function pickCourseSubtitle(row){
      return row.subtitle || row.course_subtitle || row.courseSubtitle || row.course_tagline || "";
    }
    function pickLocation(row){
      return row.location || row.location_name || row.locationName || row.city_state ||
             row.cityState || row.site || row.address || "Location TBD";
    }
    function pickRegisterUrl(row){
      return row.register_url || row.registerUrl || row.enroll_url || row.enrollUrl ||
             row.enroll_link || row.enrollLink || row.url || row.register || row.enroll || "";
    }
    function pickScheduleUrl(row){
      return row.schedule_url || row.scheduleUrl || row.course_url || row.courseUrl || row.ct_url || row.ctUrl || "";
    }

    function classifyFamily(title){
      const t = String(title || "").toUpperCase();
      if (t.includes("ACLS")) return "ACLS";
      if (t.includes("PALS")) return "PALS";
      if (t.includes("BLS")) return "BLS";
      if (t.includes("HEARTSAVER") || t.includes("CPR/AED") || t.includes("CPR AED") || t.includes("CPR-AED")) return "Heartsaver / CPR-AED";
      if (t.includes("FIRST AID") || t.includes("FA/") || t.includes("FA ")) return "First Aid";
      if (t.includes("OSHA") || t.includes("USCG") || t.includes("COAST GUARD") || t.includes("DAN")) return "OSHA";
      if (t.includes("STOP THE BLEED")) return "Stop the Bleed";
      if (t.includes("INSTRUCTOR")) return "Instructor";
      return "Other";
    }

    function buildGroups(rows){
      const now = Date.now();
      const map = new Map();

      for (const r of (rows || [])){
        if (!isUpcoming(r, now)) continue;

        const key = String(pickCourseKey(r));
        const title = pickCourseTitle(r);
        const fam = classifyFamily(title);

        if (!map.has(key)){
          map.set(key, {
            key,
            title,
            subtitle: pickCourseSubtitle(r),
            family: fam,
            scheduleUrl: pickScheduleUrl(r),
            sessions: []
          });
        }
        const g = map.get(key);
        if (!g.scheduleUrl) g.scheduleUrl = pickScheduleUrl(r);
        g.sessions.push(r);
      }

      const list = Array.from(map.values());
      for (const g of list){
        g.sessions.sort((a,b)=>(toMillis(a) ?? 9e15) - (toMillis(b) ?? 9e15));
        g.nextMs = toMillis(g.sessions[0]) ?? 9e15;
      }
      list.sort((a,b)=>a.nextMs - b.nextMs);
      return list;
    }

    function familyCounts(groups){
      const m = new Map();
      for (const f of FAMILY_ORDER) m.set(f, 0);
      for (const g of groups){
        m.set(g.family, (m.get(g.family)||0) + g.sessions.length);
      }
      return m;
    }

    const elFamilyList = document.getElementById("familyList");
    const elFamilySearch = document.getElementById("familySearch");
    const elStatus = document.getElementById("status");
    const elCards = document.getElementById("courseCards");

    let GROUPS = [];
    let COUNTS = new Map();
    let ACTIVE_FAMILY = "BLS";
    let COURSE_DESC = {};

    function renderFamilies(){
      const q = String(elFamilySearch.value || "").trim().toUpperCase();
      elFamilyList.innerHTML = "";

      const ordered = FAMILY_ORDER
        .filter(f => (COUNTS.get(f) || 0) > 0)
        .filter(f => !q || f.toUpperCase().includes(q));

      for (const fam of ordered){
        const total = COUNTS.get(fam) || 0;
        const div = document.createElement("div");
        div.className = "family" + (fam === ACTIVE_FAMILY ? " active" : "");
        div.innerHTML = `
          <div class="meta">
            <strong>${escapeHtml(fam)}</strong>
            <small>${total} upcoming sessions</small>
          </div>
          <div class="badge">${total}</div>
        `;
        div.addEventListener("click", () => {
          ACTIVE_FAMILY = fam;
          renderFamilies();
          renderCards();
        });
        elFamilyList.appendChild(div);
      }
    }

    function setCollapsed(sessionsEl, toggleBtn, collapsed){
      sessionsEl.style.display = collapsed ? "none" : "flex";
      toggleBtn.textContent = collapsed ? "SHOW 5" : "HIDE";
      toggleBtn.dataset.collapsed = collapsed ? "true" : "false";
      toggleBtn.setAttribute("aria-expanded", collapsed ? "false" : "true");
    }

    function closeAllExcept(key){
      document.querySelectorAll(".sessions[data-key]").forEach(el => {
        if (el.dataset.key !== key) el.style.display = "none";
      });
      document.querySelectorAll("button.pillBtn[data-key]").forEach(btn => {
        if (btn.dataset.key !== key){
          btn.textContent = "SHOW 5";
          btn.dataset.collapsed = "true";
          btn.setAttribute("aria-expanded","false");
        }
      });
    }

    function pickDesc(key, title){
      return COURSE_DESC[key] || COURSE_DESC[title] || "";
    }

    function renderCards(){
      const groups = GROUPS.filter(g => g.family === ACTIVE_FAMILY);

      elCards.innerHTML = "";

      if (groups.length === 0){
        elStatus.className = "notice";
        elStatus.textContent = "No upcoming sessions found for this family.";
        return;
      }

      elStatus.className = "notice";
      elStatus.textContent = `Showing upcoming sessions for: ${ACTIVE_FAMILY}`;

      for (const g of groups){
        const card = document.createElement("article");
        card.className = "course";

        const desc = pickDesc(g.key, g.title);
        const titleHtml = sanitizeEnrollwareHtml(g.title);

        const head = document.createElement("div");
        head.className = "course-head";

        const left = document.createElement("div");
        left.className = "course-title";
        left.innerHTML = `
          <div class="titleLine">${titleHtml}</div>
          <div class="subLine">${escapeHtml(desc || g.subtitle || "")}</div>
        `;

        const right = document.createElement("div");
        right.className = "course-head-right";

        const toggle = document.createElement("button");
        toggle.type = "button";
        toggle.className = "pillBtn";
        toggle.dataset.key = String(g.key);

        const more = document.createElement("a");
        more.className = "pillLink";
        more.textContent = "More dates";
        more.href = g.scheduleUrl || "#";
        more.target = "_blank";
        more.rel = "noopener";
        if (!g.scheduleUrl) more.style.display = "none";

        right.appendChild(toggle);
        right.appendChild(more);

        head.appendChild(left);
        head.appendChild(right);

        const body = document.createElement("div");
        body.className = "course-body";

        const sessions = document.createElement("div");
        sessions.className = "sessions";
        sessions.dataset.key = String(g.key);

        for (const r of g.sessions.slice(0,5)){
          const ms = toMillis(r);
          const when = ms ? fmtWhen(ms) : "Date/time";
          const where = pickLocation(r);
          const regUrl = pickRegisterUrl(r);

          const row = document.createElement("div");
          row.className = "session";
          row.innerHTML = `
            <div class="when">
              <strong>${escapeHtml(when)}</strong>
              <small>${escapeHtml(where)}</small>
            </div>
            <a class="reg" href="${escapeHtml(regUrl || "#")}" target="_blank" rel="noopener">Register now</a>
          `;
          sessions.appendChild(row);
        }

        // collapsed by default
        setCollapsed(sessions, toggle, true);

        toggle.addEventListener("click", () => {
          const isCollapsed = (toggle.dataset.collapsed === "true");
          if (isCollapsed){
            closeAllExcept(String(g.key));
            setCollapsed(sessions, toggle, false);
          } else {
            setCollapsed(sessions, toggle, true);
          }
        });

        body.appendChild(sessions);

        card.appendChild(head);
        card.appendChild(body);
        elCards.appendChild(card);
      }
    }

    async function boot(){
      try{
        const [scheduleRows, desc] = await Promise.all([
          loadJson(SCHEDULE_JSON_URL),
          loadJson(COURSE_DESC_JSON_URL).catch(()=> ({}))
        ]);

        COURSE_DESC = desc || {};
        GROUPS = buildGroups(scheduleRows);
        COUNTS = familyCounts(GROUPS);

        if ((COUNTS.get(ACTIVE_FAMILY)||0) === 0){
          for (const fam of FAMILY_ORDER){
            if ((COUNTS.get(fam)||0) > 0){ ACTIVE_FAMILY = fam; break; }
          }
        }

        renderFamilies();
        renderCards();
      }catch(err){
        elStatus.className = "error";
        elStatus.textContent = "Schedule failed to load. Please refresh, or register directly through Enrollware.";
        console.error(err);
        elCards.innerHTML = `
          <div class="error">
            <div style="font-weight:900;margin-bottom:6px;">Details</div>
            <div style="margin-bottom:10px;">${escapeHtml(err?.message || String(err))}</div>
            <a class="btn" href="https://www.enrollware.com/site/coastalcprtraining/schedule#view=calendar" target="_blank" rel="noopener">
              Open Enrollware schedule
            </a>
          </div>
        `;
      }
    }

    elFamilySearch.addEventListener("input", renderFamilies);
    boot();
  </script>
</body>
</html>

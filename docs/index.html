<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>910CPR – Courses & Schedule (Nested Curtains)</title>

  <!-- GA4 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-45PBWBK7KR"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);} 
    gtag('js', new Date());
    gtag('config', 'G-45PBWBK7KR');
  </script>

  <!-- GTM -->
  <script>
    (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});
      var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';
      j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-K58Z4XD');
  </script>
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-K58Z4XD" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>

  <style>
    :root{--ink:#0a1b2b;--bg:#f6f9fc;--card:#fff;--edge:#dce9f7;--hover:#f3f8ff;--badge:#eef6ff;--brand:#0b66c3;--ok:#0a7d27;--err:#b00020}
    html,body{height:100%}
    body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:var(--bg);color:var(--ink)}
    .wrap{max-width:1100px;margin:auto;padding:20px}
    .status{margin:0 0 8px;padding:10px 16px;font-size:14px}
    .status.ok{background:#e8f7ee;color:var(--ok);border:1px solid #cfe8d7}
    .status.err{background:#fde9ec;color:var(--err);border:1px solid #f3c7cf}
    .muted{opacity:.7}

    /* Curtains */
    details{margin:10px 0;border-radius:10px;box-shadow:0 3px 10px rgba(0,0,0,.05);background:var(--card)}
    details>summary{cursor:pointer;padding:12px 16px;font-weight:700;list-style:none}
    details[open]>summary{background:#eaf3ff}
    .subgrid{padding:12px 20px;border-top:1px solid var(--edge)}
    .sub details>summary{background:#fff}

    /* Enrollware-like heading shim (we’re importing their innerHTML) */
    .ew-heading{display:flex;align-items:center;gap:8px;font-weight:700}
    .ew-heading img{height:22px;width:auto;vertical-align:middle}
    .ew-subtitle{font-size:12px;opacity:.75;margin-top:2px}

    .badge{display:inline-block;background:var(--badge);color:var(--brand);border:1px solid #cfe2f9;border-radius:999px;padding:3px 9px;font-size:12px;margin-right:6px}
    .btn{display:inline-block;margin-top:8px;border:1px solid var(--edge);border-radius:8px;padding:6px 10px;text-decoration:none;color:#0b66c3;background:var(--card)}
    .meta{font-size:12px;color:#466;margin:6px 0 0}

    /* Class list (we copy Enrollware UL) */
    .enrclass-list{list-style:none;padding:0;margin:12px 0}
    .enrclass-list li{margin:6px 0}
    .enrclass-list a{display:flex;flex-direction:column;gap:4px;border:1px solid var(--edge);border-radius:10px;padding:8px 10px;text-decoration:none;color:var(--ink);background:var(--card)}
    .enrclass-list a:hover{background:var(--hover);border-color:#b9d6f9}
  </style>
</head>
<body>
  <div class="wrap"></div>

  <script>
    const ENR_ORIGIN = 'https://coastalcprtraining.enrollware.com';

    // --- Helpers ----------------------------------------------------
    function absolutizeUrls(fragment){
      // Make <img src> and <a href> absolute if they start with / or relative
      fragment.querySelectorAll('img, a').forEach(el=>{
        const attr = el.tagName==='IMG' ? 'src' : 'href';
        const v = el.getAttribute(attr);
        if(!v) return;
        if(/^https?:\/\//i.test(v)) return; // already absolute
        const abs = v.startsWith('/') ? ENR_ORIGIN+v : ENR_ORIGIN+'/'+v.replace(/^\.?\//,'');
        el.setAttribute(attr, abs);
      });
      return fragment;
    }

    function parseDateFromText(t){
      if(!t) return null;
      const s = String(t).replace(/\u00A0/g,' ').trim();
      const re = /^(?:[A-Za-z]+,\s*)?([A-Za-z]+)\s+(\d{1,2}),\s*(\d{4})\s+at\s+(\d{1,2}):(\d{2})\s*(AM|PM)/i;
      const m = s.match(re); if(!m) return null;
      const months = {january:0,february:1,march:2,april:3,may:4,june:5,july:6,august:7,september:8,october:9,november:10,december:11};
      const mon = months[m[1].toLowerCase()]; if(mon==null) return null;
      let hr=+m[4], min=+m[5]; const ampm=m[6].toUpperCase();
      if(ampm==='PM' && hr<12) hr+=12; if(ampm==='AM' && hr===12) hr=0;
      return new Date(+m[3], mon, +m[2], hr, min);
    }

    function limitUlToWindow(ul,maxDays=28,maxItems=10){
      if(!ul) return {ul,kept:0,total:0};
      const cutoff = new Date(); cutoff.setDate(cutoff.getDate()+maxDays);
      const lis = Array.from(ul.querySelectorAll(':scope>li'));
      let kept=0,total=0;
      for(const li of lis){
        total++;
        const a = li.querySelector('a');
        const txt = (a?.textContent||li.textContent||'').trim();
        const dt = parseDateFromText(txt);
        const keep = (!dt) || (dt && dt<=cutoff && kept<maxItems);
        if(keep){ kept++; } else { li.remove(); }
      }
      return {ul, kept, total};
    }

    function textContains(s,...needles){ const n=(s||'').toLowerCase(); return needles.some(h=>n.includes(String(h).toLowerCase())); }
    function detectBody(titleHTML,desc){
      const t=(titleHTML||'')+' '+(desc||'');
      if(textContains(t,'american heart','aha')) return 'AHA';
      if(textContains(t,'red cross','arc')) return 'ARC';
      if(textContains(t,'hsi','health & safety institute')) return 'HSI';
      if(textContains(t,'uscg','coast guard')) return 'USCG';
      return '';
    }
    function hasWord(hay, word){ return new RegExp(`\\b${word}\\b`, 'i').test(hay || ''); }
    function detectSection(titleHTML, desc){
      const t = titleHTML || '';
      const d = desc  || '';
      if (hasWord(t,'ACLS')||hasWord(d,'ACLS')) return 'ACLS';
      if (hasWord(t,'PALS')||hasWord(d,'PALS')) return 'PALS';
      if (hasWord(t,'BLS') ||hasWord(d,'BLS'))  return 'BLS';
      if (/\b(USCG|Coast Guard|OSHA|Stop the Bleed)\b/i.test(t+d)) return 'OSHA/USCG/STB';
      if (/\b(Heartsaver|First Aid|CPR|AED)\b/i.test(t+d))         return 'CPR/AED/First Aid';
      return 'Other';
    }
    function isLayoutSeparator(titleHTML, desc, hasUl){
      const t = (titleHTML||'').replace(/<[^>]+>/g,'').trim().toLowerCase();
      if (hasUl) return false;
      const blockedExact = new Set([
        'other programs',
        'instructor programs',
        'cpr / aed only',
        'healthcare provider: pals course',
        'healthcare provider: asls course'
      ]);
      if (blockedExact.has(t)) return true;
      const d = (desc||'').toLowerCase();
      if (t.includes('instructor program') || d.includes('become an instructor')) return true;
      if (t.includes('other program')) return true;
      if (t.includes('cpr / aed only')) return true;
      return false;
    }
    function wireCurtains(rootSel){
      document.querySelectorAll(rootSel).forEach(sec=>{
        sec.addEventListener('toggle',()=>{
          if(sec.open){
            document.querySelectorAll(rootSel).forEach(d=>{ if(d!==sec) d.open=false;});
            const top=sec.getBoundingClientRect().top + window.scrollY - 12;
            window.scrollTo({top,behavior:'smooth'});
          }
        });
      });
      document.querySelectorAll('.sub').forEach(sub=>{
        sub.addEventListener('toggle',()=>{
          if(sub.open){
            const top=sub.getBoundingClientRect().top + window.scrollY - 12;
            window.scrollTo({top,behavior:'smooth'});
          }
        });
      });
    }
    async function loadSnapshotHTML(){
      const here = location.pathname;
      const base = here.replace(/[^/]+$/,''); // dir of this page
      const tryPaths = [
        base + 'data/enrollware-schedule.html',
        '/ew2landers/data/enrollware-schedule.html'
      ];
      const tried = [];
      for(const url of tryPaths){
        try{
          const res = await fetch(url,{mode:'same-origin',credentials:'omit',cache:'no-cache'});
          if(res.ok){ return { html: await res.text(), url, tried }; }
          tried.push(url+' ('+res.status+')');
        }catch(e){ tried.push(url+' (fetch error)'); }
      }
      return { html:null, url:null, tried };
    }

    // --- Main -------------------------------------------------------
    document.addEventListener('DOMContentLoaded', async()=>{
      const host = document.querySelector('.wrap');
      const status = document.createElement('div'); status.className='status';
      host.parentNode.insertBefore(status, host);

      const load = await loadSnapshotHTML();
      if(!load.html){
        status.className='status err';
        status.innerHTML = '<strong>Could not load schedule snapshot.</strong><br><span class="muted">Tried:</span> '+ (load.tried.join(' → '));
        host.insertAdjacentHTML('beforeend','<p>Put the file at docs/data/enrollware-schedule.html in your repo.</p>');
        return;
      }

      const dom = document.createElement('div'); dom.innerHTML = load.html;
      const panels = [...dom.querySelectorAll('.enrpanel')];

      const courses = [];
      let skippedNoHeading=0, skippedNoDates=0, skippedSeparators=0;

      for (const p of panels) {
        const anchor = p.querySelector('[id^="ct"],[name^="ct"]');
        const id     = anchor?.id || anchor?.getAttribute('name') || '';
        // Preserve full Enrollware heading markup
        const headingEl = p.querySelector('.enrpanel-heading,h1,h2,h3,h4');
        if(!headingEl){ skippedNoHeading++; continue; }
        const headingFrag = headingEl.cloneNode(true);
        absolutizeUrls(headingFrag);
        const titleHTML = headingFrag.innerHTML.trim();

        const bodyEl = p.querySelector('.enrpanel-body');
        const descClone = bodyEl ? bodyEl.cloneNode(true) : null;
        if (descClone){ const u = descClone.querySelector('ul.enrclass-list'); if (u) u.remove(); }
        if (descClone) absolutizeUrls(descClone);
        const descHTML = descClone ? (descClone.innerHTML || '').trim() : '';

        const ul = p.querySelector('ul.enrclass-list');
        const hasUl = !!ul;
        if (isLayoutSeparator(titleHTML, descHTML, hasUl)) { skippedSeparators++; continue; }
        if (!hasUl) { skippedNoDates++; continue; }

        const ulClone = ul.cloneNode(true);
        absolutizeUrls(ulClone);
        const trimmed = limitUlToWindow(ulClone, 28, 10);

        courses.push({ id, titleHTML, descHTML, ul: trimmed.ul, kept: trimmed.kept, total: trimmed.total });
      }

      const buckets={BLS:[],ACLS:[],PALS:[],"CPR/AED/First Aid":[],"OSHA/USCG/STB":[],Other:[]};
      for(const c of courses){ buckets[detectSection(c.titleHTML,c.descHTML)].push(c); }

      host.innerHTML = '<h1>910CPR Courses & Schedule</h1><p class="meta">Loaded snapshot: '+(load.url||'(unknown)')+'</p>';

      for(const [section,list] of Object.entries(buckets)){
        if(!list.length) continue;
        const sec=document.createElement('details'); sec.className='curtain';
        sec.innerHTML=`<summary>${section} (${list.length})</summary><div class="subgrid"></div>`;
        const grid=sec.querySelector('.subgrid');

        for(const course of list){
          const sub=document.createElement('details'); sub.className='sub';

          const bodyLabel=detectBody(course.titleHTML,course.descHTML);
          const badge=bodyLabel?`<span class="badge">${bodyLabel}</span>`:'';
          const src= ENR_ORIGIN + '/schedule#' + course.id;
          const hint = (course.total>course.kept)
            ? `<div class="meta">Showing ${course.kept} of ${course.total} upcoming dates (~4 weeks). <a class="btn" href="${src}">See all dates</a></div>`
            : `<div class="meta">All upcoming dates shown.</div>`;

          // Use the original Enrollware heading HTML inside our summary and body
          sub.innerHTML = `
            <summary><div class="ew-heading">${course.titleHTML}</div></summary>
            <div class="body">
              ${badge}
              <div class="desc">${course.descHTML}</div>
              <ul class="enrclass-list"></ul>
              ${hint}
            </div>`;
          sub.querySelector('.enrclass-list').replaceWith(course.ul);
          grid.appendChild(sub);
        }
        host.appendChild(sec);
      }

      status.className='status ok';
      const counts = Object.entries(buckets).map(([k,v])=>`${k}:${v.length}`).join(' • ');
      status.innerHTML = `<strong>Status:</strong> Loaded ${courses.length} courses from ${panels.length} panels. `
        + `Buckets → ${counts}. Skipped (no heading:${skippedNoHeading}, no dates:${skippedNoDates}, separators:${skippedSeparators}).`;

      wireCurtains('details.curtain');
    });
  </script>

  <!-- Voice widget -->
  <embeddable-voice id="1cf9bf8f-38da-437e-abfb-efa1ce9a02ff"></embeddable-voice>
  <script src="https://cdn.247aireceptionist.com/script.js"></script>
</body>
</html>


<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>910CPR Courses</title>
  <style>
    :root{
      --bg:#0b1320;          /* dark background */
      --ink:#eaf2ff;         /* high-contrast text */
      --muted:#9fb6e8;
      --brand:#1373d1;       /* primary action */
      --accent:#0f61bb;
      --shadow:0 2px 16px rgba(6,10,18,.35);
      --radius:18px;
      /* family color chips */
      --bls:#b6d4ff;   /* BLS */
      --acls:#ff7474;  /* ACLS */
      --pals:#c59eff;  /* PALS */
      --faid:#7eb0ff;  /* First Aid / Heartsaver */
    }

    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    a{color:var(--brand);text-decoration:none}
    a:hover{color:var(--accent)}

    .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin:8px 0 18px;position:sticky;top:0;z-index:10}
    header h1{font-size:clamp(22px,3.5vw,34px);margin:0;font-weight:750}
    .nav{display:flex;gap:14px;flex-wrap:wrap;align-items:center}
    .nav a{display:inline-flex;align-items:center;gap:6px;padding:8px 10px;border:1px solid #243349;border-radius:12px;background:#0e1726;color:var(--ink);font-weight:650}
.nav a[target="_blank"]::after{content:" ↗";opacity:.7;font-weight:700}
    .nav a:hover{background:#122448;border-color:#2f416a}

    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
    .card{background:#0e1726;border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;display:flex;flex-direction:column;min-height:120px;border:1px solid #243349;position:relative}
    .card h3{margin:0 0 10px;padding-right:24px;display:flex;align-items:center;gap:8px}
.card h3 .brandicon{height:22px;width:auto;object-fit:contain;display:inline-block;filter:drop-shadow(0 1px 1px rgba(0,0,0,.25))}
.card.course:hover{outline:2px solid #2f416a;outline-offset:0;border-color:#2f416a;background:#0f1f39}
    /* top-right logo removed in favor of inline brand icon */
.card .cardlogo{display:none}
    @media(max-width:640px){.card h3{padding-right:96px}.card .cardlogo{height:28px}}
    .card.course{grid-column:span 6}
    @media(max-width:860px){.card.course{grid-column:span 12}}

    /* Section separators with family accent bar */
    .card.title{grid-column:1 / -1;background:#0f1c33;color:var(--ink);border:1px solid #2a3b62;position:relative;overflow:hidden}
    .card.title::before{content:"";position:absolute;left:0;top:0;bottom:0;width:12px;background:#2a3b62}
    .card.title.bls::before{background:var(--bls)}
    .card.title.acls::before{background:var(--acls)}
    .card.title.pals::before{background:var(--pals)}
    .card.title.faid::before{background:var(--faid)}
    .card.title h2{margin:0 0 4px;font-size:clamp(18px,2.8vw,24px);padding-right:128px}
    .card.title small{color:var(--muted)}

    /* Title-bar family image that fills height but doesn't drive height */
    .card.title .famimg{position:absolute;right:16px;top:12px;height:calc(100% - 24px);max-height:none;width:auto;object-fit:contain;filter:drop-shadow(0 2px 4px rgba(0,0,0,.4));pointer-events:none}
    @media(max-width:640px){.card.title .famimg{max-height:44px;right:12px}}

    /* Periscope */
    details{margin-top:auto}
    summary{cursor:pointer;list-style:none;display:flex;align-items:center;gap:8px;padding:10px 12px;border-radius:12px;background:#111e36;color:var(--ink);font-weight:700;border:1px solid #243349}
summary:hover{background:#1a2b55;border-color:#3b5aa0}
    summary::-webkit-details-marker{display:none}
    details[open] summary{background:#122448;border-color:#2f416a}

    .desc{padding:10px 2px 2px;color:#bfd2ff}
    .slots{margin:8px 0 0;padding:0;list-style:none}
    .slots li{display:block;padding:0;margin:10px 0;background:transparent;border:none}

    /* Full-width clickable slot button */
    .slotbtn{display:flex;align-items:center;justify-content:space-between;width:100%;padding:14px;border-radius:12px;background:#152242;border:1px solid #2a3b62;color:var(--ink);text-decoration:none}
    .slotbtn:hover{background:#1a2b55;border-color:#385089}
    .slotbtn .meta{font-size:13px;color:var(--muted)}
    .slotbtn .right{white-space:nowrap;margin-left:12px}

    /* Popular panel */
    .popular{display:grid;grid-template-columns:2fr 1fr;gap:20px;align-items:center;background:#0b1320;color:var(--ink);border-radius:20px;padding:18px;margin:8px 0 22px;border:1px solid #243349;box-shadow:var(--shadow)}
    .popular h2{margin:6px 0 10px;font-size:clamp(16px,2.2vw,20px);font-weight:750;color:#b6d4ff}
    .tiles{display:flex;flex-wrap:wrap;gap:10px}
    .tile{display:flex;flex-direction:column;justify-content:center;min-width:160px;padding:10px 12px;border-radius:12px;color:#001a4d;border:1px solid #2a3b62;box-shadow:inset 0 1px 0 rgba(255,255,255,.04)}
    .tile .t1{font-weight:800}
    .tile .t2{font-size:12px;opacity:.8;color:#eef3ff}
    .tile:hover{filter:brightness(1.15);box-shadow:0 0 0 2px rgba(0,0,0,.15) inset}
    .tile.bls{background:var(--bls)}
    .tile.acls{background:var(--acls);color:#2a0010}
    .tile.pals{background:var(--pals)}
    .tile.faid{background:var(--faid)}
    .popular .art{display:flex;align-items:center;justify-content:center;background:#fff;border-radius:16px;padding:12px}
    .popular .art img{max-width:100%;height:auto;border-radius:12px}

    .note{font-size:13px;color:var(--muted);margin-top:6px}

    /* Certifying bodies strip */
    .brandrow{display:flex;justify-content:center;align-items:center;gap:28px;background:#ffffff;border:1px solid #e6eaf5;border-radius:20px;padding:14px;margin:0 0 12px;box-shadow:0 2px 16px rgba(6,10,18,.08)}
    .brandrow .badge{display:flex;align-items:center;justify-content:center;padding:8px 12px;border-radius:14px;background:transparent;border:1px solid transparent}
    .brandrow .badge img{height:56px;width:auto;object-fit:contain;display:block;filter:drop-shadow(0 2px 4px rgba(0,0,0,.15))}
    @media(max-width:640px){.brandrow .badge img{height:44px}}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>910CPR – Course Catalog</h1>
    <nav class="nav" aria-label="Primary">
      <a href="http://coastalcprtraining.com/about" target="_blank" rel="noopener">About</a>
      <a href="http://910cpr.com/" target="_blank" rel="noopener">Classes</a>
      <a href="http://coastalcprtraining.com/" target="_blank" rel="noopener">Coastal CPR Training</a>
      <a href="http://coastalcprtraining.com/on-site-training" target="_blank" rel="noopener">On Site Training</a>
    </nav>
  </header>

  <!-- Certifying bodies / partners -->
  <section class="brandrow" aria-label="Certifying bodies">
    <div class="badge"><img src="https://www.enrollware.com/sitefiles/coastalcprtraining/111 aha-authorized-training-site.png" alt="AHA Authorized Training Site" /></div>
    <div class="badge"><img src="https://www.enrollware.com/sitefiles/coastalcprtraining/111 arc-ltp-logo.jpg" alt="American Red Cross Licensed Training Provider" /></div>
    <div class="badge"><img src="https://www.enrollware.com/sitefiles/coastalcprtraining/HSI.png" alt="HSI Training Center" /></div>
  </section>

  <!-- Popular quick-links -->
  <section class="popular" aria-label="Most popular classes">
    <div>
      <h2>Most popular classes</h2>
      <div class="tiles">
        <a class="tile bls" href="#aha---bls-provider---in-person-renewal"><span class="t1">BLS</span><span class="t2">Initial or renewal; instructor‑led</span></a>
        <a class="tile bls" href="#aha---bls-provider---in-person-initial"><span class="t1">BLS Online</span><span class="t2">Blended: online + in‑person skills</span></a>
        <a class="tile acls" href="#aha---acls-provider---in-person---renewal"><span class="t1">ACLS</span><span class="t2">Fully in‑person renewal</span></a>
        <a class="tile acls" href="#aha---acls-provider---in-person---initial"><span class="t1">ACLS Online</span><span class="t2">Initial (online + skills)</span></a>
        <a class="tile pals" href="#aha---pals-provider---in-person---renewal"><span class="t1">PALS</span><span class="t2">Fully in‑person renewal</span></a>
        <a class="tile pals" href="#aha---pals-provider---in-person---initial"><span class="t1">PALS Online</span><span class="t2">Initial (online + skills)</span></a>
        <a class="tile faid" href="#hsi---first-aid-cpr-aed--in-person-"><span class="t1">First Aid / CPR / AED</span><span class="t2">Fully in‑person course</span></a>
        <a class="tile faid" href="#aha---heartsaver-online"><span class="t1">First Aid / CPR / AED Online</span><span class="t2">Flexible + fast (online + skills)</span></a>
      </div>
    </div>
    <div class="art"><img src="https://www.enrollware.com/sitefiles/coastalcprtraining/910CPR_wave.jpg" alt="910CPR wave logo banner"/></div>
  </section>



  <!-- Catalog grid renders here -->
  <section id="courseGrid" class="grid" aria-live="polite"></section>
</div>

<script>
// ==========================
// TOP-LEVEL HELPERS (define early so they're always available)
// ==========================
function slug(s){ return String(s||'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,''); }
function fmtDate(dtISO){ const d=new Date(dtISO); const opt={weekday:'short',month:'short',day:'numeric',hour:'numeric',minute:'2-digit'}; return d.toLocaleString(undefined,opt); }

// ==========================
// CONFIG & CONSTANTS
// ==========================
const CONFIG = {
  windowDays: 28,
  maxSessionsPerCourse: 15,
  jsonFeed: "docs/data/schedule.json",
  htmlFallback: "docs/data/enrollware-schedule.html",
  snippetRoot: "docs/courses/" // will try docs/courses/{slug(key)}.html
};
const ENROLLWARE_BASE = 'https://coastalcprtraining.enrollware.com/';
const IMG_BASE = 'https://www.enrollware.com/sitefiles/coastalcprtraining/';
const FAMILY_IMG = { bls:'25-bls-new.png', acls:'25-acls-new.png', pals:'25-pals-new.png', faid:'25_Heartsaver.png' };
const BRAND_LOGO = {
  AHA: IMG_BASE + '_AHA.png',
  'Red Cross': IMG_BASE + '_ARC.png',
  HSI: IMG_BASE + '_HSI.png'
};

// ==========================
// CATALOG
// ==========================
const CATALOG = [
  { type:"title", text:"Healthcare Provider: BLS", blurb:"For clinical staff, hospitals, clinics", family:"bls" },
  { type:"course", key:"AHA - BLS Provider - In-person Renewal", brand:"AHA", title:"AHA – BLS Provider – In‑Person Renewal", short:"Instructor‑led Renewal", desc:"<!-- Course Description -->", courseMatch:["BLS Provider - In-person Renewal","BLS In-Person","BLS"], scheduleFilter:{ classType:"BLS" } },
  { type:"course", key:"AHA - BLS Provider - In-person Initial", brand:"AHA", title:"AHA – BLS Provider – In‑Person Initial", short:"For new or expired certs", desc:"<!-- Course Description -->", courseMatch:["BLS Provider - In-person Initial","BLS In-Person","BLS"], scheduleFilter:{ classType:"BLS" } },
  { type:"course", key:"AHA - BLS Provider - Heartcode", brand:"AHA", title:"AHA – BLS Provider – HeartCode (Online + Skills)", short:"Online + skills", desc:"<!-- Course Description -->", courseMatch:["BLS Heartcode","BLS Online","Heartcode"], scheduleFilter:{ classType:"BLS" } },

  { type:"title", text:"Healthcare Provider: ACLS", blurb:"Advanced Cardiovascular Life Support", family:"acls" },
  { type:"course", key:"AHA - ACLS Provider - In-person - Initial", brand:"AHA", title:"AHA – ACLS Provider – Initial", short:"First‑time ACLS", desc:"<!-- Course Description -->", courseMatch:["ACLS","ACLS Provider - In-person - Initial"], scheduleFilter:{ classType:"ACLS" } },
  { type:"course", key:"AHA - ACLS Provider - In-person - Renewal", brand:"AHA", title:"AHA – ACLS Provider – Renewal", short:"Update & renewal", desc:"<!-- Course Description -->", courseMatch:["ACLS","ACLS Provider - In-person - Renewal"], scheduleFilter:{ classType:"ACLS" } },
  { type:"course", key:"AHA - ACLS Provider - Heartcode", brand:"AHA", title:"AHA – ACLS Provider – HeartCode (Online + Skills)", short:"Online + skills", desc:"<!-- Course Description -->", courseMatch:["ACLS Heartcode","ACLS Online","Heartcode"], scheduleFilter:{ classType:"ACLS" } },

  { type:"title", text:"Healthcare Provider: PALS", blurb:"Pediatric Advanced Life Support", family:"pals" },
  { type:"course", key:"AHA - PALS Provider - In Person - Initial", brand:"AHA", title:"AHA – PALS Provider – Initial", short:"First‑time PALS", desc:"<!-- Course Description -->", courseMatch:["PALS","PALS Provider - In Person - Initial"], scheduleFilter:{ classType:"PALS" } },
  { type:"course", key:"AHA - PALS Provider - In Person - Renewal", brand:"AHA", title:"AHA – PALS Provider – Renewal", short:"Update & renewal", desc:"<!-- Course Description -->", courseMatch:["PALS","PALS Provider - In Person - Renewal"], scheduleFilter:{ classType:"PALS" } },
  { type:"course", key:"AHA - PALS Provider - Heartcode", brand:"AHA", title:"AHA – PALS Provider – HeartCode (Online + Skills)", short:"Online + skills", desc:"<!-- Course Description -->", courseMatch:["PALS Heartcode","PALS Online","Heartcode"], scheduleFilter:{ classType:"PALS" } },

  { type:"title", text:"CPR / AED & First Aid", blurb:"First Aid CPR AED trains anyone with little or no medical training to provide first aid, CPR, and use an automated external defibrillator (AED) in a safe, timely, and effective manner.", family:"faid" },
  { type:"title", text:"CPR / AED Only", blurb:"First Aid CPR AED trains anyone with little or no medical training to provide first aid, CPR, and use an AED in a safe, timely, and effective manner.", family:"faid" },
  { type:"title", text:"Instructor Programs", blurb:"Become an instructor and teach CPR, First Aid, or BLS through AHA, HSI, or Red Cross.", family:"bls" },
  { type:"title", text:"Other Programs", blurb:"Workplace & community classes", family:"faid" },
  { type:"course", key:"HSI - First Aid/CPR/AED (In-Person)", brand:"HSI", title:"HSI – Adult First Aid / CPR AED (Classroom)", short:"Meets OSHA 1910.151", desc:"<!-- Course Description -->", courseMatch:["HSI Adult First Aid","HSI - First Aid/CPR/AED"], scheduleFilter:{ classType:"HSI" } },
  { type:"course", key:"AHA - Heartsaver Online", brand:"AHA", title:"AHA – Heartsaver (Online + Skills)", short:"Flexible blended path", desc:"<!-- Course Description -->", courseMatch:["Heartsaver Online","Heartsaver"], scheduleFilter:{ classType:"Heartsaver" } },
  { type:"course", key:"AHA - Family & Friends CPR", brand:"AHA", title:"AHA – Family & Friends CPR", short:"Community, short format", desc:"<!-- Course Description -->", courseMatch:["Family & Friends"], scheduleFilter:{ classType:"Other" } },
  { type:"course", key:"Red Cross BLS (In-Person)", brand:"Red Cross", title:"Red Cross – BLS (In‑Person)", short:"ARC option", desc:"<!-- Course Description -->", courseMatch:["Red Cross","ARC","Red Cross BLS"], scheduleFilter:{ classType:"BLS" } },
  { type:"course", key:"Red Cross Adult CPR/AED (Online)", brand:"Red Cross", title:"Red Cross – Adult CPR/AED (Online)", short:"ARC blended", desc:"<!-- Course Description -->", courseMatch:["Red Cross","ARC","Red Cross Adult CPR/AED (Online)"], scheduleFilter:{ classType:"Other" } },
  { type:"course", key:"Red Cross First Aid/CPR/AED (In-Person)", brand:"Red Cross", title:"Red Cross – First Aid/CPR/AED (In‑Person)", short:"ARC classroom", desc:"<!-- Course Description -->", courseMatch:["Red Cross","ARC","First Aid/CPR/AED"], scheduleFilter:{ classType:"Other" } },
  { type:"course", key:"Red Cross First Aid/CPR/AED (Online + Skills)", brand:"Red Cross", title:"Red Cross – First Aid/CPR/AED (Online + Skills)", short:"ARC blended", desc:"<!-- Course Description -->", courseMatch:["Red Cross","ARC","First Aid/CPR/AED Online","Blended"], scheduleFilter:{ classType:"Other" } }
];

// ===== ORDERING: Mirror desired section/course order when possible =====
// Uses a lightweight, explicit order for items we know about; anything not listed stays at the end.
(function applyDesiredOrder(){
  try{
    const ORDER_LIST = [
      // Sections (as headers)
      'Healthcare Provider: BLS',
      'Healthcare Provider: ACLS',
      'Healthcare Provider: PALS',
      'CPR / AED & First Aid',
      'CPR / AED Only',
      'Instructor Programs',
      'Other Programs',
      // Top courses we render today (exact titles)
      'AHA – BLS Provider – In‑Person Renewal',
      'AHA – BLS Provider – In‑Person Initial',
      'AHA – BLS Provider – HeartCode (Online + Skills)',
      'AHA – ACLS Provider – Initial',
      'AHA – ACLS Provider – Renewal',
      'AHA – ACLS Provider – HeartCode (Online + Skills)',
      'AHA – PALS Provider – Initial',
      'AHA – PALS Provider – Renewal',
      'AHA – PALS Provider – HeartCode (Online + Skills)',
      'HSI – Adult First Aid / CPR AED (Classroom)',
      'AHA – Heartsaver (Online + Skills)',
      'AHA – Family & Friends CPR',
      'Red Cross – BLS (In‑Person)',
      'Red Cross – Adult CPR/AED (Online)',
      'Red Cross – First Aid/CPR/AED (In‑Person)',
      'Red Cross – First Aid/CPR/AED (Online + Skills)'
    ].map(s=>s.toLowerCase());

    const rank = new Map(ORDER_LIST.map((t,i)=>[t,i]));
    function label(x){ return String((x.type==='title'? x.text : (x.title||x.key||''))).toLowerCase(); }
    CATALOG.sort((a,b)=>{
      const ra = rank.has(label(a))? rank.get(label(a)) : Number.MAX_SAFE_INTEGER;
      const rb = rank.has(label(b))? rank.get(label(b)) : Number.MAX_SAFE_INTEGER;
      if(ra!==rb) return ra-rb;
      return 0;
    });
  }catch(e){ /* non-fatal ordering issue */ }
})();

// ==========================
// FEED LOADING (robust JSON detection)
// ==========================
let FEED = [];
let FEED_ERROR = null;

async function loadJSONRobust(url){
  const r = await fetch(url, {cache:'no-store'});
  if(!r.ok) throw new Error(`HTTP ${r.status}`);
  const text = await r.text();
  // If the payload looks like HTML (common 404 page), bail to fallback
  if(text.trim().startsWith('<')) throw new Error('Expected JSON, got HTML');
  try{ return JSON.parse(text); }
  catch(parseErr){ throw new Error('Invalid JSON in schedule.json'); }
}

async function loadFeed(){
  // Try JSON feed first
  try{
    const j = await loadJSONRobust(CONFIG.jsonFeed);
    if(Array.isArray(j) && j.length>0) return j; 
    FEED_ERROR = Array.isArray(j) ? 'JSON feed is empty.' : 'JSON feed present but not an array.';
    throw new Error(FEED_ERROR);
  }catch(e){
    // Fallback to HTML snapshot
    try{
      const r = await fetch(CONFIG.htmlFallback, {cache:'no-store'});
      if(!r.ok) { FEED_ERROR = `HTML fallback not ok: ${r.status}`; throw new Error('No HTML fallback'); }
      const html = await r.text();
      const parsed = parseHTMLSchedule(html);
      if(!parsed.length) FEED_ERROR = 'Parsed 0 sessions from HTML fallback.';
      return parsed;
    }catch(e2){ FEED_ERROR = FEED_ERROR || e.message || e2.message; return []; }
  }
}

// ==========================
// SNAPSHOT HTML PARSER
// ==========================
function parseHTMLSchedule(html){
  const doc = new DOMParser().parseFromString(html, 'text/html');
  const anchors = [...doc.querySelectorAll('a[href*="enroll?id="]')];
  const rows = [];
  anchors.forEach(a=>{
    const href = a.getAttribute('href') || '';
    const url = href.startsWith('http') ? href : new URL(href, ENROLLWARE_BASE).href;
    const idMatch = url.match(/id=(\d+)/); const id = idMatch? Number(idMatch[1]) : undefined;
    const row = a.closest('tr') || a.closest('.row') || a.parentElement;
    const text = (row ? row.innerText : a.innerText || '').replace(/\s+/g,' ').trim();
    const title = text || (a.title || a.textContent.trim());
    const when = text.match(/\b(?:Mon|Tue|Wed|Thu|Fri|Sat|Sun)\b.*?\d{1,2}:\d{2}\s*(?:AM|PM)/i)?.[0] || text.match(/\d{4}-\d{2}-\d{2}.*?\d{1,2}:\d{2}/)?.[0];
    const location = text.match(/Wilmington|Burgaw|Jacksonville|Shipyard|Sound Rd|Hinton Ave|Gum Branch/i)?.[0] || '';
    const startAttr = a.getAttribute('data-start');
    const start = startAttr || guessDate(when);
    const classType = guessType(title);
    rows.push({ id, classType, title, start, end:null, location, instructor:null, seats:null, url });
  });
  return rows;
}

// ==========================
// HELPERS
// ==========================
function guessType(title=''){
  const t = title.toLowerCase();
  if(t.includes('acls')) return 'ACLS';
  if(t.includes('pals')) return 'PALS';
  if(t.includes('bls')) return 'BLS';
  if(t.includes('heartsaver')) return 'Heartsaver';
  if(t.includes('hsi')) return 'HSI';
  return 'Other';
}
function guessDate(str){ if(!str) return null; const d = new Date(str); return isNaN(d) ? null : d.toISOString(); }
function withinWindow(dtISO){ if(!dtISO) return false; const s=new Date(dtISO); if(isNaN(s)) return false; const now=new Date(); const cap=new Date(now.getTime()+CONFIG.windowDays*86400000); return s>=now && s<=cap; }


===BEGIN JS===
/* SNAPSHOT ORDER RENDER (mirror enrollware-schedule.html order) */
function buildUpcomingMap(feed){
const map=new Map();
feed.filter(s=>withinWindow(s.start)).forEach(s=>{
const k=(s.title||'').trim(); if(!k) return;
if(!map.has(k)) map.set(k,[]);
map.get(k).push(s);
});
map.forEach(v=>v.sort((a,b)=>new Date(a.start)-new Date(b.start)));
return map;
}
function isSectionHeaderText(t){
const x=(t||'').toLowerCase().trim();
return x.startsWith('healthcare provider: bls')
|| x.startsWith('healthcare provider: acls')
|| x.startsWith('healthcare provider: pals')
|| x.startsWith('healthcare provider: asls')
|| x==='cpr / aed & first aid'
|| x==='cpr / aed only'
|| x==='instructor programs'
|| x==='other programs';
}
function familyFromHeader(text){
const t=text.toLowerCase();
if(t.includes('bls')) return 'bls';
if(t.includes('acls')) return 'acls';
if(t.includes('pals')) return 'pals';
return 'faid';
}
function detectBrand(title=''){
const t=title.toLowerCase();
if(t.includes('american red cross')||t.startsWith('arc')||t.includes('arc -')) return 'Red Cross';
if(t.includes('hsi')) return 'HSI';
if(t.includes('aha')||t.includes('american heart')) return 'AHA';
return null;
}
function createCourseCardExact(title, sessions){
const brand = detectBrand(title);
const el=document.createElement('div');
el.className='card course';
const keySlug=slug(title);
el.id=card-${keySlug};
const brandSrc = brand && BRAND_LOGO[brand] ? BRAND_LOGO[brand] : '';
const brandImg = brandSrc ? <img class="brandicon" src="${brandSrc}" alt="${brand} logo"/> : '';
el.innerHTML= <h3 id="h-${keySlug}">${brandImg}<a href="#${keySlug}" style="text-decoration:none;color:inherit">${title}</a></h3> <details id="d-${keySlug}" data-key="${keySlug}"> <summary>Course details & upcoming sessions</summary> <div class="desc" id="desc-${keySlug}"><!-- Course Description --></div> <ul class="slots" id="slots-${keySlug}"></ul> </details>;
const ul = el.querySelector(#slots-${keySlug});
if(!sessions || !sessions.length){
ul.innerHTML='<li class="note">No upcoming sessions in the next 4 weeks. See full schedule.</li>';
} else {
sessions.forEach(s=>{
const li=document.createElement('li');
li.innerHTML = <a class="slotbtn" href="${s.url}" target="_blank" rel="noopener" aria-label="Register for ${title} on ${fmtDate(s.start)}"> <div> <time datetime="${s.start}">${fmtDate(s.start)}</time> <div class="meta">${s.location||''}</div> </div> <div class="right">Register →</div> </a>;
ul.appendChild(li);
});
}
return el;
}
async function renderFromSnapshot(container, feed, snapshotHTML){
container.innerHTML='';
const upcomingMap = buildUpcomingMap(feed);
const doc=new DOMParser().parseFromString(snapshotHTML,'text/html');
const walker=doc.createTreeWalker(doc.body, NodeFilter.SHOW_ELEMENT, null);
let lastHeaderCard=null;
const added=new Set();
window._COURSE_KEYS=[];
while(walker.nextNode()){
const node=walker.currentNode;
const text=(node.textContent||'').replace(/\s+/g,' ').trim();
if(!text) continue;

// Section headers in document order
if(isSectionHeaderText(text)){
  const fam=familyFromHeader(text);
  lastHeaderCard = makeTitleCard(text,'',fam);
  container.appendChild(lastHeaderCard);
  continue;
}

// Course rows in document order (only if they have upcoming sessions)
const a = node.matches && node.matches('a[href*="enroll?id="]') ? node : (node.querySelector && node.querySelector('a[href*="enroll?id="]'));
if(!a) continue;

const row = a.closest('tr') || a.closest('.row') || node;
const rawTitle = ((row && row.innerText) ? row.innerText : a.textContent || '').replace(/\s+/g,' ').trim();
const title = rawTitle || a.getAttribute('title') || a.textContent || '';
if(!title) continue;

const sessions = upcomingMap.get(title);
if(!sessions || !sessions.length) continue; // skip courses without real dates
if(added.has(title)) continue;

const card = createCourseCardExact(title, sessions);

if(lastHeaderCard && lastHeaderCard.nextSibling){
  container.insertBefore(card, lastHeaderCard.nextSibling);
  lastHeaderCard = card; // keep insertion point moving within this section
} else {
  container.appendChild(card);
}

added.add(title);
window._COURSE_KEYS.push(title);


}

// Fallback if selectors ever change: show grouped by title
if(!container.children.length){
const byTitle=new Map();
feed.filter(s=>withinWindow(s.start)).forEach(s=>{const k=(s.title||'').trim(); if(!byTitle.has(k)) byTitle.set(k,[]); byTitle.get(k).push(s);});
byTitle.forEach((sessions,title)=>{
container.appendChild(createCourseCardExact(title,sessions));
window._COURSE_KEYS.push(title);
});
}

const map=new Map([...container.querySelectorAll('details[id^="d-"]')].map(d=>[d.id.slice(2),d]));
applyOpenFromURL(map);
}
===END JS===

Step 2 — Replace renderCatalog to use the snapshot order
Find the function that starts:
function renderCatalog(container, feed){

Replace the entire function body with this minimal delegator:

===BEGIN JS===
async function renderCatalog(container, feed){
const snapshot = await fetch(CONFIG.htmlFallback,{cache:'no-store'})
.then(r=>r.ok?r.text():Promise.resolve('<body></body>'))
.catch(()=>'<body></body>');
await renderFromSnapshot(container, feed, snapshot);
}
===END JS===

Step 3 — Make loadSnippets follow the actually-rendered titles
In the second <script> tag at the very bottom you have:
async function loadSnippets(){ const fetchOne = async(key)=>{ ... } ... Promise.all(CATALOG.filter(...)) }

Replace that whole function with:

===BEGIN JS===
async function loadSnippets(){
const keys = Array.isArray(window._COURSE_KEYS)&&window._COURSE_KEYS.length
? window._COURSE_KEYS
: [];
const fetchOne=async(title)=>{
const file=CONFIG.snippetRoot + slug(title) + '.html';
try{
const r=await fetch(file,{cache:'no-store'});
if(!r.ok) return;
const html=await r.text();
const el=document.getElementById('desc-'+slug(title));
if(el){ el.innerHTML=html; }
}catch(e){/* ignore */}
};
await Promise.all(keys.map(fetchOne));
}
===END JS===


// ==========================
// RENDER
// ==========================
function makeTitleCard(text, blurb, family){
  const el=document.createElement('div');
  el.className='card title' + (family? (' '+family) : '');
  const img = (family && FAMILY_IMG[family]) ? `<img class="famimg" src="${IMG_BASE}${FAMILY_IMG[family]}" alt="${family} icon"/>` : '';
  el.innerHTML=`<h2>${text}</h2>${blurb?`<small>${blurb}</small>`:''}${img}`;
  return el;
}

function makeCourseCard(c){
  const el=document.createElement('div');
  el.className='card course';
  const keySlug=slug(c.key);
  el.id=`card-${keySlug}`;
  const brandSrc = c.brand && BRAND_LOGO[c.brand] ? BRAND_LOGO[c.brand] : '';
  const brandImg = brandSrc ? `<img class=\"brandicon\" src=\"${brandSrc}\" alt=\"${c.brand} logo\"/>` : '';
  el.innerHTML=`
    <h3 id=\"h-${keySlug}\">${brandImg}<a href=\"#${keySlug}\" style=\"text-decoration:none;color:inherit\">${c.title}</a></h3>
    <details id=\"d-${keySlug}\" data-key=\"${keySlug}\">
      <summary>Course details & upcoming sessions</summary>
      <div class=\"desc\" id=\"desc-${keySlug}\"><!-- Course Description --></div>
      <ul class=\"slots\" id=\"slots-${keySlug}\"><li class=\"note\">Loading sessions…</li></ul>
    </details>`;
  return el;
}

function matchesCourse(feedItem, course){
  if(course.scheduleFilter?.classType && feedItem.classType===course.scheduleFilter.classType) return true;
  if(Array.isArray(course.courseMatch)){
    const t=(feedItem.title||'').toLowerCase();
    return course.courseMatch.some(k=> t.includes(String(k).toLowerCase()));
  }
  return false;
}

function renderCatalog(container, feed){
  container.innerHTML='';
  const map=new Map();
  const matched=new Set();

  CATALOG.forEach(item=>{
    if(item.type==='title'){
      container.appendChild(makeTitleCard(item.text,item.blurb,item.family));
      return;
    }

    const card=makeCourseCard(item);
    container.appendChild(card);

    const keySlug=slug(item.key);
    const slotsEl=card.querySelector(`#slots-${keySlug}`);
    const det=card.querySelector(`#d-${keySlug}`);
    map.set(keySlug,det);

    const sessions = feed
      .filter(s=>matchesCourse(s,item))
      .filter(s=>withinWindow(s.start))
      .sort((a,b)=> new Date(a.start)-new Date(b.start))
      .slice(0,CONFIG.maxSessionsPerCourse);

    if(!sessions.length){
      slotsEl.innerHTML='<li class="note">No upcoming sessions in the next 4 weeks. See full schedule.</li>';
    } else {
      slotsEl.innerHTML='';
      sessions.forEach(s=>{
        matched.add(s.id);
        const li=document.createElement('li');
        li.innerHTML = `<a class="slotbtn" href="${s.url}" target="_blank" rel="noopener" aria-label="Register for ${item.title} on ${fmtDate(s.start)}">
            <div>
              <time datetime="${s.start}">${fmtDate(s.start)}</time>
              <div class="meta">${s.location||''}</div>
            </div>
            <div class="right">Register →</div>
          </a>`;
        slotsEl.appendChild(li);
      });
    }
  });

  // Auto-section for any sessions with dates/times not mapped above
  const extras = feed.filter(s=> withinWindow(s.start) && (s.id? !matched.has(s.id) : true));
  if(extras.length){
    container.appendChild(makeTitleCard('Additional classes with dates','Auto‑discovered from the Enrollware snapshot','faid'));
    const byTitle = new Map();
    extras.forEach(s=>{ const key=(s.title||'Other').slice(0,120); if(!byTitle.has(key)) byTitle.set(key,[]); byTitle.get(key).push(s); });
    byTitle.forEach((list,title)=>{
      const el=document.createElement('div'); el.className='card course'; const keySlug=slug(title);
      el.id = `card-extra-${keySlug}`;
      el.innerHTML = `<h3 id="h-extra-${keySlug}">${title}</h3>
        <details id="d-extra-${keySlug}" open>
          <summary>Upcoming sessions</summary>
          <ul class="slots" id="slots-extra-${keySlug}"></ul>
        </details>`;
      const ul = el.querySelector('#slots-extra-'+keySlug);
      list.sort((a,b)=> new Date(a.start)-new Date(b.start)).forEach(s=>{
        const li=document.createElement('li');
        li.innerHTML = `<a class="slotbtn" href="${s.url}" target="_blank" rel="noopener" aria-label="Register for ${title} on ${fmtDate(s.start)}">
            <div>
              <time datetime="${s.start}">${fmtDate(s.start)}</time>
              <div class="meta">${s.location||''}</div>
            </div>
            <div class="right">Register →</div>
          </a>`;
        ul.appendChild(li);
      });
      container.appendChild(el);
    });
  }

  applyOpenFromURL(map);
}

function applyOpenFromURL(map){
  const hash=decodeURIComponent(location.hash.replace('#',''));
  if(hash && map.has(hash)){
    const d=map.get(hash);
    if(d){ d.setAttribute('open',''); const card=document.getElementById(`card-${hash}`); if(card){ card.scrollIntoView({behavior:'smooth',block:'start'}); } }
  }
}

// ==========================
// BOOT
// ==========================
(async function init(){
  const grid=document.getElementById('courseGrid');
  FEED = await loadFeed();
  renderCatalog(grid, FEED);
  await loadSnippets();
  if(!FEED.length){
    const warn=document.createElement('div');
    warn.className='note';
    warn.style.color='#ffcccc';
    warn.style.fontWeight='700';
    warn.style.marginTop='12px';
    warn.textContent=`No sessions loaded. Check docs/data/schedule.json or docs/data/enrollware-schedule.html. Detail: ${FEED_ERROR||'n/a'}`;
    document.querySelector('.wrap').appendChild(warn);
  }
})();

window.addEventListener('hashchange',()=>{
  const grid=document.getElementById('courseGrid');
  const map=new Map([...grid.querySelectorAll('details[id^="d-"]')].map(d=>[d.id.slice(2),d]));
  applyOpenFromURL(map);
});
</script>

<!-- inject per‑course HTML snippets into Course Description areas -->
<script>
async function loadSnippets(){
  const fetchOne=async(key)=>{
    const file=CONFIG.snippetRoot + slug(key) + '.html';
    try{
      const r=await fetch(file,{cache:'no-store'});
      if(!r.ok) return; 
      const html=await r.text();
      const el=document.getElementById('desc-'+slug(key));
      if(el){ el.innerHTML=html; }
    }catch(e){/* ignore */}
  };
  await Promise.all(CATALOG.filter(c=>c.type==='course').map(c=>fetchOne(c.key)));
}

// ==========================
// Minimal self-tests (do not affect UI)
// ==========================
console.assert(slug('AHA - BLS Provider - In-person Initial')==='aha---bls-provider---in-person-initial','slug() failed');
console.assert((()=>{const now=new Date(); const d=new Date(now.getTime()+3*86400000).toISOString(); return !!d;})(),'date smoke');
(function testWithin(){
  const now=new Date();
  const in3d=new Date(now.getTime()+3*86400000).toISOString();
  const in60d=new Date(now.getTime()+60*86400000).toISOString();
  console.assert(withinWindow(in3d)===true,'withinWindow short range');
  console.assert(withinWindow(in60d)===false,'withinWindow beyond window');
})();
</script>
</body>
</html>

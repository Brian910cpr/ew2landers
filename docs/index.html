<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>910CPR – Courses & Schedule (Nested Curtains)</title>

  <!-- GA4 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-45PBWBK7KR"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);} 
    gtag('js', new Date());
    gtag('config', 'G-45PBWBK7KR');
  </script>

  <!-- GTM -->
  <script>
    (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-K58Z4XD');
  </script>
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-K58Z4XD" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>

  <style>
    :root{--ink:#0a1b2b;--bg:#f6f9fc;--card:#fff;--edge:#dce9f7;--hover:#f3f8ff;--badge:#eef6ff;--brand:#0b66c3;--ok:#0a7d27;--err:#b00020}
    body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:var(--bg);color:var(--ink)}
    .wrap{max-width:1000px;margin:auto;padding:20px}
    .status{margin:0;padding:10px 16px;font-size:14px}
    .status.ok{background:#e8f7ee;color:var(--ok);border-bottom:1px solid #cfe8d7}
    .status.err{background:#fde9ec;color:var(--err);border-bottom:1px solid #f3c7cf}
    .muted{opacity:.7}
    details{margin:8px 0;border-radius:10px;box-shadow:0 3px 10px rgba(0,0,0,.05)}
    details>summary{cursor:pointer;padding:10px 16px;font-weight:700;background:var(--card)}
    details[open]>summary{background:#eaf3ff}
    .subgrid{padding:10px 20px;background:var(--card)}
    .badge{display:inline-block;background:var(--badge);color:var(--brand);border:1px solid #cfe2f9;border-radius:999px;padding:3px 9px;font-size:12px;margin-right:6px}
    .enrclass-list{list-style:none;padding:0;margin:10px 0}
    .enrclass-list li{margin:6px 0}
    .enrclass-list a{display:flex;flex-direction:column;gap:4px;border:1px solid var(--edge);border-radius:10px;padding:8px 10px;text-decoration:none;color:var(--ink);background:var(--card)}
    .enrclass-list a:hover{background:var(--hover);border-color:#b9d6f9}
    .btn{display:inline-block;margin-top:8px;border:1px solid var(--edge);border-radius:8px;padding:6px 10px;text-decoration:none;color:var(--brand);background:var(--card)}
    .meta{font-size:12px;color:#466;margin:6px 0 0}
  </style>
</head>
<body>
  <div class="wrap"></div>

  <script>
    function parseDateFromText(t){
      if(!t) return null;
      const line=String(t).split('\n')[0].replace(/^\s*[A-Za-z]+,\s*/,'').trim();
      const d=Date.parse(line);
      return isNaN(d)?null:new Date(d);
    }
    function limitUlToWindow(ul,maxDays=28,maxItems=10){
      if(!ul) return ul;
      const cutoff=new Date(); cutoff.setDate(cutoff.getDate()+maxDays);
      const lis=[...ul.querySelectorAll(':scope>li')];
      let kept=0,total=0;
      for(const li of lis){
        total++;
        const a=li.querySelector('a');
        const dt=parseDateFromText(a?.textContent||li.textContent||'');
        if(dt && dt<=cutoff && kept<maxItems){ kept++; continue; }
        li.remove();
      }
      return {ul,kept,total};
    }
    function textContains(s,...needles){const n=(s||'').toLowerCase();return needles.some(h=>n.includes(String(h).toLowerCase()));}
    function detectBody(title,desc){
      const t=(title||'')+' '+(desc||'');
      if(textContains(t,'american heart','aha'))return'AHA';
      if(textContains(t,'red cross','arc'))return'ARC';
      if(textContains(t,'hsi','health & safety institute'))return'HSI';
      if(textContains(t,'uscg','coast guard'))return'USCG';
      return '';
    }
    function detectSection(title,desc){
      const s=(title+' '+(desc||'')).toLowerCase();
      if(s.includes('bls'))return'BLS';
      if(s.includes('acls'))return'ACLS';
      if(s.includes('pals'))return'PALS';
      if(s.includes('uscg')||s.includes('stop the bleed')||s.includes('osha')||s.includes('bleed'))return'OSHA/USCG/STB';
      if(s.includes('first aid')||s.includes('cpr')||s.includes('aed')||s.includes('heartsaver'))return'CPR/AED/First Aid';
      return'Other';
    }
    function wireCurtains(rootSel){
      document.querySelectorAll(rootSel).forEach(sec=>{
        sec.addEventListener('toggle',()=>{
          if(sec.open){
            document.querySelectorAll(rootSel).forEach(d=>{if(d!==sec)d.open=false;});
            const top=sec.getBoundingClientRect().top+window.scrollY-12;
            window.scrollTo({top,behavior:'smooth'});
          }
        });
      });
      document.querySelectorAll('.sub').forEach(sub=>{
        sub.addEventListener('toggle',()=>{
          if(sub.open){
            const top=sub.getBoundingClientRect().top+window.scrollY-12;
            window.scrollTo({top,behavior:'smooth'});
          }
        });
      });
    }
    async function loadSnapshotHTML(){
      const here=location.pathname;
      const base=here.replace(/[^/]+$/,''); // directory of this page
      const tryPaths=[
        base+'data/enrollware-schedule.html',
        '/ew2landers/data/enrollware-schedule.html'
      ];
      const tried=[];
      for(const url of tryPaths){
        try{
          const res=await fetch(url,{mode:'same-origin',credentials:'omit',cache:'no-cache'});
          if(res.ok){ return {html:await res.text(), url, tried}; }
          tried.push(url+' ('+res.status+')');
        }catch(e){ tried.push(url+' (fetch error)'); }
      }
      return {html:null,url:null,tried};
    }

    document.addEventListener('DOMContentLoaded', async ()=>{
      const host=document.querySelector('.wrap');
      const status=document.createElement('div'); status.className='status';
      host.parentNode.insertBefore(status, host);

      const load=await loadSnapshotHTML();
      if(!load.html){
        status.className='status err';
        status.innerHTML='<strong>Could not load schedule snapshot.</strong><br><span class="muted">Tried:</span> '+(load.tried.join(' → '));
        return;
      }

      const dom=document.createElement('div'); dom.innerHTML=load.html;
      const panels=[...dom.querySelectorAll('.enrpanel')];
      const courses=[];
      let skippedNoTitle=0, skippedNoDates=0;

      for(const p of panels){
        const anchor=p.querySelector('[id^="ct"],[name^="ct"]');
        const id=anchor?.id||anchor?.getAttribute('name')||'';
        const title=(p.querySelector('.enrpanel-heading,h1,h2,h3,h4')?.textContent||'').trim();
        const body=p.querySelector('.enrpanel-body');
        if(!title){ skippedNoTitle++; continue; }

        const descClone=body?body.cloneNode(true):null;
        if(descClone){ const u=descClone.querySelector('ul.enrclass-list'); if(u) u.remove(); }
        const descHTML=descClone?(descClone.innerHTML||'').trim():'';

        const ul=p.querySelector('ul.enrclass-list');
        if(!ul){ skippedNoDates++; continue; }
        const ulClone=ul.cloneNode(true);
        const trimmed=limitUlToWindow(ulClone,28,10);
        courses.push({id,title,descHTML,ul:trimmed.ul,kept:trimmed.kept,total:trimmed.total});
      }

      const buckets={BLS:[],ACLS:[],PALS:[],"CPR/AED/First Aid":[],"OSHA/USCG/STB":[],Other:[]};
      for(const c of courses){ buckets[detectSection(c.title,c.descHTML)].push(c); }

      host.innerHTML='<h1>910CPR Courses & Schedule</h1><p class="meta">Loaded snapshot: '+(load.url||'(unknown)')+'</p>';

      for(const [section,list] of Object.entries(buckets)){
        if(!list.length) continue;
        const sec=document.createElement('details'); sec.className='curtain';
        sec.innerHTML=`<summary>${section} (${list.length}) <span class="chev">▼</span></summary><div class="subgrid"></div>`;
        const grid=sec.querySelector('.subgrid');

        for(const course of list){
          const sub=document.createElement('details'); sub.className='sub';
          const src='https://coastalcprtraining.enrollware.com/schedule#'+course.id;
          const bodyLabel=detectBody(course.title,course.descHTML);
          const badge=bodyLabel?`<span class="badge">${bodyLabel}</span>`:'';
          const hint=(course.total>course.kept)
            ? `<div class="meta">Showing ${course.kept} of ${course.total} (~4 weeks). <a class="btn" href="${src}">See all dates</a></div>`
            : `<div class="meta">All upcoming dates shown.</div>`;
          sub.innerHTML=`
            <summary>${course.title} <span class="chev">▼</span></summary>
            <div class="body">
              <h4>${course.title}</h4>
              ${badge}
              <div class="desc">${course.descHTML}</div>
              <ul class="enrclass-list"></ul>
              ${hint}
            </div>`;
          sub.querySelector('.enrclass-list').replaceWith(course.ul);
          grid.appendChild(sub);
        }
        host.appendChild(sec);
      }

      status.className='status ok';
      const counts=Object.entries(buckets).map(([k,v])=>`${k}:${v.length}`).join(' • ');
      status.innerHTML=`<strong>Status:</strong> Loaded ${courses.length} courses from ${panels.length} panels. Buckets → ${counts}. Skipped (no title:${skippedNoTitle}, no dates:${skippedNoDates}).`;

      wireCurtains('details.curtain');
    });
  </script>
</body>
</html>

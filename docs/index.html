<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>CPR, BLS, ACLS & First Aid — Wilmington / Burgaw</title>
  <style>
    :root{
      --bg1:#ffffff;
      --bg2:#eaf4ff;
      --card:#ffffff;
      --ink:#0b1b2a;
      --muted:#5b6b7a;
      --line:#d7e3f0;
      --brand:#0b5fa5;
      --brand2:#083b64;
      --ok:#0c6b52;
      --shadow: 0 14px 40px rgba(10,35,60,.12);
      --radius:18px;
      --max: 1240px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--ink);
      background: linear-gradient(180deg,var(--bg1),var(--bg2));
      min-height: 100vh;
    }
    img{max-width:100%;height:auto;}

    /* Layout */
    .wrap{
      width: min(var(--max), 100%);
      margin: 0 auto;
      padding: 18px 14px 30px;
    }

    /* Header */
    .topbar{
      position: sticky;
      top: 0;
      z-index: 50;
      background: #fff;
      border-bottom: 1px solid var(--line);
      box-shadow: 0 6px 16px rgba(10,35,60,.06);
    }
    .topbarInner{
      width: min(var(--max), 100%);
      margin: 0 auto;
      padding: 10px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      min-width:0;
    }
    .brand img{ height:34px; width:auto; display:block; border-radius:8px; }
    .brandText{ display:flex; flex-direction:column; min-width:0; line-height:1.12; }
    .brandText strong{ font-weight:950; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .brandText span{ color:var(--muted); font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    .top-actions{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .btn{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: #fff;
      color: var(--ink);
      font-weight: 950;
      font-size: 13px;
      text-decoration:none;
      box-shadow: 0 1px 0 rgba(10,35,60,.04);
      cursor:pointer;
    }
    .btn.primary{
      background: linear-gradient(90deg, var(--brand2), var(--brand));
      color:#fff;
      border-color: rgba(11,95,165,.25);
    }
    .btn.hasIcon{ display:inline-flex; align-items:center; gap:8px; }
    .btn.hasIcon img{ width:18px; height:18px; object-fit:contain; display:block; }

    /* Main 2-column layout */
    .grid{
      display:grid;
      grid-template-columns: 360px 1fr;
      gap: 16px;
      align-items:start;
      margin-top: 14px;
    }
    .panel{
      background: #fff;
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panel > .pad{ padding: 14px; }
    h2{
      margin:0;
      font-size: 16px;
      font-weight: 950;
    }
    .hint{
      margin:6px 0 0;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.25;
    }
    .searchBox{
      margin-top:10px;
      width:100%;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid var(--line);
      outline:none;
      font-size: 14px;
    }

    /* Step 1 families */
    .families{ padding: 12px; display:flex; flex-direction:column; gap: 10px; }
    .family{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 12px;
      border-radius: 16px;
      border: 1px solid var(--line);
      cursor:pointer;
      background: #fff;
    }
    .family.active{ background: #f1f8ff; border-color: #bcd6ef; }
    .family .left{ min-width:0; }
    .family strong{ display:block; font-size: 14px; font-weight: 950; }
    .family small{ display:block; font-size: 12px; color: var(--muted); line-height:1.2; }
    .family .count{
      font-weight: 950;
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #c7d9ee;
      background: #f7fbff;
    }
    .family .img{
      width: 44px; height: 44px;
      border-radius: 12px;
      object-fit: cover;
      border: 1px solid rgba(0,0,0,.06);
      flex: 0 0 auto;
    }

    /* Step 2 cards */
    .notice{
      margin: 10px 14px 0;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px dashed #c7d9ee;
      background: #f7fbff;
      font-size: 13px;
      color: #17324a;
    }

    .cards{ padding: 12px; display:flex; flex-direction:column; gap: 12px; }
    .courseCard{
      border-radius: 18px;
      overflow:hidden;
      border: 1px solid var(--line);
      background:#fff;
      box-shadow: 0 10px 26px rgba(10,35,60,.08);
    }
    .course-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 12px 14px;
      background: linear-gradient(90deg, var(--brand2), var(--brand));
      color:#fff;
    }
    .course-title{ min-width:0; }
    .titleLine{
      font-weight: 950;
      font-size: 14px;
      line-height: 1.15;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .subLine{
      margin-top:2px;
      font-size: 12px;
      opacity:.9;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .course-head-right{ display:flex; gap: 10px; align-items:center; }
    .pillBtn{
      border: 1px solid rgba(255,255,255,.35);
      background: rgba(255,255,255,.14);
      color:#fff;
      font-weight: 950;
      font-size: 12px;
      padding: 8px 12px;
      border-radius: 999px;
      cursor:pointer;
    }
    .pillLink{
      border: 1px solid rgba(255,255,255,.35);
      background: rgba(255,255,255,.08);
      color:#fff;
      font-weight: 950;
      font-size: 12px;
      padding: 8px 12px;
      border-radius: 999px;
      text-decoration:none;
      white-space:nowrap;
    }

    .sessions{
      display:none;
      flex-direction:column;
      gap: 10px;
      padding: 12px 14px 14px;
      background: #fff;
    }
    .session{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 12px;
      border-radius: 16px;
      border: 1px solid var(--line);
      background: #fff;
    }
    .session .when{ min-width:0; }
    .session strong{ display:block; font-size: 13px; font-weight: 950; }
    .session small{ display:block; color: var(--muted); font-size: 12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width: 56ch; }
    .reg{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding: 10px 14px;
      border-radius: 999px;
      background: var(--ok);
      color:#fff;
      font-weight: 950;
      text-decoration:none;
      border: 0;
      cursor:pointer;
      white-space:nowrap;
    }

    .session.moreRow{ align-items:center; }
    .session .reg.moreBtn{ display:inline-flex; align-items:center; justify-content:center; }

    /* Theme center decoration (fixed path) */
    .themeCenter{
      position: fixed;
      inset: 0;
      pointer-events:none;
      background:
        url("./assets/images/theme/default-divider.png") center 26% / 900px auto no-repeat;
      opacity: 0.07;
      z-index: 0;
    }

    .pageLayer{ position:relative; z-index: 2; }

    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="themeCenter" aria-hidden="true"></div>

  <div class="topbar">
    <div class="topbarInner">
      <div class="brand">
        <img src="./assets/images/910CPR_wave.jpg" alt="910CPR">
        <div class="brandText">
          <strong>CPR, BLS, ACLS &amp; First Aid — Wilmington / Burgaw</strong>
          <span>Live &amp; blended classes with fast certificates — powered by 910CPR</span>
        </div>
      </div>

      <div class="top-actions">
        <a class="btn hasIcon" href="./onsite.html">
          <img src="./assets/images/classroom_icon.png" alt="">
          <strong>Group Class Quote / Inquiry</strong>
        </a>

        <a class="btn primary hasIcon" href="tel:+19103955193">
          <img src="./assets/images/phone_icon.png" alt="">
          <strong>Call or text (910) 395-5193</strong>
        </a>

        <a class="btn hasIcon" href="mailto:info@910cpr.com">
          <img src="./assets/images/email-icon.png" alt="">
          <strong>Email 910CPR</strong>
        </a>

        <a class="btn" href="./index-mobile.html"><strong>Mobile view</strong></a>
      </div>
    </div>
  </div>

  <div class="wrap pageLayer">
    <div class="grid">
      <section class="panel">
        <div class="pad">
          <h2>Step 1: Choose a class family</h2>
          <input id="familySearch" class="searchBox" placeholder="Search (BLS, ACLS, Heartsaver, OSHA…)" />
        </div>
        <div id="families" class="families"></div>
      </section>

      <section class="panel">
        <div class="pad">
          <h2>Step 2: Pick the exact class</h2>
          <div class="hint">Upcoming sessions are shown first. Courses are collapsed by default — expand the one you want.</div>
        </div>
        <div id="status" class="notice">Loading schedule…</div>
        <div id="cards" class="cards"></div>
      </section>
    </div>
  </div>

  <embeddable-voice id="1cf9bf8f-38da-437e-abfb-efa1ce9a02ff"></embeddable-voice>
  <script src="https://cdn.247aireceptionist.com/script.js"></script>

  <script>
    // Per-course paging: start with 10 visible, then add +10 each time.
    const VISIBLE_LIMIT = new Map(); // key -> number
    function getLimit(key, total){
      const cur = VISIBLE_LIMIT.get(String(key));
      const base = Math.min(10, total);
      return Math.min(cur ?? base, total);
    }
    function bumpLimit(key, total){
      const next = Math.min(getLimit(key, total) + 10, total);
      VISIBLE_LIMIT.set(String(key), next);
      return next;
    }

    const ENROLLWARE_SITE = "https://coastalcprtraining.enrollware.com/schedule";

    const DATA_URL = "./data/schedule.json";
    const COURSE_DESC_URL = "./data/course-descriptions.json";

    const elFamilies = document.getElementById("families");
    const elFamilySearch = document.getElementById("familySearch");
    const elStatus = document.getElementById("status");
    const elCards = document.getElementById("cards");

    const FAMILY_META = [
      { key:"ACLS", label:"ACLS", desc:"Advanced cardiac life support for clinical teams.", img:"./assets/images/family/family-acls.jpg" },
      { key:"BLS", label:"BLS", desc:"Healthcare CPR for nurses, EMS, CNA, and students.", img:"./assets/images/family/family-bls.jpg" },
      { key:"PALS", label:"PALS", desc:"Pediatric advanced life support for providers.", img:"./assets/images/family/family-pals.jpg" },
      { key:"Heartsaver / CPR-AED", label:"Heartsaver / CPR-AED", desc:"Workplace & community CPR/AED training.", img:"./assets/images/family/family-cpr-aed.jpg" },
      { key:"First Aid", label:"First Aid", desc:"Practical first aid skills for jobsite readiness.", img:"./assets/images/family/family-fa-cpr-aed.jpg" },
      { key:"Other", label:"Other", desc:"Specialty, blended, and custom programs.", img:"./assets/images/family/family-bls.jpg" }
    ];

    const FAMILY_BY_KEY = new Map(FAMILY_META.map(x => [x.key, x]));
    const FAMILY_ORDER = FAMILY_META.map(x => x.key);

    let SCHEDULE = null;
    let COURSE_DESCS = null;
    let GROUPS = [];
    let ACTIVE_FAMILY = "BLS";

    function escapeHtml(s){
      return String(s ?? "")
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;")
        .replace(/'/g,"&#039;");
    }

    function withCacheBust(url){
      const u = new URL(url, location.href);
      u.searchParams.set("_", String(Date.now()));
      return u.toString();
    }

    function safeFetchJson(url){
      return fetch(withCacheBust(url), { cache:"no-store" }).then(r => {
        if(!r.ok) throw new Error(`HTTP ${r.status}`);
        return r.json();
      });
    }

    function normalizeFamilyKey(k){
      const s = String(k||"").trim();
      if(!s) return "Other";
      if(FAMILY_BY_KEY.has(s)) return s;
      return "Other";
    }

    function pickLocation(row){
      const raw = (row.location || row.where || row.place || row.city || "").trim();
      return raw || "NC";
    }

    function pickRegisterUrl(row){
      return row.registerUrl || row.enrollUrl || row.url || row.link || "";
    }

    function fmtWhen(ms){
      try{
        const d = new Date(ms);
        const opt = { weekday:"long", year:"numeric", month:"long", day:"numeric", hour:"numeric", minute:"2-digit" };
        return d.toLocaleString(undefined, opt).replace(":00 ", " ");
      }catch{ return "Date/time"; }
    }

    function toMillis(row){
      const ms = row.ms ?? row.start_ms ?? row.startMs;
      if(Number.isFinite(ms)) return ms;
      const iso = row.iso ?? row.start_iso ?? row.startIso ?? row.start;
      if(iso){
        const t = Date.parse(iso);
        if(Number.isFinite(t)) return t;
      }
      return null;
    }

    function cleanTitle(s){
      return String(s||"").replace(/\s+/g," ").trim();
    }

    function getCourseDesc(courseId){
      if(!COURSE_DESCS) return "";
      return COURSE_DESCS[String(courseId)] || COURSE_DESCS[Number(courseId)] || "";
    }

    function buildGroups(){
      const groups = [];
      const rows = (SCHEDULE?.sessions || SCHEDULE?.classes || SCHEDULE || []);
      const byKey = new Map();

      for(const r of rows){
        const family = normalizeFamilyKey(r.family || r.familyKey || r.bucket || r.category);
        const key = r.courseKey || r.courseId || r.course_id || r.course || r.key || r.ct || r.typeKey || r.title || r.name;
        const k = String(key || "").trim();
        if(!k) continue;

        const g = byKey.get(k) || {
          key: k,
          family,
          title: cleanTitle(r.title || r.name || r.courseName || r.course_title || "Course"),
          desc: "",
          scheduleUrl: r.scheduleUrl || r.courseScheduleUrl || r.schedule || "",
          sessions: []
        };
        g.family = family;
        g.title = cleanTitle(r.title || r.name || r.courseName || r.course_title || g.title);

        g.sessions.push(r);

        byKey.set(k, g);
      }

      for(const g of byKey.values()){
        g.sessions.sort((a,b) => (toMillis(a)||0) - (toMillis(b)||0));
        const maybeCourseId = g.sessions[0]?.courseId || g.sessions[0]?.course_id || g.sessions[0]?.courseKey || g.key;
        g.desc = getCourseDesc(maybeCourseId) || g.sessions[0]?.subtitle || g.sessions[0]?.desc || "";
        groups.push(g);
      }

      groups.sort((a,b) => a.title.localeCompare(b.title));
      GROUPS = groups;
    }

    function renderFamilies(){
      const q = String(elFamilySearch.value||"").trim().toLowerCase();
      elFamilies.innerHTML = "";

      const counts = new Map();
      for(const g of GROUPS){
        counts.set(g.family, (counts.get(g.family)||0) + g.sessions.length);
      }

      for(const famKey of FAMILY_ORDER){
        const meta = FAMILY_BY_KEY.get(famKey);
        const label = meta?.label || famKey;
        const desc = meta?.desc || "";
        const count = counts.get(famKey) || 0;

        if(q && !(label.toLowerCase().includes(q) || desc.toLowerCase().includes(q))) continue;

        const div = document.createElement("div");
        div.className = "family" + (famKey === ACTIVE_FAMILY ? " active" : "");
        div.dataset.key = famKey;

        div.innerHTML = `
          <div class="left">
            <strong>${escapeHtml(label)}</strong>
            <small>${escapeHtml(desc)}</small>
          </div>
          <img class="img" src="${escapeHtml(meta?.img || "./assets/images/family/family-bls.jpg")}" alt="">
        `;

        div.addEventListener("click", () => {
          ACTIVE_FAMILY = famKey;
          renderFamilies();
          renderCards();
        });

        elFamilies.appendChild(div);

        // (Removed session counts per your earlier request)
      }
    }

    function setCollapsed(sessionsEl, toggleBtn, collapsed){
      sessionsEl.style.display = collapsed ? "none" : "flex";
      toggleBtn.textContent = collapsed ? "SHOW 10" : "HIDE";
      toggleBtn.dataset.collapsed = collapsed ? "true" : "false";
      toggleBtn.setAttribute("aria-expanded", collapsed ? "false" : "true");
    }

    function closeAllExcept(key){
      document.querySelectorAll(".sessions[data-key]").forEach(el => {
        if (el.dataset.key !== key) el.style.display = "none";
      });
      document.querySelectorAll("button.pillBtn[data-key]").forEach(btn => {
        if (btn.dataset.key !== key){
          btn.textContent = "SHOW 10";
          btn.dataset.collapsed = "true";
          btn.setAttribute("aria-expanded","false");
        }
      });
    }

    function renderCards(){
      const groups = GROUPS.filter(g => g.family === ACTIVE_FAMILY);

      elCards.innerHTML = "";

      if (groups.length === 0){
        elStatus.className = "notice";
        elStatus.textContent = "No upcoming sessions found for this family.";
        return;
      }

      elStatus.className = "notice";
      elStatus.textContent = `Showing upcoming sessions for: ${ACTIVE_FAMILY}`;

      for (const g of groups){
        const card = document.createElement("article");
        card.className = "courseCard";

        const titleHtml = escapeHtml(g.title);
        const descHtml = g.desc ? escapeHtml(g.desc) : "";

        const head = document.createElement("div");
        head.className = "course-head";

        const left = document.createElement("div");
        left.className = "course-title";
        left.innerHTML = `
          <div class="titleLine">${titleHtml}</div>
          ${descHtml ? `<div class="subLine">${descHtml}</div>` : ``}
        `;

        const right = document.createElement("div");
        right.className = "course-head-right";

        const toggle = document.createElement("button");
        toggle.type = "button";
        toggle.className = "pillBtn";
        toggle.dataset.key = String(g.key);

        const more = document.createElement("a");
        more.className = "pillLink";
        more.textContent = "See all dates";
        more.href = g.scheduleUrl || "#";
        more.target = "_blank";
        more.rel = "noopener";
        if (!g.scheduleUrl) more.style.display = "none";

        right.appendChild(toggle);
        right.appendChild(more);

        // Click anywhere on the blue header to expand/collapse (except on buttons/links)
        head.style.cursor = "pointer";
        head.addEventListener("click", (ev) => {
          if (ev.target.closest("button,a")) return;
          toggle.click();
        });

        head.appendChild(left);
        head.appendChild(right);

        const sessions = document.createElement("div");
        sessions.className = "sessions";
        sessions.dataset.key = String(g.key);

        toggle.addEventListener("click", () => {
          const collapsed = toggle.dataset.collapsed !== "false";
          if (collapsed) closeAllExcept(String(g.key));
          setCollapsed(sessions, toggle, !collapsed);
        });

        // Render sessions (first 10, then bottom pager shows next 10)
        const __limit = getLimit(g.key, g.sessions.length);
        for (const r of g.sessions.slice(0, __limit)){
          const ms = toMillis(r);
          const when = ms ? fmtWhen(ms) : "Date/time";
          const where = pickLocation(r);
          const regUrl = pickRegisterUrl(r);

          const row = document.createElement("div");
          row.className = "session";
          row.innerHTML = `
            <div class="when">
              <strong>${escapeHtml(when)}</strong>
              <small>${escapeHtml(where)}</small>
            </div>
            <a class="reg" href="${escapeHtml(regUrl || "#")}" target="_blank" rel="noopener">Register now</a>
          `;
          sessions.appendChild(row);
        }

        // Bottom pager: show next 10 without leaving the page
        if (g.sessions.length > __limit){
          const moreRow = document.createElement("div");
          moreRow.className = "session moreRow";
          moreRow.innerHTML = `<div class="when"><strong>See more times…</strong><small>Show the next ${Math.min(10, g.sessions.length-__limit)} session(s)</small></div>`;
          const moreBtn = document.createElement("button");
          moreBtn.type = "button";
          moreBtn.className = "reg moreBtn";
          moreBtn.textContent = `Show next ${Math.min(10, g.sessions.length-__limit)}`;
          moreBtn.addEventListener("click", (ev) => {
            ev.preventDefault();
            ev.stopPropagation();
            bumpLimit(g.key, g.sessions.length);
            renderCards();
            // keep this course open
            const btn = document.querySelector(`button.pillBtn[data-key="${String(g.key)}"]`);
            const sess = document.querySelector(`.sessions[data-key="${String(g.key)}"]`);
            if (btn && sess) setCollapsed(sess, btn, false);
          });
          moreRow.appendChild(moreBtn);
          sessions.appendChild(moreRow);
        }

        setCollapsed(sessions, toggle, true);

        card.appendChild(head);
        card.appendChild(sessions);
        elCards.appendChild(card);
      }
    }

    async function boot(){
      try{
        SCHEDULE = await safeFetchJson(DATA_URL);
      }catch(e){
        elStatus.className = "notice";
        elStatus.innerHTML = `
          <div style="font-weight:950;margin-bottom:8px;">Schedule feed unavailable.</div>
          <div style="margin-bottom:10px;">${escapeHtml(e?.message || String(e))}</div>
          <a class="btn" href="${ENROLLWARE_SITE}#view=calendar" target="_blank" rel="noopener">
            Open Enrollware schedule
          </a>
        `;
        return;
      }

      try{
        COURSE_DESCS = await safeFetchJson(COURSE_DESC_URL);
      }catch{
        COURSE_DESCS = {};
      }

      buildGroups();
      renderFamilies();
      renderCards();
    }

    elFamilySearch.addEventListener("input", renderFamilies);
    boot();
  </script>
</body>
</html>

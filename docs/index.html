<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>910CPR Courses</title>
  <style>
    :root{
      --bg:#0b1320; --ink:#eaf2ff; --muted:#9fb6e8;
      --brand:#1373d1; --accent:#0f61bb; --shadow:0 2px 16px rgba(6,10,18,.35);
      --radius:18px; --bls:#b6d4ff; --acls:#ff7474; --pals:#c59eff; --faid:#7eb0ff;
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    a{color:var(--brand);text-decoration:none} a:hover{color:var(--accent)}
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin:8px 0 8px;position:sticky;top:0;z-index:10;background:linear-gradient(180deg, rgba(11,19,32,1) 0%, rgba(11,19,32,0.85) 100%);backdrop-filter:saturate(1.1) blur(2px)}
    header h1{font-size:clamp(22px,3.5vw,34px);margin:0;font-weight:750}
    .nav{display:flex;gap:14px;flex-wrap:wrap;align-items:center}
    .nav a{display:inline-flex;align-items:center;gap:6px;padding:8px 10px;border:1px solid #243349;border-radius:12px;background:#0e1726;color:var(--ink);font-weight:650}
    .nav a[target="_blank"]::after{content:" ↗";opacity:.7;font-weight:700}
    .nav a:hover{background:#122448;border-color:#2f416a}

    #dataStatus{font:13px/1.3 system-ui;color:#9fb6e8;margin:4px 0 18px}

    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
    .card{background:#0e1726;border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;display:flex;flex-direction:column;min-height:120px;border:1px solid #243349;position:relative}
    .card h3{margin:0 0 10px;padding-right:24px;display:flex;align-items:center;gap:8px}
    .card h3 .brandicon{height:22px;width:auto;object-fit:contain;display:inline-block;filter:drop-shadow(0 1px 1px rgba(0,0,0,.25))}
    .card.course:hover{outline:2px solid #2f416a;border-color:#2f416a;background:#0f1f39}
    .card.course{grid-column:span 6} @media(max-width:860px){.card.course{grid-column:span 12}}

    .card.title{grid-column:1 / -1;background:#0f1c33;color:var(--ink);border:1px solid #2a3b62;position:relative;overflow:hidden}
    .card.title::before{content:"";position:absolute;left:0;top:0;bottom:0;width:12px;background:#2a3b62}
    .card.title.bls::before{background:var(--bls)} .card.title.acls::before{background:var(--acls)}
    .card.title.pals::before{background:var(--pals)} .card.title.faid::before{background:var(--faid)}
    .card.title h2{margin:0 0 4px;font-size:clamp(18px,2.8vw,24px);padding-right:128px}
    .card.title small{color:var(--muted)}
    .card.title .famimg{position:absolute;right:16px;top:12px;height:calc(100% - 24px);width:auto;object-fit:contain;filter:drop-shadow(0 2px 4px rgba(0,0,0,.4));pointer-events:none}
    @media(max-width:640px){.card.title .famimg{max-height:44px;right:12px}}

    details{margin-top:auto}
    summary{cursor:pointer;list-style:none;display:flex;align-items:center;gap:8px;padding:10px 12px;border-radius:12px;background:#111e36;color:var(--ink);font-weight:700;border:1px solid #243349}
    summary:hover{background:#1a2b55;border-color:#3b5aa0}
    summary::-webkit-details-marker{display:none}
    details[open] summary{background:#122448;border-color:#2f416a}

    .desc{padding:10px 2px 2px;color:#bfd2ff}
    .slots{margin:8px 0 0;padding:0;list-style:none}
    .slots li{display:block;margin:10px 0}
    .slotbtn{display:flex;align-items:center;justify-content:space-between;width:100%;padding:14px;border-radius:12px;background:#152242;border:1px solid #2a3b62;color:var(--ink);text-decoration:none}
    .slotbtn:hover{background:#1a2b55;border-color:#385089}
    .slotbtn .meta{font-size:13px;color:#9fb6e8} .slotbtn .right{white-space:nowrap;margin-left:12px}

    .popular{display:grid;grid-template-columns:2fr 1fr;gap:20px;align-items:center;background:#0b1320;color:var(--ink);border-radius:20px;padding:18px;margin:8px 0 22px;border:1px solid #243349;box-shadow:var(--shadow)}
    .popular h2{margin:6px 0 10px;font-size:clamp(16px,2.2vw,20px);font-weight:750;color:#b6d4ff}
    .tiles{display:flex;flex-wrap:wrap;gap:10px}
    .tile{display:flex;flex-direction:column;justify-content:center;min-width:160px;padding:10px 12px;border-radius:12px;color:#001a4d;border:1px solid #2a3b62;box-shadow:inset 0 1px 0 rgba(255,255,255,.04)}
    .tile .t1{font-weight:800} .tile .t2{font-size:12px;opacity:.8;color:#eef3ff}
    .tile:hover{filter:brightness(1.15);box-shadow:0 0 0 2px rgba(0,0,0,.15) inset}
    .tile.bls{background:var(--bls)} .tile.acls{background:var(--acls);color:#2a0010}
    .tile.pals{background:var(--pals)} .tile.faid{background:var(--faid)}
    .popular .art{display:flex;align-items:center;justify-content:center;background:#fff;border-radius:16px;padding:12px}
    .popular .art img{max-width:100%;height:auto;border-radius:12px}

    .note{font-size:13px;color:#9fb6e8;margin-top:6px}
    .ok{color:#7fe1a9}.soft{color:#ffdd99}.bad{color:#ffc9c9}

    .brandrow{display:flex;justify-content:center;align-items:center;gap:28px;background:#ffffff;border:1px solid #e6eaf5;border-radius:20px;padding:14px;margin:0 0 12px;box-shadow:0 2px 16px rgba(6,10,18,.08)}
    .brandrow .badge{display:flex;align-items:center;justify-content:center;padding:8px 12px;border-radius:14px}
    .brandrow .badge img{height:56px;width:auto;object-fit:contain;display:block;filter:drop-shadow(0 2px 4px rgba(0,0,0,.15))}
    @media(max-width:640px){.brandrow .badge img{height:44px}}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>910CPR – Course Catalog</h1>
    <nav class="nav" aria-label="Primary">
      <a href="http://coastalcprtraining.com/about" target="_blank" rel="noopener">About</a>
      <a href="http://910cpr.com/" target="_blank" rel="noopener">Classes</a>
      <a href="http://coastalcprtraining.com/" target="_blank" rel="noopener">Coastal CPR Training</a>
      <a href="http://coastalcprtraining.com/on-site-training" target="_blank" rel="noopener">On Site Training</a>
    </nav>
  </header>

  <div id="dataStatus">Checking data status…</div>

  <section class="brandrow" aria-label="Certifying bodies">
    <div class="badge"><img src="https://www.enrollware.com/sitefiles/coastalcprtraining/111 aha-authorized-training-site.png" alt="AHA Authorized Training Site" /></div>
    <div class="badge"><img src="https://www.enrollware.com/sitefiles/coastalcprtraining/111 arc-ltp-logo.jpg" alt="American Red Cross Licensed Training Provider" /></div>
    <div class="badge"><img src="https://www.enrollware.com/sitefiles/coastalcprtraining/HSI.png" alt="HSI Training Center" /></div>
  </section>

  <section class="popular" aria-label="Most popular classes">
    <div>
      <h2>Most popular classes</h2>
      <div class="tiles">
        <a class="tile bls" href="#aha---bls-provider---in-person-renewal"><span class="t1">BLS</span><span class="t2">Initial or renewal; instructor-led</span></a>
        <a class="tile bls" href="#aha---bls-provider---heartcode"><span class="t1">BLS Online</span><span class="t2">Blended: online + in-person skills</span></a>
        <a class="tile acls" href="#aha---acls-provider---in-person---renewal"><span class="t1">ACLS</span><span class="t2">Fully in-person renewal</span></a>
        <a class="tile acls" href="#aha---acls-provider---heartcode"><span class="t1">ACLS Online</span><span class="t2">Initial (online + skills)</span></a>
        <a class="tile pals" href="#aha---pals-provider---in-person---renewal"><span class="t1">PALS</span><span class="t2">Fully in-person renewal</span></a>
        <a class="tile pals" href="#aha---pals-provider---heartcode"><span class="t1">PALS Online</span><span class="t2">Initial (online + skills)</span></a>
        <a class="tile faid" href="#hsi---first-aid-cpr-aed-classroom"><span class="t1">First Aid / CPR / AED</span><span class="t2">Fully in-person course</span></a>
        <a class="tile faid" href="#aha---heartsaver-online"><span class="t1">First Aid / CPR / AED Online</span><span class="t2">Flexible + fast (online + skills)</span></a>
      </div>
    </div>
    <div class="art"><img src="https://www.enrollware.com/sitefiles/coastalcprtraining/910CPR_wave.jpg" alt="910CPR wave logo banner"/></div>
  </section>

  <section id="courseGrid" class="grid" aria-live="polite"></section>
</div>

<script>
/* === helpers === */
function slug(s){ return String(s||'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,''); }
function fmtDate(dtISO){ const d=new Date(dtISO); const opt={weekday:'short',month:'short',day:'numeric',hour:'numeric',minute:'2-digit'}; return d.toLocaleString(undefined,opt); }
function withinWindow(dtISO,days){ if(!dtISO) return false; const s=new Date(dtISO); if(isNaN(s)) return false; const now=new Date(); const cap=new Date(now.getTime()+days*86400000); return s>=now && s<=cap; }
function familyFromTitle(t){ t=(t||'').toLowerCase(); if(t.includes('bls')) return 'bls'; if(t.includes('acls')) return 'acls'; if(t.includes('pals')) return 'pals'; return 'faid'; }

/* === config === */
const CONFIG={ windowDays:28, maxSessionsPerCourse:15, jsonFeed:"data/schedule.json", statusFile:"data/status.json" };
const IMG_BASE='https://www.enrollware.com/sitefiles/coastalcprtraining/';
const BRAND_LOGO={AHA:IMG_BASE+'_AHA.png','Red Cross':IMG_BASE+'_ARC.png',HSI:IMG_BASE+'_HSI.png'};
const FAMILY_IMG={bls:'25-bls-new.png',acls:'25-acls-new.png',pals:'25-pals-new.png',faid:'25_Heartsaver.png'};

function detectBrand(title=''){const t=title.toLowerCase(); if(t.includes('american red cross')||t.startsWith('arc')||t.includes('arc -')) return 'Red Cross'; if(t.includes('hsi')) return 'HSI'; if(t.includes('aha')||t.includes('american heart')) return 'AHA'; return null;}

/* === status line === */
(async function status(){ const el=document.getElementById('dataStatus'); try{ const r=await fetch(CONFIG.statusFile+'?v='+Date.now(),{cache:'no-store'}); if(!r.ok) throw 0; const st=await r.json(); const snap=st.snapshot||{}, sched=st.schedule||{}; const ok=snap.exists&&snap.bytes>0&&sched.exists&&sched.bytes>0; el.innerHTML=ok?`Data status: OK • updated ${st.updated_at} • schedule.json ${sched.bytes} bytes`:`Data status: INCOMPLETE • snapshot:${snap.exists?'yes':'no'} • schedule:${sched.exists?'yes':'no'}`; el.className=ok?'note ok':'note soft'; }catch{ el.textContent='Data status: unknown (fetch error).'; el.className='note bad'; }})();

/* === load feed and render by section === */
(async function main(){
  const grid=document.getElementById('courseGrid');
  let data=null;
  try{
    const r=await fetch(CONFIG.jsonFeed,{cache:'no-store'}); if(!r.ok) throw 0; data=await r.json();
  }catch{ showWarn('Could not load data/schedule.json'); return; }

  const sessions = Array.isArray(data)?data:(Array.isArray(data?.sessions)?data.sessions:[]);
  if(!sessions.length){ showWarn('No sessions found in schedule.json'); return; }

  // group by course_id (stable) → pick section mode, title, etc.
  const coursesMap=new Map();
  for(const s of sessions){
    if(!withinWindow(s.start, CONFIG.windowDays)) continue;
    const key = s.course_id || slug(s.course_title || s.title || '');
    const title = s.course_title || s.title || '';
    if(!key || !title) continue;
    if(!coursesMap.has(key)) coursesMap.set(key,{title,section:s.section||'',family:familyFromTitle(title),sessions:[]});
    coursesMap.get(key).sessions.push(s);
    // if section is empty, prefer the first non-empty we see
    if(!coursesMap.get(key).section && (s.section||'')) coursesMap.get(key).section = s.section;
  }
  // sort sessions for each course
  coursesMap.forEach(v=>v.sessions.sort((a,b)=>new Date(a.start)-new Date(b.start)));

  // render in fixed section order
  const sectionOrder=[
    'Healthcare Provider: BLS',
    'Healthcare Provider: ACLS',
    'Healthcare Provider: PALS',
    'Healthcare Provider: ASLS',
    'CPR / AED & First Aid',
    'CPR / AED Only',
    'Instructor Programs',
    'Other Programs'
  ];

  const coursesBySection=new Map();
  for(const sec of sectionOrder) coursesBySection.set(sec,[]);
  for(const v of coursesMap.values()){
    const sec = sectionOrder.find(s=> (v.section||'').toLowerCase().startsWith(s.toLowerCase())) || 'Other Programs';
    coursesBySection.get(sec).push(v);
  }
  // sort courses alphabetically inside a section
  for(const sec of sectionOrder){ coursesBySection.get(sec).sort((a,b)=>a.title.localeCompare(b.title)); }

  // renderer helpers
  function makeTitleCard(text,family){
    const el=document.createElement('div'); el.className='card title ' + (family||'');
    const img=(family && FAMILY_IMG[family])?`<img class="famimg" src="${IMG_BASE}${FAMILY_IMG[family]}" alt="${family} icon"/>`:'';
    el.innerHTML=`<h2>${text}</h2>${img}`; return el;
  }
  function courseCard(title, list){
    const brand=detectBrand(title);
    const keySlug=slug(title);
    const el=document.createElement('div'); el.className='card course'; el.id=`card-${keySlug}`;
    const brandSrc=brand && BRAND_LOGO[brand] ? BRAND_LOGO[brand] : '';
    const brandImg=brandSrc?`<img class="brandicon" src="${brandSrc}" alt="${brand} logo"/>`:'';
    el.innerHTML=`
      <h3 id="h-${keySlug}">${brandImg}<a href="#${keySlug}" style="text-decoration:none;color:inherit">${title}</a></h3>
      <details id="d-${keySlug}" data-key="${keySlug}">
        <summary>Course details & upcoming sessions</summary>
        <div class="desc" id="desc-${keySlug}"></div>
        <ul class="slots" id="slots-${keySlug}"></ul>
      </details>`;
    const ul=el.querySelector(`#slots-${keySlug}`);
    (list||[]).slice(0,CONFIG.maxSessionsPerCourse).forEach(s=>{
      const li=document.createElement('li');
      li.innerHTML=`<a class="slotbtn" href="${s.url}" target="_blank" rel="noopener" aria-label="Register for ${title} on ${fmtDate(s.start)}">
        <div><time datetime="${s.start}">${fmtDate(s.start)}</time><div class="meta">${s.location||''}</div></div>
        <div class="right">Register →</div>
      </a>`;
      ul.appendChild(li);
    });
    if(!(list||[]).length){ ul.innerHTML='<li class="note">No upcoming sessions in the next 4 weeks. See full schedule.</li>'; }
    return el;
  }

  // paint
  grid.innerHTML='';
  for(const sec of sectionOrder){
    const items=coursesBySection.get(sec);
    if(!items || !items.length) continue; // skip empty sections
    grid.appendChild(makeTitleCard(sec, familyFromTitle(sec)));
    for(const c of items){ grid.appendChild(courseCard(c.title, c.sessions)); }
  }

  function showHash(){
    const map=new Map([...grid.querySelectorAll('details[id^="d-"]')].map(d=>[d.id.slice(2),d]));
    const hash=decodeURIComponent(location.hash.replace('#','')); if(!hash) return;
    const det=map.get(hash); if(det){ det.setAttribute('open',''); det.closest('.card')?.scrollIntoView({behavior:'smooth',block:'start'}); det.querySelector('summary')?.focus?.(); }
  }
  showHash(); window.addEventListener('hashchange',showHash);
})();

function showWarn(msg){
  const w=document.createElement('div'); w.className='note bad'; w.textContent=msg;
  document.querySelector('.wrap').appendChild(w);
}
</script>
</body>
</html>

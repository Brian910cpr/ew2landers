<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>910CPR • Course Families</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg-top: #ffffff;
      --bg-bottom: #e9f4ff;
      --accent: #0b5ed7;
      --accent-soft: #e0ecff;
      --border-soft: #d0d7e2;
      --text-main: #16202a;
      --text-muted: #5f6b7a;
      --badge-bg: #f3f5f9;
      --badge-border: #c7cfdd;
      --danger: #b3261e;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: var(--text-main);
      background: linear-gradient(to bottom, var(--bg-top), var(--bg-bottom));
      min-height: 100vh;
    }

    .page {
      max-width: 1100px;
      margin: 0 auto;
      padding: 20px 16px 40px;
    }

    header {
      margin-bottom: 16px;
    }

    header h1 {
      margin: 0 0 4px;
      font-size: 1.8rem;
      letter-spacing: 0.03em;
    }

    header p {
      margin: 0;
      color: var(--text-muted);
      font-size: 0.95rem;
    }

    .status-bar {
      margin: 16px 0 24px;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border-soft);
      background: rgba(255, 255, 255, 0.85);
      font-size: 0.85rem;
      display: flex;
      flex-wrap: wrap;
      gap: 8px 16px;
      align-items: center;
    }

    .status-pill {
      padding: 2px 8px;
      border-radius: 999px;
      font-weight: 600;
      border: 1px solid var(--badge-border);
      background: var(--badge-bg);
    }

    .status-pill.ok {
      border-color: #2e7d32;
      color: #1b5e20;
      background: #e8f5e9;
    }

    .status-pill.warn {
      border-color: #f57c00;
      color: #e65100;
      background: #fff3e0;
    }

    .status-text span + span {
      margin-left: 12px;
    }

    .family-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 16px;
    }

    .family-card {
      border-radius: 14px;
      border: 1px solid var(--border-soft);
      background: rgba(255, 255, 255, 0.94);
      padding: 14px 14px 10px;
      box-shadow: 0 4px 10px rgba(9, 30, 66, 0.06);
      display: flex;
      flex-direction: column;
      min-height: 120px;
    }

    .family-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 6px;
      gap: 8px;
    }

    .family-name {
      font-weight: 700;
      font-size: 0.98rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--accent);
    }

    .family-meta {
      font-size: 0.78rem;
      color: var(--text-muted);
      white-space: nowrap;
    }

    .course-list {
      list-style: none;
      padding-left: 0;
      margin: 4px 0 0;
      font-size: 0.88rem;
    }

    .course-item {
      padding: 6px 0;
      border-top: 1px solid #edf0f6;
    }

    .course-item:first-child {
      border-top: none;
    }

    .course-title-line {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      align-items: flex-start;
    }

    .course-title {
      font-weight: 600;
      font-size: 0.9rem;
    }

    .badge-row {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 2px;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 1px 6px;
      border-radius: 999px;
      border: 1px solid var(--badge-border);
      background: var(--badge-bg);
      font-size: 0.72rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .badge.cert {
      border-color: #1976d2;
    }

    .badge.mode {
      border-style: dashed;
    }

    .badge.count {
      border-color: #388e3c;
    }

    .badge.empty {
      border-color: var(--danger);
      color: var(--danger);
    }

    .course-subtext {
      margin-top: 2px;
      font-size: 0.78rem;
      color: var(--text-muted);
    }

    .debug-note {
      margin-top: 18px;
      font-size: 0.78rem;
      color: #7a869a;
    }

    .error-box {
      margin: 12px 0 20px;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #f44336;
      background: #ffebee;
      color: #b71c1c;
      font-size: 0.86rem;
    }

    @media (max-width: 600px) {
      .page {
        padding: 14px 12px 32px;
      }
      header h1 {
        font-size: 1.45rem;
      }
      .status-bar {
        padding: 8px 10px;
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <h1>910CPR Course Families (from Enrollware)</h1>
      <p>Live view of active course families based on the latest Enrollware schedule snapshot.</p>
    </header>

    <div id="status" class="status-bar">
      <div class="status-pill warn">Loading…</div>
      <div class="status-text">Reading data/status.json and data/courses.json…</div>
    </div>

    <div id="errors"></div>

    <section id="families">
      <div class="family-grid" id="family-grid">
        <!-- Filled by JS -->
      </div>
    </section>

    <div class="debug-note" id="debug-note"></div>
  </div>

  <script>
    const FAMILY_LABELS = {
      "BLS": "BLS – Basic Life Support",
      "ACLS": "ACLS – Advanced Cardiac Life Support",
      "PALS": "PALS – Pediatric Advanced Life Support",
      "PEARS": "PEARS – Pediatric Emergency Assessment",
      "ASLS": "ASLS – Advanced Stroke Life Support",
      "FA_CPR_AED": "First Aid / CPR / AED",
      "CPR_AED": "CPR / AED Only",
      "PED_FA_CPR_AED": "Pediatric First Aid / CPR / AED",
      "OSHA_10_30": "OSHA 10 / 30 & Workplace Safety",
      "USCG_MARITIME": "USCG / Maritime Requirements",
      "OTHER": "Other & Specialized Programs"
    };

    const DELIVERY_LABELS = {
      "in_person": "In-Person",
      "blended": "Blended (Online + Skills)",
      "online": "Online Course",
      "unknown": "Delivery Mode N/A"
    };

    function stripHtmlTitle(html) {
      if (!html) return "";
      const div = document.createElement("div");
      div.innerHTML = html;
      const text = div.textContent || div.innerText || "";
      return text.replace(/\s+/g, " ").trim();
    }

    function niceFamilyLabel(key) {
      if (!key) return "Unclassified";
      return FAMILY_LABELS[key] || key;
    }

    function niceCertBody(certBody) {
      if (!certBody) return "Unspecified";
      return certBody.toUpperCase();
    }

    function niceMode(mode) {
      if (!mode) return "Mode N/A";
      return DELIVERY_LABELS[mode] || mode;
    }

    async function fetchJson(path) {
      const res = await fetch(path, { cache: "no-store" });
      if (!res.ok) {
        throw new Error("Failed to load " + path + " (" + res.status + ")");
      }
      return res.json();
    }

    function renderStatus(statusData, coursesData) {
      const statusEl = document.getElementById("status");
      if (!statusData) {
        statusEl.innerHTML = "<div class='status-pill warn'>No status.json</div><div class='status-text'>status.json not found.</div>";
        return;
      }

      const updatedAt = statusData.updated_at || "n/a";
      const schedBytes = statusData.schedule && statusData.schedule.bytes || 0;
      const snapBytes = statusData.snapshot && statusData.snapshot.bytes || 0;
      const courseCount = coursesData && coursesData.meta && coursesData.meta.course_count || (coursesData && coursesData.courses ? coursesData.courses.length : "n/a");

      const ok = statusData.schedule && statusData.schedule.exists && schedBytes > 0;

      const indexLastMod = document.lastModified || "";

      statusEl.innerHTML = "";
      const pill = document.createElement("div");
      pill.className = "status-pill " + (ok ? "ok" : "warn");
      pill.textContent = ok ? "Data status: OK" : "Data status: CHECK";

      const textDiv = document.createElement("div");
      textDiv.className = "status-text";

      const span1 = document.createElement("span");
      span1.textContent = "updated " + updatedAt;
      textDiv.appendChild(span1);

      const span2 = document.createElement("span");
      span2.textContent = "snapshot.html " + snapBytes + " bytes";
      textDiv.appendChild(span2);

      const span3 = document.createElement("span");
      span3.textContent = "schedule.json " + schedBytes + " bytes";
      textDiv.appendChild(span3);

      const span4 = document.createElement("span");
      span4.textContent = "courses.json " + courseCount + " courses";
      textDiv.appendChild(span4);

      const span5 = document.createElement("span");
      span5.textContent = "index last modified: " + indexLastMod;
      textDiv.appendChild(span5);

      statusEl.appendChild(pill);
      statusEl.appendChild(textDiv);
    }

    function renderFamilies(courses) {
      const grid = document.getElementById("family-grid");
      grid.innerHTML = "";

      if (!Array.isArray(courses) || courses.length === 0) {
        grid.innerHTML = "<p>No courses found in courses.json.</p>";
        return;
      }

      // Filter out BLS Quick Reference or other non-real “courses”
      const filtered = courses.filter(c => {
        const title = stripHtmlTitle(c.cleanTitle || c.uglyTitle || "");
        if (!title) return false;
        if (/quick reference guide/i.test(title)) return false;
        // Hide courses that truly have no sessions
        if (!Array.isArray(c.session_ids) || c.session_ids.length === 0) return false;
        return true;
      });

      if (filtered.length === 0) {
        grid.innerHTML = "<p>No active course families with upcoming sessions.</p>";
        return;
      }

      // Group by family
      const famMap = new Map();
      for (const course of filtered) {
        const famKey = course.family || "OTHER";
        if (!famMap.has(famKey)) {
          famMap.set(famKey, []);
        }
        famMap.get(famKey).push(course);
      }

      // Sort families by a fixed order, then alphabetically
      const order = [
        "BLS",
        "ACLS",
        "PALS",
        "PEARS",
        "ASLS",
        "FA_CPR_AED",
        "CPR_AED",
        "PED_FA_CPR_AED",
        "OSHA_10_30",
        "USCG_MARITIME",
        "OTHER"
      ];

      const famKeys = Array.from(famMap.keys());
      famKeys.sort((a, b) => {
        const ia = order.indexOf(a);
        const ib = order.indexOf(b);
        if (ia === -1 && ib === -1) return a.localeCompare(b);
        if (ia === -1) return 1;
        if (ib === -1) return -1;
        return ia - ib;
      });

      for (const famKey of famKeys) {
        const list = famMap.get(famKey) || [];
        if (!list.length) continue;

        // Total sessions for family
        const totalSessions = list.reduce((sum, c) => sum + (Array.isArray(c.session_ids) ? c.session_ids.length : 0), 0);

        // Sort courses by certBody + title
        list.sort((a, b) => {
          const ab = (a.certBody || "") + stripHtmlTitle(a.cleanTitle || a.uglyTitle || "");
          const bb = (b.certBody || "") + stripHtmlTitle(b.cleanTitle || b.uglyTitle || "");
          return ab.localeCompare(bb);
        });

        const card = document.createElement("div");
        card.className = "family-card";

        const header = document.createElement("div");
        header.className = "family-header";

        const name = document.createElement("div");
        name.className = "family-name";
        name.textContent = niceFamilyLabel(famKey);

        const meta = document.createElement("div");
        meta.className = "family-meta";
        meta.textContent = list.length + " course" + (list.length !== 1 ? "s" : "") + " • " +
          totalSessions + " session" + (totalSessions !== 1 ? "s" : "");

        header.appendChild(name);
        header.appendChild(meta);
        card.appendChild(header);

        const ul = document.createElement("ul");
        ul.className = "course-list";

        for (const course of list) {
          const li = document.createElement("li");
          li.className = "course-item";

          const titleLine = document.createElement("div");
          titleLine.className = "course-title-line";

          const titleEl = document.createElement("div");
          titleEl.className = "course-title";
          const cleanTitle = stripHtmlTitle(course.cleanTitle || course.uglyTitle || "");
          titleEl.textContent = cleanTitle || "(Untitled course)";

          const countBadge = document.createElement("span");
          countBadge.className = "badge count";
          const count = Array.isArray(course.session_ids) ? course.session_ids.length : 0;
          countBadge.textContent = count + " session" + (count !== 1 ? "s" : "");

          titleLine.appendChild(titleEl);
          titleLine.appendChild(countBadge);
          li.appendChild(titleLine);

          const badgeRow = document.createElement("div");
          badgeRow.className = "badge-row";

          const certBadge = document.createElement("span");
          certBadge.className = "badge cert";
          certBadge.textContent = niceCertBody(course.certBody);
          badgeRow.appendChild(certBadge);

          const modeBadge = document.createElement("span");
          modeBadge.className = "badge mode";
          modeBadge.textContent = niceMode(course.deliveryMode);
          badgeRow.appendChild(modeBadge);

          li.appendChild(badgeRow);

          // Optional subtle subtext: show course_id anchor and family key for debugging
          const sub = document.createElement("div");
          sub.className = "course-subtext";
          sub.textContent = "course_id: " + course.course_id + " • family: " + famKey;
          li.appendChild(sub);

          ul.appendChild(li);
        }

        card.appendChild(ul);
        grid.appendChild(card);
      }

      const debug = document.getElementById("debug-note");
      debug.textContent =
        "Debug note: this page groups courses by family using data/courses.json. " +
        "Only courses with at least one upcoming session (session_ids.length > 0) are shown. " +
        "If something is mis-filed, we can adjust the family/certBody rules in parse_enrollware.py.";
    }

    function showError(message) {
      const box = document.getElementById("errors");
      const div = document.createElement("div");
      div.className = "error-box";
      div.textContent = message;
      box.appendChild(div);
    }

    async function init() {
      try {
        const [statusData, coursesData] = await Promise.all([
          fetchJson("data/status.json").catch(() => null),
          fetchJson("data/courses.json")
        ]);

        renderStatus(statusData, coursesData);
        if (!coursesData || !Array.isArray(coursesData.courses)) {
          showError("courses.json did not contain a courses[] array.");
          return;
        }
        renderFamilies(coursesData.courses);
      } catch (err) {
        console.error(err);
        showError("Error loading JSON: " + (err && err.message ? err.message : err));
      }
    }

    init();
  </script>
</body>
</html>

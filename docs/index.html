<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>910CPR – Courses & Schedule</title>

  <!-- GA4 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-45PBWBK7KR"></script>
  <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)};gtag('js',new Date());gtag('config','G-45PBWBK7KR');</script>

  <!-- GTM -->
  <script>
    (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});
      var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';
      j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-K58Z4XD');
  </script>
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-K58Z4XD" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>

  <style>
    :root{
      --ink:#0a1b2b; --bg:#f6f9fc; --card:#fff; --edge:#dce9f7; --hover:#f3f8ff;
      --badge:#eef6ff; --brand:#0b66c3; --ok:#0a7d27; --err:#b00020;
      --bannerTop:#32415f; --bannerBot:#27354e; --bannerText:#f4f7fb;
    }
    body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:var(--bg);color:var(--ink)}
    .wrap{max-width:1100px;margin:auto;padding:20px}
    .status{margin:0 0 8px;padding:10px 16px;font-size:14px}
    .status.ok{background:#e8f7ee;color:var(--ok);border:1px solid #cfe8d7}
    .status.err{background:#fde9ec;color:var(--err);border:1px solid #f3c7cf}
    .muted{opacity:.7}

    /* Top-level = each placeholder becomes ONE curtain */
    details.section{margin:12px 0;border-radius:12px;box-shadow:0 3px 10px rgba(0,0,0,.05);background:var(--card);border:1px solid var(--edge);overflow:hidden}
    details.section>summary{cursor:pointer;list-style:none;padding:0}
    .section-body{padding:14px 18px}

    /* Curtain header from placeholder (NEVER a link) */
    .ph-head{
      display:block;padding:14px 18px;border-bottom:1px solid var(--edge);
      background:linear-gradient(180deg,var(--bannerTop),var(--bannerBot)); color:var(--bannerText)
    }
    .ph-head .ph-title{font-weight:800}
    .ph-head .ph-sub{font-size:12px;opacity:.9;margin-top:6px}

    /* Course cards inside each section */
    details.sub{margin:12px 0;border-radius:12px;border:1px solid var(--edge);background:var(--card);overflow:hidden}
    details.sub>summary{list-style:none;cursor:pointer;font-weight:700;padding:12px 16px;background:linear-gradient(180deg,#ffffff,#f7fbff);border-bottom:1px solid var(--edge)}
    details.sub[open]>summary{background:#f0f6ff}
    details.sub .body{padding:14px 16px}
    .ew-heading{display:flex;align-items:center;gap:8px}
    .ew-heading img{height:22px;width:auto}
    .title-link{color:inherit;text-decoration:none}
    .title-link:hover{text-decoration:underline}
    .meta{font-size:12px;color:#466;margin:8px 0 0}
    .btn{display:inline-block;margin-top:10px;border:1px solid var(--edge);border-radius:8px;padding:8px 12px;text-decoration:none;color:#0b66c3;background:var(--card)}

    /* Imported Enrollware list */
    .enrclass-list{list-style:none;padding:0;margin:12px 0}
    .enrclass-list li{margin:6px 0}
    .enrclass-list a{display:flex;flex-direction:column;gap:4px;border:1px solid var(--edge);border-radius:10px;padding:8px 10px;text-decoration:none;color:var(--ink);background:var(--card)}
    .enrclass-list a:hover{background:var(--hover);border-color:#b9d6f9}
  </style>
</head>
<body>
  <div class="wrap"></div>

  <script>
    const ENR_ORIGIN = 'https://coastalcprtraining.enrollware.com';
    const ctHref = id => `${ENR_ORIGIN}/schedule#${encodeURIComponent(id)}`;
    const isCt = id => typeof id === 'string' && /^ct\d{3,}$/i.test(id);

    // Only link if we have a valid ct#####
    const linkedTitle = (titleHTML,id) => isCt(id)
      ? `<a class="title-link" href="${ctHref(id)}">${titleHTML}</a>`
      : titleHTML;

    function absolutizeUrls(fragment){
      fragment.querySelectorAll('img, a').forEach(el=>{
        const attr = el.tagName==='IMG' ? 'src' : 'href';
        const v = el.getAttribute(attr); if(!v) return;
        if(/^https?:\/\//i.test(v)) return;
        const abs = v.startsWith('/') ? ENR_ORIGIN+v : ENR_ORIGIN+'/'+v.replace(/^\.?\//,'');
        el.setAttribute(attr, abs);
      });
      return fragment;
    }

    // Robust ct lookup INSIDE the parsed snapshot root
    function getCtId(panel, root){
      // 1) Anchor inside panel
      let a = panel.querySelector('[id^="ct"],[name^="ct"]');
      if(a){ const id=a.id||a.getAttribute('name')||''; if(isCt(id)) return id; }

      // 2) Any link inside that already targets #ct
      const link = panel.querySelector('a[href*="#ct"]');
      if(link){
        const m = link.getAttribute('href').match(/#(ct\d{3,})/i);
        if(m && isCt(m[1])) return m[1];
      }

      // 3) Walk previous siblings
      let prev = panel.previousElementSibling, hops=0;
      while(prev && hops<8){
        if(prev.matches?.('[id^="ct"],[name^="ct"]')){
          const id = prev.id || prev.getAttribute('name') || '';
          if(isCt(id)) return id;
        }
        const inner = prev.querySelector?.('[id^="ct"],[name^="ct"]');
        if(inner){
          const id = inner.id || inner.getAttribute('name') || '';
          if(isCt(id)) return id;
        }
        prev = prev.previousElementSibling; hops++;
      }

      // 4) Tree-walk from root to panel, remember last ct anchor encountered
      const walker = document.createTreeWalker(root, NodeFilter.SHOW_ELEMENT, null);
      let lastCt = '';
      while(walker.nextNode()){
        const el = walker.currentNode;
        if(el===panel) break;
        const id = el.id || el.getAttribute?.('name') || '';
        if(isCt(id)) lastCt = id;
      }
      return lastCt; // '' if none
    }

    function parseDateFromText(t){
      if(!t) return null;
      const s = String(t).replace(/\u00A0/g,' ').trim();
      const re=/^(?:[A-Za-z]+,\s*)?([A-Za-z]+)\s+(\d{1,2}),\s*(\d{4})\s+at\s+(\d{1,2}):(\d{2})\s*(AM|PM)/i;
      const m=s.match(re); if(!m) return null;
      const months={january:0,february:1,march:2,april:3,may:4,june:5,july:6,august:7,september:8,october:9,november:10,december:11};
      const mon=months[m[1].toLowerCase()]; if(mon==null) return null;
      let hr=+m[4],min=+m[5]; const ap=m[6].toUpperCase();
      if(ap==='PM'&&hr<12) hr+=12; if(ap==='AM'&&hr===12) hr=0;
      return new Date(+m[3],mon,+m[2],hr,min);
    }

    function limitUlToWindow(ul,maxDays=28,maxItems=10){
      if(!ul) return {ul,kept:0,total:0};
      const cutoff=new Date(); cutoff.setDate(cutoff.getDate()+maxDays);
      const lis=[...ul.querySelectorAll(':scope>li')];
      let kept=0,total=0;
      for(const li of lis){
        total++;
        const a=li.querySelector('a');
        const txt=(a?.textContent||li.textContent||'').trim();
        const dt=parseDateFromText(txt);
        const keep = (!dt) || (dt && dt<=cutoff && kept<maxItems);
        if(keep){ kept++; } else { li.remove(); }
      }
      return {ul,kept,total};
    }

    function wireCurtains(){
      document.querySelectorAll('details.section').forEach(sec=>{
        sec.addEventListener('toggle',()=>{
          if(sec.open){
            document.querySelectorAll('details.section').forEach(d=>{ if(d!==sec) d.open=false;});
            const top=sec.getBoundingClientRect().top + window.scrollY - 12;
            window.scrollTo({top,behavior:'smooth'});
          }
        });
      });
      document.querySelectorAll('details.sub').forEach(sub=>{
        sub.addEventListener('toggle',()=>{
          if(sub.open){
            const top=sub.getBoundingClientRect().top + window.scrollY - 12;
            window.scrollTo({top,behavior:'smooth'});
          }
        });
      });
    }

    async function loadSnapshotHTML(){
      const here = location.pathname;
      const base = here.replace(/[^/]+$/,'');
      const tryPaths = [
        base + 'data/enrollware-schedule.html',
        '/ew2landers/data/enrollware-schedule.html'
      ];
      const tried=[];
      for(const url of tryPaths){
        try{
          const res=await fetch(url,{mode:'same-origin',credentials:'omit',cache:'no-cache'});
          if(res.ok){ return { html: await res.text(), url, tried }; }
          tried.push(url+' ('+res.status+')');
        }catch(e){ tried.push(url+' (fetch error)'); }
      }
      return { html:null, url:null, tried };
    }

    document.addEventListener('DOMContentLoaded', async()=>{
      const host=document.querySelector('.wrap');
      const status=document.createElement('div'); status.className='status';
      host.parentNode.insertBefore(status,host);

      const load=await loadSnapshotHTML();
      if(!load.html){
        status.className='status err';
        status.innerHTML='<strong>Could not load schedule snapshot.</strong><br><span class="muted">Tried:</span> '+(load.tried.join(' → '));
        host.insertAdjacentHTML('beforeend','<p>Put the file at docs/data/enrollware-schedule.html in your repo.</p>');
        return;
      }

      // Parse snapshot
      const root=document.createElement('div'); root.innerHTML=load.html;

      // Walk panels in order; placeholders start a new section; courses append
      const panels=[...root.querySelectorAll('.enrpanel')];
      const sections=[];
      let current=null;

      for(const p of panels){
        const headingEl=p.querySelector('.enrpanel-heading,h1,h2,h3,h4');
        if(!headingEl) continue;

        const headingFrag=headingEl.cloneNode(true);
        absolutizeUrls(headingFrag);
        const titleHTML=headingFrag.innerHTML.trim();

        const bodyEl=p.querySelector('.enrpanel-body');
        const descClone=bodyEl?bodyEl.cloneNode(true):null;
        if(descClone){ const u=descClone.querySelector('ul.enrclass-list'); if(u) u.remove(); }
        if(descClone) absolutizeUrls(descClone);
        const descHTML=descClone?(descClone.innerHTML||'').trim():'';

        const ul=p.querySelector('ul.enrclass-list');
        const hasDates=!!ul;

        if(!hasDates){
          // New section header (never clickable)
          current={ header:{titleHTML,descHTML}, courses:[] };
          sections.push(current);
          continue;
        }

        if(!current){
          current={ header:{titleHTML:'Courses',descHTML:''}, courses:[] };
          sections.push(current);
        }

        const ulClone=ul.cloneNode(true);
        absolutizeUrls(ulClone);
        const trimmed=limitUlToWindow(ulClone,28,10);
        const ctId=getCtId(p, root); // strictly read from snapshot

        current.courses.push({
          id: ctId,
          titleHTML,
          descHTML,
          ul: trimmed.ul,
          kept: trimmed.kept,
          total: trimmed.total
        });
      }

      host.innerHTML='<h1>910CPR Courses & Schedule</h1><p class="muted">Loaded snapshot '+(load.url||'')+'</p>';

      sections.forEach(sec=>{
        const el=document.createElement('details'); el.className='section';
        el.innerHTML=`
          <summary>
            <div class="ph-head">
              <div class="ph-title">${sec.header.titleHTML}</div>
              ${sec.header.descHTML?`<div class="ph-sub">${sec.header.descHTML}</div>`:''}
            </div>
          </summary>
          <div class="section-body"></div>`;
        const body=el.querySelector('.section-body');

        sec.courses.forEach(c=>{
          const sub=document.createElement('details'); sub.className='sub';
          const titleLinked=linkedTitle(c.titleHTML,c.id); // only links if ct#####
          const url = isCt(c.id) ? ctHref(c.id) : `${ENR_ORIGIN}/schedule`; // button uses ct if we have it

          const hint = (c.total>c.kept)
            ? `<div class="meta">Showing ${c.kept} of ${c.total} upcoming dates (~4 weeks). <a class="btn" href="${url}">See all dates</a></div>`
            : `<div class="meta">All upcoming dates shown. <a class="btn" href="${url}">See all dates</a></div>`;

          sub.innerHTML=`
            <summary><div class="ew-heading">${titleLinked}</div></summary>
            <div class="body">
              <div class="desc">${c.descHTML}</div>
              <ul class="enrclass-list"></ul>
              ${hint}
            </div>`;
          sub.querySelector('.enrclass-list').replaceWith(c.ul);
          body.appendChild(sub);
        });

        document.querySelector('.wrap').appendChild(el);
      });

      status.className='status ok';
      status.textContent='Status: rendered '+sections.length+' sections; course titles link only when ct found.';
      wireCurtains();
    });
  </script>

  <!-- Voice widget -->
  <embeddable-voice id="1cf9bf8f-38da-437e-abfb-efa1ce9a02ff"></embeddable-voice>
  <script src="https://cdn.247aireceptionist.com/script.js"></script>
</body>
</html>

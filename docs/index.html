<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>910CPR – Course Catalog</title>
  <style>
    :root{
      --bg:#0b1320;
      --ink:#eaf2ff;
      --muted:#9fb6e8;
      --brand:#1373d1;
      --accent:#0f61bb;
      --shadow:0 2px 16px rgba(6,10,18,.35);
      --radius:18px;
      --bls:#b6d4ff;
      --acls:#ff7474;
      --pals:#c59eff;
      --faid:#7eb0ff;
    }
    html,body{
      margin:0;
      padding:0;
      background:var(--bg);
      color:var(--ink);
      font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }
    a{color:var(--brand);text-decoration:none}
    a:hover{color:var(--accent)}

    .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
    header{
      display:flex;
      gap:16px;
      align-items:center;
      justify-content:space-between;
      margin:8px 0 8px;
      position:sticky;
      top:0;
      z-index:10;
      background:linear-gradient(180deg, rgba(11,19,32,1) 0%, rgba(11,19,32,0.85) 100%);
      backdrop-filter:saturate(1.1) blur(2px);
    }
    header h1{
      font-size:clamp(22px,3.5vw,34px);
      margin:0;
      font-weight:750;
    }
    .nav{
      display:flex;
      gap:14px;
      flex-wrap:wrap;
      align-items:center;
    }
    .nav a{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:8px 10px;
      border:1px solid #243349;
      border-radius:12px;
      background:#0e1726;
      color:var(--ink);
      font-weight:650;
    }
    .nav a[target="_blank"]::after{
      content:" ↗";
      opacity:.7;
      font-weight:700;
    }
    .nav a:hover{
      background:#122448;
      border-color:#2f416a;
    }

    #dataStatus{
      font:13px/1.3 system-ui;
      color:#9fb6e8;
      margin:4px 0 2px;
    }
    #debugInfo{
      font:11px/1.3 system-ui;
      color:#6e84b8;
      margin:0 0 12px;
    }

    .grid{
      display:grid;
      grid-template-columns:repeat(12,1fr);
      gap:16px;
    }
    .card{
      background:#0e1726;
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
      display:flex;
      flex-direction:column;
      min-height:120px;
      border:1px solid #243349;
      position:relative;
    }
    .card h3{
      margin:0 0 10px;
      padding-right:24px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .card h3 .brandicon{
      height:22px;
      width:auto;
      object-fit:contain;
      display:inline-block;
      filter:drop-shadow(0 1px 1px rgba(0,0,0,.25));
    }
    .card.course:hover{
      outline:2px solid #2f416a;
      outline-offset:0;
      border-color:#2f416a;
      background:#0f1f39;
    }
    .card.course{grid-column:span 6}
    @media(max-width:860px){.card.course{grid-column:span 12}}

    /* Section headers */
    .card.title{
      grid-column:1 / -1;
      background:#0f1c33;
      color:var(--ink);
      border:1px solid #2a3b62;
      position:relative;
      overflow:hidden;
    }
    .card.title::before{
      content:"";
      position:absolute;
      left:0;top:0;bottom:0;
      width:12px;
      background:#2a3b62;
    }
    .card.title.bls::before{background:var(--bls)}
    .card.title.acls::before{background:var(--acls)}
    .card.title.pals::before{background:var(--pals)}
    .card.title.faid::before{background:var(--faid)}
    .card.title h2{
      margin:0 0 4px;
      font-size:clamp(18px,2.8vw,24px);
      padding-right:128px;
    }
    .card.title small{color:var(--muted)}

    /* details / sessions */
    details{margin-top:auto}
    summary{
      cursor:pointer;
      list-style:none;
      display:flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border-radius:12px;
      background:#111e36;
      color:var(--ink);
      font-weight:700;
      border:1px solid #243349;
    }
    summary:hover{background:#1a2b55;border-color:#3b5aa0}
    summary::-webkit-details-marker{display:none}
    details[open] summary{background:#122448;border-color:#2f416a}

    .desc{padding:10px 2px 2px;color:#bfd2ff}
    .slots{margin:8px 0 0;padding:0;list-style:none}
    .slots li{display:block;padding:0;margin:10px 0;background:transparent;border:none}

    .slotbtn{
      display:flex;
      align-items:center;
      justify-content:space-between;
      width:100%;
      padding:14px;
      border-radius:12px;
      background:#152242;
      border:1px solid #2a3b62;
      color:var(--ink);
      text-decoration:none;
    }
    .slotbtn:hover{background:#1a2b55;border-color:#385089}
    .slotbtn .meta{font-size:13px;color:#9fb6e8}
    .slotbtn .right{white-space:nowrap;margin-left:12px}

    /* Popular quick-links */
    .popular{
      display:grid;
      grid-template-columns:2fr 1fr;
      gap:20px;
      align-items:center;
      background:#0b1320;
      color:var(--ink);
      border-radius:20px;
      padding:18px;
      margin:8px 0 22px;
      border:1px solid #243349;
      box-shadow:var(--shadow);
    }
    .popular h2{
      margin:6px 0 10px;
      font-size:clamp(16px,2.2vw,20px);
      font-weight:750;
      color:#b6d4ff;
    }
    .tiles{display:flex;flex-wrap:wrap;gap:10px}
    .tile{
      display:flex;
      flex-direction:column;
      justify-content:center;
      min-width:160px;
      padding:10px 12px;
      border-radius:12px;
      color:#001a4d;
      border:1px solid #2a3b62;
      box-shadow:inset 0 1px 0 rgba(255,255,255,.04);
    }
    .tile .t1{font-weight:800}
    .tile .t2{font-size:12px;opacity:.8;color:#eef3ff}
    .tile:hover{filter:brightness(1.15);box-shadow:0 0 0 2px rgba(0,0,0,.15) inset}
    .tile.bls{background:var(--bls)}
    .tile.acls{background:var(--acls);color:#2a0010}
    .tile.pals{background:var(--pals)}
    .tile.faid{background:var(--faid)}
    .popular .art{display:flex;align-items:center;justify-content:center;background:#fff;border-radius:16px;padding:12px}
    .popular .art img{max-width:100%;height:auto;border-radius:12px}

    .note{font-size:13px;color:#9fb6e8;margin-top:6px}
    .warn{color:#ffc9c9;font-weight:700;margin-top:12px}
    .ok{color:#7fe1a9}
    .soft{color:#ffdd99}
    .brandrow{
      display:flex;
      justify-content:center;
      align-items:center;
      gap:28px;
      background:#ffffff;
      border:1px solid #e6eaf5;
      border-radius:20px;
      padding:14px;
      margin:0 0 12px;
      box-shadow:0 2px 16px rgba(6,10,18,.08);
    }
    .brandrow .badge{
      display:flex;
      align-items:center;
      justify-content:center;
      padding:8px 12px;
      border-radius:14px;
      background:transparent;
      border:1px solid transparent;
    }
    .brandrow .badge img{
      height:56px;
      width:auto;
      object-fit:contain;
      display:block;
      filter:drop-shadow(0 2px 4px rgba(0,0,0,.15));
    }
    @media(max-width:640px){
      .brandrow .badge img{height:44px}
      .popular{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>910CPR – Course Catalog</h1>
    <nav class="nav" aria-label="Primary">
      <a href="http://coastalcprtraining.com/about" target="_blank" rel="noopener">About</a>
      <a href="http://910cpr.com/" target="_blank" rel="noopener">Classes</a>
      <a href="http://coastalcprtraining.com/" target="_blank" rel="noopener">Coastal CPR Training</a>
      <a href="http://coastalcprtraining.com/on-site-training" target="_blank" rel="noopener">On Site Training</a>
    </nav>
  </header>

  <div id="dataStatus">Checking data status…</div>
  <div id="debugInfo"></div>

  <!-- Certifying bodies / partners -->
  <section class="brandrow" aria-label="Certifying bodies">
    <div class="badge"><img src="https://www.enrollware.com/sitefiles/coastalcprtraining/111 aha-authorized-training-site.png" alt="AHA Authorized Training Site" /></div>
    <div class="badge"><img src="https://www.enrollware.com/sitefiles/coastalcprtraining/111 arc-ltp-logo.jpg" alt="American Red Cross Licensed Training Provider" /></div>
    <div class="badge"><img src="https://www.enrollware.com/sitefiles/coastalcprtraining/HSI.png" alt="HSI Training Center" /></div>
  </section>

  <!-- Popular quick-links -->
  <section class="popular" aria-label="Most popular classes">
    <div>
      <h2>Most popular classes</h2>
      <div class="tiles">
        <a class="tile bls" href="#aha---bls-provider---in-person-renewal"><span class="t1">BLS</span><span class="t2">Initial or renewal; instructor-led</span></a>
        <a class="tile bls" href="#aha---bls-provider---heartcode-online--skills-check"><span class="t1">BLS Online</span><span class="t2">Blended: online + in-person skills</span></a>
        <a class="tile acls" href="#aha---acls-provider---renewal"><span class="t1">ACLS</span><span class="t2">Fully in-person renewal</span></a>
        <a class="tile acls" href="#aha---acls-provider-heartcode-online--skills"><span class="t1">ACLS Online</span><span class="t2">Initial (online + skills)</span></a>
        <a class="tile pals" href="#aha---pals-provider---renewal"><span class="t1">PALS</span><span class="t2">Fully in-person renewal</span></a>
        <a class="tile pals" href="#aha---pals-provider-heartcode-online--skills"><span class="t1">PALS Online</span><span class="t2">Initial (online + skills)</span></a>
        <a class="tile faid" href="#aha-heartsaver-cpr-aed"><span class="t1">First Aid / CPR / AED</span><span class="t2">Fully in-person course</span></a>
        <a class="tile faid" href="#aha-heartsaver-total-blended-learning-first-aid-cpr-aed"><span class="t1">First Aid / CPR / AED Online</span><span class="t2">Flexible + fast (online + skills)</span></a>
      </div>
    </div>
    <div class="art">
      <img src="https://www.enrollware.com/sitefiles/coastalcprtraining/910CPR_wave.jpg" alt="910CPR wave logo banner"/>
    </div>
  </section>

  <!-- Catalog grid renders here -->
  <section id="courseGrid" class="grid" aria-live="polite"></section>

  <div id="gridWarning" class="note"></div>
</div>

<script>
/* ==========================
   BASIC HELPERS
   ========================== */
function slug(s){
  return String(s||'')
    .toLowerCase()
    .replace(/[^a-z0-9]+/g,'-')
    .replace(/(^-|-$)/g,'');
}
function fmtDate(dtISO){
  if(!dtISO) return '';
  const d=new Date(dtISO);
  if(Number.isNaN(d.getTime())) return '';
  const opt={weekday:'short',month:'short',day:'numeric',hour:'numeric',minute:'2-digit'};
  return d.toLocaleString(undefined,opt);
}
function withinWindow(dtISO){
  if(!dtISO) return false;
  const s=new Date(dtISO);
  if(Number.isNaN(s.getTime())) return false;
  const now=new Date();
  const cap=new Date(now.getTime()+60*86400000); // 60 days
  return s>=now && s<=cap;
}

/* ==========================
   CONFIG & CONSTANTS
   ========================== */
const CONFIG = {
  windowDays: 60,
  maxSessionsPerCourse: 15,
  jsonFeed: "data/schedule.json",
  statusFile: "data/status.json",
  snippetRoot: "courses/"    // /courses/{slug(title)}.html
};
const IMG_BASE = "https://www.enrollware.com/sitefiles/coastalcprtraining/";
const FAMILY_IMG = {
  bls:"25-bls-new.png",
  acls:"25-acls-new.png",
  pals:"25-pals-new.png",
  faid:"25_Heartsaver.png"
};
const BRAND_LOGO = {
  AHA: IMG_BASE + "_AHA.png",
  "Red Cross": IMG_BASE + "_ARC.png",
  HSI: IMG_BASE + "_HSI.png"
};

/* ==========================
   STATUS INDICATOR + DEBUG
   ========================== */
(function checkDataStatus(){
  const el = document.getElementById('dataStatus');
  const dbg = document.getElementById('debugInfo');
  if(!el) return;
  fetch(CONFIG.statusFile + "?v=" + Date.now(), {cache:"no-store"})
    .then(r => r.ok ? r.json() : null)
    .then(st => {
      if(!st){
        el.textContent = "Data status: missing (status.json 404). Actions may not have run yet.";
        el.className = "note bad";
        return;
      }
      const snap = st.snapshot || {}, sched = st.schedule || {};
      const ok = snap.exists && snap.bytes>0 && sched.exists && sched.bytes>0;
      el.textContent = ok
        ? `Data status: OK • updated ${st.updated_at} • schedule.json ${sched.bytes} bytes`
        : `Data status: INCOMPLETE • snapshot: ${snap.exists?'yes':'no'} • schedule: ${sched.exists?'yes':'no'}`;
      el.className = ok ? "note ok" : "note soft";

      if(dbg){
        const lastMod = document.lastModified || "(n/a)";
        dbg.textContent = `Debug: index.html last modified: ${lastMod} • data build: ${st.updated_at || "n/a"} • commit: ${st.github && st.github.sha || "n/a"}`;
      }
    })
    .catch(()=>{
      el.textContent = "Data status: unknown (fetch error).";
      el.className = "note bad";
    });
})();

/* ==========================
   LOAD FEED (JSON ONLY)
   ========================== */
let FEED = [];

async function loadFeed(){
  const r = await fetch(CONFIG.jsonFeed + "?v=" + Date.now(), {cache:"no-store"});
  if(!r.ok){
    throw new Error("JSON feed HTTP " + r.status);
  }
  const j = await r.json();
  const arr = Array.isArray(j) ? j : (Array.isArray(j.sessions) ? j.sessions : []);
  if(!Array.isArray(arr) || !arr.length){
    throw new Error("JSON sessions array empty");
  }
  return arr;
}

/* ==========================
   COURSE GROUPING & FILTERING
   ========================== */
function detectBrandFromTitle(title, section){
  const t = (title || section || "").toLowerCase();
  if(t.includes("american red cross") || t.startsWith("arc ") || t.includes("red cross")) return "Red Cross";
  if(t.includes("hsi")) return "HSI";
  if(t.includes("aha") || t.includes("american heart")) return "AHA";
  return null;
}
function familyFromTitle(title, section){
  const t = (title || section || "").toLowerCase();
  if(t.includes("bls") || t.includes("basic life support")) return "bls";
  if(t.includes("acls") || t.includes("advanced cardiovascular")) return "acls";
  if(t.includes("pals") || t.includes("pediatric advanced")) return "pals";
  if(t.includes("heartsaver") || t.includes("first aid") || t.includes("cpr aed")) return "faid";
  return "other";
}

/* Filter out junk pseudo-courses: headings like "When:", "How it works", etc. */
function isRealCourseSession(s){
  const title = (s.course_title || s.title || "").trim();
  if(!title) return false;
  const lower = title.toLowerCase().replace(/[:\s]+$/,"");

  // obvious heading labels
  const junkExact = [
    "when",
    "requirement",
    "requirements",
    "how it works",
    "how it works:",
    "how it works –",
    "what you'll learn",
    "what you’ll learn",
    "course highlights",
    "course topics include",
    "what is covered",
    "what’s covered",
    "whats covered"
  ];
  if(junkExact.includes(lower)) return false;

  // phrases that are clearly not standalone courses
  if(/\b(assessment|blended|option|topics?|include|includes both|same-day|same day|certification)\b/.test(lower)){
    return false;
  }

  // titles that start with weekday/month are almost certainly date-lines
  if(/^(monday|tuesday|wednesday|thursday|friday|saturday|sunday|jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec)/.test(lower)){
    return false;
  }

  // extremely short generic labels
  if(title.length < 6) return false;

  return true;
}

function buildCourseMap(feed){
  const map = new Map(); // key -> {title,family,brand,sessions:[]}

  feed.forEach(s=>{
    if(!s.start || !withinWindow(s.start)) return;
    if(!isRealCourseSession(s)) return;

    const key = s.course_id || (s.course_title || s.title || "").trim();
    if(!key) return;

    if(!map.has(key)){
      const title = (s.course_title || s.title || "").trim();
      const family = familyFromTitle(title, s.section);
      const brand = detectBrandFromTitle(title, s.section);
      map.set(key,{
        key,
        title,
        family,
        brand,
        section:s.section || "",
        sessions:[]
      });
    }
    map.get(key).sessions.push(s);
  });

  // sort sessions in each course
  map.forEach(entry=>{
    entry.sessions.sort((a,b)=>new Date(a.start)-new Date(b.start));
  });

  return map;
}

/* ==========================
   RENDERING
   ========================== */
function makeTitleCard(text, blurb, family){
  const el=document.createElement("div");
  el.className="card title" + (family?(" "+family):"");
  el.innerHTML = `<h2>${text}</h2>${blurb?`<small>${blurb}</small>`:""}`;
  return el;
}

function createCourseCard(entry){
  const el = document.createElement("div");
  el.className = "card course";
  const keySlug = slug(entry.title);
  el.id = "card-" + keySlug;

  const brandSrc = entry.brand && BRAND_LOGO[entry.brand] ? BRAND_LOGO[entry.brand] : "";
  const brandImg = brandSrc ? `<img class="brandicon" src="${brandSrc}" alt="${entry.brand} logo" />` : "";

  el.innerHTML = `
    <h3 id="h-${keySlug}">${brandImg}<a href="#${keySlug}" style="text-decoration:none;color:inherit">${entry.title}</a></h3>
    <details id="d-${keySlug}" data-key="${keySlug}">
      <summary>Course details &amp; upcoming sessions</summary>
      <div class="desc" id="desc-${keySlug}"><!-- Course Description snippet --></div>
      <ul class="slots" id="slots-${keySlug}"></ul>
    </details>
  `;
  const ul = el.querySelector(`#slots-${keySlug}`);

  if(!entry.sessions || !entry.sessions.length){
    ul.innerHTML = `<li class="note">No upcoming sessions in the next ${CONFIG.windowDays} days. See full schedule.</li>`;
  } else {
    entry.sessions.slice(0,CONFIG.maxSessionsPerCourse).forEach(s=>{
      const li = document.createElement("li");
      const when = fmtDate(s.start) || "(date/time TBA)";
      li.innerHTML = `
        <a class="slotbtn" href="${s.url}" target="_blank" rel="noopener"
           aria-label="Register for ${entry.title} on ${when}">
          <div>
            <time datetime="${s.start || ""}">${when}</time>
            <div class="meta">${s.location || ""}</div>
          </div>
          <div class="right">Register →</div>
        </a>
      `;
      ul.appendChild(li);
    });
  }

  return el;
}

function applyOpenFromURL(map){
  try{
    const hash = decodeURIComponent(location.hash.replace("#",""));
    if(!hash) return;
    const det = map && map.get ? map.get(hash) : null;
    if(det){
      det.setAttribute("open","");
      const card = document.getElementById("card-"+hash) || det.closest(".card");
      if(card && card.scrollIntoView){
        card.scrollIntoView({behavior:"smooth",block:"start"});
      }
      const sum = det.querySelector("summary");
      if(sum && sum.focus) sum.focus();
    }
  }catch(e){}
}

/* ==========================
   SNIPPETS
   ========================== */
async function loadSnippets(){
  const keys = Array.isArray(window._COURSE_TITLES) && window._COURSE_TITLES.length
    ? window._COURSE_TITLES
    : [];
  const fetchOne = async(title)=>{
    const file = CONFIG.snippetRoot + slug(title) + ".html";
    try{
      const r = await fetch(file,{cache:"no-store"});
      if(!r.ok) return;
      const html = await r.text();
      const el = document.getElementById("desc-"+slug(title));
      if(el){ el.innerHTML = html; }
    }catch(e){}
  };
  await Promise.all(keys.map(fetchOne));
}

/* ==========================
   BOOT
   ========================== */
(async function init(){
  const grid = document.getElementById("courseGrid");
  const warn = document.getElementById("gridWarning");
  window._COURSE_TITLES = [];

  try{
    FEED = await loadFeed();
  }catch(e){
    if(warn){
      warn.className = "warn";
      warn.textContent = "No sessions loaded into the grid. Check data/schedule.json.";
    }
    console.error(e);
    return;
  }

  const courseMap = buildCourseMap(FEED);
  if(!courseMap.size){
    if(warn){
      warn.className = "warn";
      warn.textContent = `No upcoming sessions in the next ${CONFIG.windowDays} days. Try a later date or contact us.`;
    }
    return;
  }

  const entries = Array.from(courseMap.values());

  // sort by family + title
  const familyOrder = {bls:1,acls:2,pals:3,faid:4,other:5};
  entries.sort((a,b)=>{
    const fa = familyOrder[a.family] || 99;
    const fb = familyOrder[b.family] || 99;
    if(fa !== fb) return fa - fb;
    return a.title.localeCompare(b.title);
  });

  grid.innerHTML = "";
  let lastFamily = null;

  entries.forEach(entry=>{
    if(entry.family !== lastFamily){
      lastFamily = entry.family;
      let label = "Other Programs",
          blurb = "",
          famClass = "faid";
      if(entry.family === "bls"){
        label="Healthcare Provider: BLS";
        blurb="Basic Life Support for healthcare professionals";
        famClass="bls";
      }else if(entry.family==="acls"){
        label="Healthcare Provider: ACLS";
        blurb="Advanced Cardiovascular Life Support";
        famClass="acls";
      }else if(entry.family==="pals"){
        label="Healthcare Provider: PALS";
        blurb="Pediatric Advanced Life Support";
        famClass="pals";
      }else if(entry.family==="faid"){
        label="CPR / AED & First Aid";
        blurb="Lay rescuer & workplace safety programs";
        famClass="faid";
      }
      const titleCard = makeTitleCard(label, blurb, famClass);
      grid.appendChild(titleCard);
    }
    const card = createCourseCard(entry);
    grid.appendChild(card);
    window._COURSE_TITLES.push(entry.title);
  });

  // hash deep-linking
  const map = new Map([...grid.querySelectorAll('details[id^="d-"]')]
    .map(d=>[d.id.slice(2),d]));
  applyOpenFromURL(map);

  await loadSnippets();
})();

window.addEventListener("hashchange",()=>{
  const grid=document.getElementById("courseGrid");
  const map=new Map([...grid.querySelectorAll('details[id^="d-"]')].map(d=>[d.id.slice(2),d]));
  applyOpenFromURL(map);
});
</script>
</body>
</html>

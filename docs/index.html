<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>910CPR Courses</title>
  <style>
    :root{
      --bg:#f7fbff;           /* subtle white→blue vibe */
      --card:#ffffff;
      --ink:#0b1220;          /* high-contrast text */
      --muted:#5a667a;
      --brand:#1373d1;        /* links/chips */
      --accent:#0d5aa3;       /* hover */
      --title-bg:#e8f1ff;     /* colored title cards */
      --title-ink:#0b1220;
      --shadow: 0 2px 16px rgba(11,18,32,.08);
      --radius:18px;
    }

    html,body{margin:0;padding:0;background:linear-gradient(180deg,#fff 0%, var(--bg) 100%);color:var(--ink);font:16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif}

    a{ color:var(--brand); text-decoration:none; }
    a:hover{ color:var(--accent); text-decoration:none; }

    .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin:8px 0 18px}
    header h1{font-size:clamp(22px,3.5vw,34px);margin:0;font-weight:750}

    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}

    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;display:flex;flex-direction:column;min-height:120px}
    .card h3{margin:4px 0 8px;font-size:clamp(16px,2.4vw,20px)}

    .card.course{grid-column:span 6}
    @media (max-width: 860px){ .card.course{grid-column: span 12} }

    .card.title{grid-column:1 / -1;background:var(--title-bg);color:var(--title-ink);border:2px solid #d4e4ff}
    .card.title h2{margin:0;font-size:clamp(18px,2.8vw,24px)}
    .card.title small{color:var(--muted)}

    details{margin-top:auto}
    summary{cursor:pointer;list-style:none;display:flex;align-items:center;gap:8px;padding:10px 12px;border-radius:12px;background:#f4f7fb;color:var(--ink);font-weight:650}
    summary::-webkit-details-marker{display:none}
    details[open] summary{background:#eaf2ff}

    .desc{padding:10px 2px 2px;color:var(--muted)}

    .slots{margin:8px 0 0;padding:0;list-style:none}
    .slots li{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 12px;border:1px solid #e7ecf3;background:#fff;border-radius:12px;margin:8px 0}
    .slots time{font-weight:700;color:var(--ink)}
    .slots .meta{font-size:13px;color:var(--muted)}
    .slots .go{white-space:nowrap}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:12px;background:var(--brand);color:#fff;border:none;font-weight:700}
    .btn:hover{background:var(--accent)}

    .note{font-size:13px;color:var(--muted);margin-top:6px}
    .chip{display:inline-block;background:#eef6ff;color:#0d4f8c;border-radius:999px;padding:4px 10px;font-size:12px;margin-left:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>910CPR – Course Catalog</h1>
      <div class="note">Title cards span the full row. Periscope shows rich HTML description + upcoming sessions.</div>
    </header>

    <section id="courseGrid" class="grid" aria-live="polite"></section>

    <p class="note">If you needed a different time, see all dates for each class type on our schedule pages.</p>
  </div>

  <script>
  // Config
  const CONFIG = {
    windowDays: 28,
    maxSessionsPerCourse: 15,
    jsonFeed: "docs/data/schedule.json",
    htmlFallback: "docs/data/enrollware-schedule.html",
    manualSessions: "docs/data/manual-sessions.json", // optional extra sessions
    snippetRoot: "docs/courses/" // per-course HTML files go here (e.g., bls-renewal.html)
  };

  // Catalog (descHtml is optional and will be fetched + injected)
  const CATALOG = [
    { type:"title", text:"Healthcare Provider: BLS", blurb:"For clinical staff, hospitals, clinics" },
    {
      type:"course",
      key:"AHA - BLS Provider - In-person Renewal",
      title:"AHA – BLS Provider – In‑Person Renewal",
      short:"Instructor‑led Renewal",
      desc:"Hands‑on BLS Renewal for healthcare professionals.",
      descHtml:"bls-renewal.html",
      courseMatch:["BLS", "BLS Provider", "AHA - BLS Provider - In-person Renewal", "BLS In-Person"],
      scheduleFilter:{ classType:"BLS" }
    },
    {
      type:"course",
      key:"AHA - BLS Provider - In-person Initial",
      title:"AHA – BLS Provider – In‑Person Initial",
      short:"For new or expired certs",
      desc:"Initial BLS course covering compressions, AED, team dynamics, and respirations.",
      descHtml:"bls-initial.html",
      courseMatch:["BLS", "BLS Provider", "AHA - BLS Provider - In-person Initial"],
      scheduleFilter:{ classType:"BLS" }
    },

    { type:"title", text:"Healthcare Provider: ACLS", blurb:"Advanced Cardiovascular Life Support" },
    {
      type:"course",
      key:"AHA - ACLS Provider - In-person - Initial",
      title:"AHA – ACLS Provider – Initial",
      short:"For first‑time ACLS",
      desc:"Megacode practice, algorithms, and leadership for adult emergencies.",
      descHtml:"acls-initial.html",
      courseMatch:["ACLS", "AHA - ACLS"],
      scheduleFilter:{ classType:"ACLS" }
    },
    {
      type:"course",
      key:"AHA - ACLS Provider - In-person - Renewal",
      title:"AHA – ACLS Provider – Renewal",
      short:"Update & renewal",
      desc:"Focused ACLS refresh with testing and skills verification.",
      descHtml:"acls-renewal.html",
      courseMatch:["ACLS", "AHA - ACLS"],
      scheduleFilter:{ classType:"ACLS" }
    },

    { type:"title", text:"Healthcare Provider: PALS", blurb:"Pediatric Advanced Life Support" },
    {
      type:"course",
      key:"AHA - PALS Provider - In Person - Initial",
      title:"AHA – PALS Provider – Initial",
      short:"For first‑time PALS",
      desc:"Recognition and management of pediatric respiratory and shock states.",
      descHtml:"pals-initial.html",
      courseMatch:["PALS", "AHA - PALS"],
      scheduleFilter:{ classType:"PALS" }
    },
    {
      type:"course",
      key:"AHA - PALS Provider - In Person - Renewal",
      title:"AHA – PALS Provider – Renewal",
      short:"Update & renewal",
      desc:"Scenario‑based practice and testing for pediatric emergencies.",
      descHtml:"pals-renewal.html",
      courseMatch:["PALS", "AHA - PALS"],
      scheduleFilter:{ classType:"PALS" }
    },

    { type:"title", text:"Other Programs", blurb:"Workplace & community classes" },
    {
      type:"course",
      key:"HSI - First Aid/CPR/AED (In-Person)",
      title:"HSI – Adult First Aid / CPR AED (Classroom)",
      short:"Meets OSHA 1910.151",
      desc:"Practical first aid plus CPR/AED skills for workplaces and community responders.",
      descHtml:"hsi-facpraed.html",
      courseMatch:["HSI Adult First Aid", "HSI - First Aid/CPR/AED"],
      scheduleFilter:{ classType:"HSI" }
    },
    {
      type:"course",
      key:"AHA - Heartsaver Online",
      title:"AHA – Heartsaver (Online + Skills)",
      short:"Flexible blended path",
      desc:"Complete HeartCode online, then a fast, in‑person skills session.",
      descHtml:"heartsaver-online.html",
      courseMatch:["Heartsaver", "AHA - Heartsaver Online"],
      scheduleFilter:{ classType:"Heartsaver" }
    }
  ];

  let FEED = [];
  let FEED_ERROR = null;
  let MANUAL = [];

  async function loadJSON(path){
    try{ const r = await fetch(path, {cache:'no-store'}); if(!r.ok) return null; return await r.json(); }catch(e){ return null; }
  }

  async function loadFeed(){
    try{
      const r = await fetch(CONFIG.jsonFeed, {cache:'no-store'});
      if(r.ok){
        const j = await r.json();
        if(Array.isArray(j) && j.length>0) return j;
        FEED_ERROR = Array.isArray(j) ? 'JSON feed is empty.' : 'JSON not an array.';
      } else {
        FEED_ERROR = `JSON feed not ok: ${r.status}`;
      }
      throw new Error('No usable JSON');
    }catch(e){
      try{
        const r = await fetch(CONFIG.htmlFallback, {cache:'no-store'});
        if(!r.ok) { FEED_ERROR = `HTML fallback not ok: ${r.status}`; throw new Error('HTML fallback missing'); }
        const html = await r.text();
        const parsed = parseHTMLSchedule(html);
        if(!parsed.length) FEED_ERROR = 'Parsed 0 sessions from HTML fallback.';
        return parsed;
      }catch(e2){
        FEED_ERROR = FEED_ERROR || e2.message || 'Unknown feed error';
        return [];
      }
    }
  }

  async function loadManualSessions(){
    const j = await loadJSON(CONFIG.manualSessions);
    return Array.isArray(j) ? j : [];
  }

  function parseHTMLSchedule(html){
    const doc = new DOMParser().parseFromString(html, 'text/html');
    const anchors = [...doc.querySelectorAll('a[href*="enroll?id="]')];
    const rows = [];
    anchors.forEach(a=>{
      const url = new URL(a.getAttribute('href'), location.origin).href;
      const idMatch = url.match(/id=(\d+)/); const id = idMatch? Number(idMatch[1]) : undefined;
      const row = a.closest('tr') || a.closest('.row') || a.parentElement;
      const text = (row ? row.innerText : a.innerText || '').replace(/\s+/g,' ').trim();
      const title = text.match(/AHA|HSI|Heartsaver|BLS|ACLS|PALS/i)?.[0] ? text : (a.title || a.textContent.trim());
      const when = text.match(/\b(?:Mon|Tue|Wed|Thu|Fri|Sat|Sun)\b.*?\d{1,2}:\d{2}\s*(?:AM|PM)/i)?.[0] || text.match(/\d{4}-\d{2}-\d{2}.*?\d{1,2}:\d{2}/)?.[0];
      const location = text.match(/Wilmington|Burgaw|Jacksonville|Shipyard|Sound Rd|Hinton Ave|Gum Branch/i)?.[0] || '';
      const startAttr = a.getAttribute('data-start');
      const start = startAttr || guessDate(when);
      const courseType = guessType(title);
      rows.push({ id, classType: courseType, title, start, end:null, location, instructor:null, seats:null, url });
    });
    return rows;
  }

  function guessType(title=''){
    const t = title.toLowerCase();
    if(t.includes('acls')) return 'ACLS';
    if(t.includes('pals')) return 'PALS';
    if(t.includes('bls')) return 'BLS';
    if(t.includes('heartsaver')) return 'Heartsaver';
    if(t.includes('hsi')) return 'HSI';
    return 'Other';
  }
  function guessDate(str){ if(!str) return null; const d = new Date(str); return isNaN(d) ? null : d.toISOString(); }

  function withinWindow(dtISO){
    if(!dtISO) return false; const start = new Date(dtISO); if(isNaN(start)) return false;
    const now = new Date(); const limit = new Date(now.getTime() + CONFIG.windowDays*24*3600*1000);
    return start >= now && start <= limit;
  }

  function fmtDate(dtISO){ const d = new Date(dtISO); const opt = {weekday:'short', month:'short', day:'numeric', hour:'numeric', minute:'2-digit'}; return d.toLocaleString(undefined,opt); }
  function seatText(seats){ if(!seats) return ''; const left = seats.capacity - seats.enrolled; return `${left} seats left`; }
  function slug(s){ return String(s||'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,''); }

  function makeTitleCard(text, blurb){ const el = document.createElement('div'); el.className = 'card title'; el.innerHTML = `<h2>${text}</h2>${blurb?`<small>${blurb}</small>`:''}`; return el; }
  function makeCourseCard(c){
    const el = document.createElement('div'); el.className = 'card course'; const keySlug = slug(c.key); el.id = `card-${keySlug}`;
    el.innerHTML = `
      <h3 id="h-${keySlug}"><a href="#${keySlug}" style="text-decoration:none;color:inherit">${c.title}</a> <span class="chip">${c.short||''}</span></h3>
      <details id="d-${keySlug}" data-key="${keySlug}">
        <summary aria-label="Show description and upcoming sessions">Course details & upcoming sessions</summary>
        <div class="desc" id="desc-${keySlug}">${c.desc||''}</div>
        <ul class="slots" id="slots-${keySlug}"><li class="note">Loading sessions…</li></ul>
      </details>`;
    return el;
  }

  function matchesCourse(feedItem, course){
    if(course.scheduleFilter?.classType && feedItem.classType === course.scheduleFilter.classType) return true;
    if(Array.isArray(course.courseMatch)){ const t = (feedItem.title||'').toLowerCase(); return course.courseMatch.some(k => t.includes(String(k).toLowerCase())); }
    return false;
  }

  function mergeSessions(live, manual){
    const all = [...live, ...manual];
    const seen = new Set();
    const out = [];
    all.forEach(s=>{ const id = s.id || `${s.classType}-${s.start}-${s.location}`; if(!seen.has(id)){ seen.add(id); out.push(s); } });
    return out;
  }

  async function loadSnippets(){
    await Promise.all(CATALOG.map(async c=>{
      if(c.type!=="course" || !c.descHtml) return;
      const path = CONFIG.snippetRoot + c.descHtml;
      try{
        const r = await fetch(path, {cache:'no-store'});
        if(!r.ok) return; const html = await r.text();
        const el = document.getElementById(`desc-${slug(c.key)}`);
        if(el){ el.innerHTML = html; }
      }catch(e){ /* ignore */ }
    }));
  }

  function renderCatalog(container, feed){
    container.innerHTML = '';
    const detailsMap = new Map();
    CATALOG.forEach((item) =>{
      if(item.type === 'title'){
        container.appendChild(makeTitleCard(item.text, item.blurb));
      } else if(item.type === 'course'){
        const card = makeCourseCard(item); container.appendChild(card);
        const keySlug = slug(item.key);
        const slotsEl = card.querySelector(`#slots-${keySlug}`);
        const det = card.querySelector(`#d-${keySlug}`); detailsMap.set(keySlug, det);
        const sessionsLive = feed.filter(s => matchesCourse(s, item)).filter(s => withinWindow(s.start));
        const sessionsManual = MANUAL.filter(s => matchesCourse(s, item)).filter(s => withinWindow(s.start));
        const sessions = mergeSessions(sessionsLive, sessionsManual).sort((a,b)=> new Date(a.start) - new Date(b.start)).slice(0, CONFIG.maxSessionsPerCourse);

        if(!sessions.length){
          slotsEl.innerHTML = '<li class="note">No upcoming sessions in the next 4 weeks. See full schedule.</li>';
        }else{
          slotsEl.innerHTML = '';
          sessions.forEach(s=>{
            const li = document.createElement('li'); const seat = seatText(s.seats);
            li.innerHTML = `
              <div>
                <time datetime="${s.start}">${fmtDate(s.start)}</time>
                <div class="meta">${s.location || ''}</div>
              </div>
              <div class="go">
                <a class="btn" href="${s.url}" rel="noopener" target="_blank" aria-label="Register for ${item.title} on ${fmtDate(s.start)}">Register →</a>
                ${seat?`<div class="note" style="text-align:right">${seat}</div>`:''}
              </div>`;
            slotsEl.appendChild(li);
          });
        }
      }
    });
    applyOpenFromURL(detailsMap);
  }

  function applyOpenFromURL(detailsMap){
    const params = new URLSearchParams(location.search);
    const openAll = params.get('open') === 'all';
    const hash = decodeURIComponent(location.hash.replace('#',''));
    if(openAll){ detailsMap.forEach(d => d && d.setAttribute('open','')); return; }
    if(hash && detailsMap.has(hash)){
      const d = detailsMap.get(hash); if(d){ d.setAttribute('open',''); }
      const card = document.getElementById(`card-${hash}`); if(card){ card.scrollIntoView({behavior:'smooth', block:'start'}); }
    }
  }

  (async function init(){
    const grid = document.getElementById('courseGrid');
    FEED = await loadFeed();
    MANUAL = await loadManualSessions();
    renderCatalog(grid, FEED);
    await loadSnippets();

    if(!FEED.length && !MANUAL.length){
      const warn = document.createElement('div'); warn.className = 'note'; warn.style.color = '#a00'; warn.style.fontWeight = '700'; warn.style.marginTop = '12px';
      warn.textContent = `No sessions loaded. Put JSON at ${CONFIG.jsonFeed} or HTML fallback at ${CONFIG.htmlFallback}. Detail: ${FEED_ERROR || 'n/a'}`;
      document.querySelector('.wrap').appendChild(warn);
    }
  })();

  window.addEventListener('hashchange', () => {
    const grid = document.getElementById('courseGrid');
    const map = new Map([...grid.querySelectorAll('details[id^="d-"]')].map(d => [d.id.slice(2), d]));
    applyOpenFromURL(map);
  });
  </script>
</body>
</html>

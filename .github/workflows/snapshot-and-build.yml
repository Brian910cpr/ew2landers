name: Snapshot and build schedule/status

on:
  workflow_dispatch:
  schedule:
    - cron: "7 * * * *"   # run at minute 7 every hour

permissions:
  contents: write

jobs:
  snapshot-and-build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Show repo tree
        run: |
          echo "=== pwd ==="
          pwd
          echo "=== ls (root) ==="
          ls
          echo "=== ls docs ==="
          ls docs || true
          echo "=== ls docs/data ==="
          ls docs/data || true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python dependencies
        run: |
          set -x
          python -m pip install --upgrade pip
          pip install beautifulsoup4 lxml python-dateutil
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Fetch Enrollware schedule snapshot
        run: |
          set -x
          mkdir -p docs/data
          curl -fsSL "https://coastalcprtraining.enrollware.com/schedule" \
            -H "User-Agent: ew2landers-actions-snapshot" \
            -o docs/data/enrollware-schedule.html
          echo "=== Snapshot size and head ==="
          wc -c docs/data/enrollware-schedule.html
          head -20 docs/data/enrollware-schedule.html || true

      # Build schedule.json from the HTML snapshot
      - name: Build schedule.json
        run: |
          set -x
          python scripts/parse_enrollware.py docs/data/enrollware-schedule.html docs/data/schedule.json
          echo "=== schedule.json size ==="
          wc -c docs/data/schedule.json
          echo "=== schedule.json (first 40 lines) ==="
          head -40 docs/data/schedule.json || true
          jq -e . docs/data/schedule.json >/dev/null

      # Enrich schedule.json with real 6-digit Enrollware course numbers
      - name: Enrich schedule.json with real Enrollware course numbers
        run: |
          set -x
          python enrich_schedule_with_course_ids.py \
            --html docs/data/enrollware-schedule.html \
            --schedule docs/data/schedule.json
          echo "=== schedule.json after enrich (first 40 lines) ==="
          head -40 docs/data/schedule.json || true

      # Build status.json from the final schedule.json
      - name: Build status.json
        run: |
          set -x
          python - << 'PY'
          import json, pathlib, datetime
          sched_path = pathlib.Path("docs/data/schedule.json")
          print("STATUS STEP: reading", sched_path)
          data = json.loads(sched_path.read_text(encoding="utf-8"))
          courses = data.get("courses", [])
          sessions = data.get("sessions", [])
          now = datetime.datetime.utcnow().isoformat(timespec="seconds") + "Z"
          status = {
              "generated_at": now,
              "course_count": len(courses),
              "session_count": len(sessions),
          }
          out = pathlib.Path("docs/data/status.json")
          out.write_text(json.dumps(status, indent=2), encoding="utf-8")
          print("STATUS STEP: wrote", out)
          PY
          echo "=== status.json ==="
          cat docs/data/status.json || true

      # Rebuild docs/index.html from the latest snapshot
      - name: Build docs/index.html
        run: |
          set -x
          python build-index.py docs/data/enrollware-schedule.html docs/index.html
          echo "=== index.html head ==="
          head -40 docs/index.html || true

      # Commit everything if anything changed
      - name: Commit snapshot and JSONs if changed
        run: |
          set -x
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add docs/data/enrollware-schedule.html docs/data/schedule.json docs/data/status.json docs/index.html || true

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "chore: refresh snapshot, schedule.json, status.json, and index.html"
          git push

name: Snapshot Enrollware + Build schedule/status

on:
  workflow_dispatch:
  schedule:
    - cron: "11 * * * *"   # minute 11 every hour

permissions:
  contents: write

jobs:
  snapshot_and_build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Show repo tree
        run: |
          echo "=== pwd ==="
          pwd
          echo "=== ls (root) ==="
          ls
          echo "=== ls docs ==="
          ls docs || true
          echo "=== ls docs/data ==="
          ls docs/data || true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python dependencies
        run: |
          set -x
          python -m pip install --upgrade pip
          pip install beautifulsoup4 lxml python-dateutil
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Fetch latest Enrollware HTML snapshot
        run: |
          set -x
          mkdir -p docs/data
          curl -fsSL "https://coastalcprtraining.enrollware.com/schedule" \
            -H "User-Agent: ew2landers-actions-snapshot" \
            -o docs/data/enrollware-schedule.html
          echo "=== Snapshot size and head ==="
          wc -c docs/data/enrollware-schedule.html
          head -20 docs/data/enrollware-schedule.html || true

      - name: Build schedule.json
        run: |
          set -x
          python scripts/parse_enrollware.py docs/data/enrollware-schedule.html docs/data/schedule.json
          echo "=== schedule.json size ==="
          wc -c docs/data/schedule.json
          echo "=== schedule.json (first 40 lines) ==="
          head -40 docs/data/schedule.json || true
          jq -e . docs/data/schedule.json >/dev/null

      - name: Enrich schedule.json with course ids (no-op for now)
        run: |
          set -x
          python scripts/enrich_schedule_with_course_ids.py \
            --html docs/data/enrollware-schedule.html \
            --schedule docs/data/schedule.json
          echo "=== schedule.json after enrich (first 40 lines) ==="
          head -40 docs/data/schedule.json || true

      - name: Rebuild status.json
        run: |
          set -x
          python - << 'PY'
          import json, pathlib, hashlib, datetime, os

          root = pathlib.Path("docs/data")
          snap = root / "enrollware-schedule.html"
          sched = root / "schedule.json"

          def checksum(path):
              if not path.exists():
                  return None
              h = hashlib.md5()
              with path.open("rb") as f:
                  for chunk in iter(lambda: f.read(8192), b""):
                      h.update(chunk)
              return {
                  "exists": True,
                  "bytes": path.stat().st_size,
                  "md5": h.hexdigest(),
              }

          data = {
              "updated_at": datetime.datetime.utcnow().isoformat(timespec="seconds") + "Z",
              "snapshot": checksum(snap) or {"exists": False},
              "schedule": checksum(sched) or {"exists": False},
              "github": {
                  "sha": os.environ.get("GITHUB_SHA", ""),
                  "run_id": os.environ.get("GITHUB_RUN_ID", ""),
                  "repo": os.environ.get("GITHUB_REPOSITORY", ""),
              },
          }

          out = root / "status.json"
          out.write_text(json.dumps(data, indent=2), encoding="utf-8")
          print(out.read_text(encoding="utf-8"))
          PY

      - name: Commit snapshot/schedule/status if changed
        run: |
          set -x
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # Defuse races if another run pushed first
          git pull --rebase origin main || true

          git add docs/data/enrollware-schedule.html docs/data/schedule.json docs/data/status.json

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "chore: refresh snapshot, schedule.json, and status.json" || {
            echo "Nothing to commit after all."
            exit 0
          }

          git push origin main || {
            echo "WARNING: git push failed (likely race with another run)."
            exit 0
          }

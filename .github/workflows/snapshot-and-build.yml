name: Snapshot and build schedule/status

on:
workflow_dispatch:
schedule:
- cron: "7 * * * *" # run at minute 7 every hour

permissions:
contents: write

jobs:
snapshot-and-build:
runs-on: ubuntu-latest

steps:
  - name: Checkout repo
    uses: actions/checkout@v4

  - name: Set up Python
    uses: actions/setup-python@v5
    with:
      python-version: "3.11"

  - name: Install Python dependencies
    run: |
      python -m pip install --upgrade pip
      python -m pip install beautifulsoup4

  - name: Fetch latest Enrollware HTML snapshot
    run: |
      mkdir -p docs/data
      curl -fsSL "https://coastalcprtraining.enrollware.com/schedule" \
        -H "User-Agent: ew2landers-actions-snapshot" \
        -o docs/data/enrollware-schedule.html
      wc -c docs/data/enrollware-schedule.html

  - name: Build docs/data/schedule.json from snapshot
    run: |
      python parse_enrollware.py docs/data/enrollware-schedule.html docs/data/schedule.json

  - name: Enrich schedule.json with real course numbers
    run: |
      python enrich_schedule_with_course_ids.py \
        --html docs/data/enrollware-schedule.html \
        --schedule docs/data/schedule.json

  - name: Build docs/data/status.json (meta info)
    run: |
      python - << 'PY'
      import json, pathlib, datetime
      sched_path = pathlib.Path("docs/data/schedule.json")
      data = json.loads(sched_path.read_text(encoding="utf-8"))
      courses = data.get("courses", [])
      sessions = data.get("sessions", [])
      generated_at = data.get("generated_at") or datetime.datetime.utcnow().isoformat(timespec="seconds") + "Z"
      status = {
          "generated_at": generated_at,
          "course_count": len(courses),
          "session_count": len(sessions),
      }
      pathlib.Path("docs/data/status.json").write_text(
          json.dumps(status, indent=2), encoding="utf-8"
      )
      PY

  - name: Commit snapshot and JSONs if changed
    run: |
      git config user.name  "github-actions[bot]"
      git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      git add docs/data/enrollware-schedule.html docs/data/schedule.json docs/data/status.json || true

      if git diff --cached --quiet; then
        echo "No changes to commit."
        exit 0
      fi

      git commit -m "chore: refresh snapshot, schedule.json, and status.json"
      git push
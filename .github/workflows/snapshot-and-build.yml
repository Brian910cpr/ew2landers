name: Snapshot and build schedule/status

on:
  workflow_dispatch:
  schedule:
    - cron: "7 * * * *"   # run at minute 7 every hour

permissions:
  contents: write

jobs:
  snapshot-and-build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Show repo tree
        run: |
          echo "=== Working Directory ==="
          pwd
          echo "=== Root listing ==="
          ls
          echo "=== docs/data listing (if exists) ==="
          ls docs || true
          ls docs/data || true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python dependencies
        run: |
          set -x
          python -m pip install --upgrade pip
          python -m pip install beautifulsoup4
          python -c "import sys, bs4; print('Python + bs4 OK:', sys.version)"

      - name: Fetch latest Enrollware HTML snapshot
        run: |
          set -x
          mkdir -p docs/data
          curl -fsSL "https://coastalcprtraining.enrollware.com/schedule" \
            -H "User-Agent: ew2landers-actions-snapshot" \
            -o docs/data/enrollware-schedule.html
          echo "=== Snapshot size and head ==="
          wc -c docs/data/enrollware-schedule.html
          head -20 docs/data/enrollware-schedule.html || true

      - name: Build schedule.json
        run: |
          set -x
          python parse_enrollware.py docs/data/enrollware-schedule.html docs/data/schedule.json
          echo "=== schedule.json (first 40 lines AFTER PARSE) ==="
          head -40 docs/data/schedule.json || true

      - name: Enrich schedule.json with real Enrollware course numbers
        run: |
          set -x
          python enrich_schedule_with_course_ids.py \
            --html docs/data/enrollware-schedule.html \
            --schedule docs/data/schedule.json
          echo "=== schedule.json (first 40 lines AFTER ENRICH) ==="
          head -40 docs/data/schedule.json || true

      - name: Build status.json
        run: |
          set -x
          python - << 'PY'
          import json, pathlib, datetime
          sched_path = pathlib.Path("docs/data/schedule.json")
          print("STATUS STEP: reading", sched_path)
          data = json.loads(sched_path.read_text(encoding="utf-8"))
          courses = data.get("courses", [])
          sessions = data.get("sessions", [])
          generated_at = data.get("generated_at") or datetime.datetime.utcnow().isoformat(timespec="seconds") + "Z"
          status = {
              "generated_at": generated_at,
              "course_count": len(courses),
              "session_count": len(sessions),
          }
          out = pathlib.Path("docs/data/status.json")
          out.write_text(json.dumps(status, indent=2), encoding="utf-8")
          print("WROTE status.json:", out)
          PY
          echo "=== status.json ==="
          cat docs/data/status.json || true

      - name: Build index.html
        run: |
          set -x
          python build-index.py
          echo "=== index.html head ==="
          head -20 docs/index.html || true

      - name: Commit snapshot and JSONs if changed
        run: |
          set -x
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add docs/data/enrollware-schedule.html docs/data/schedule.json docs/data/status.json docs/index.html || true

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "chore: refresh snapshot, schedule.json, status.json, index.html"
          git push
          echo "Commit and push complete."

name: Snapshot and build schedule/status

on:
  workflow_dispatch:
  schedule:
    - cron: "7 * * * *"

permissions:
  contents: write

jobs:
  snapshot-and-build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Show repo tree
        run: |
          echo "=== Working Directory ==="
          pwd
          echo "=== Root ==="
          ls
          echo "=== docs/data ==="
          ls docs/data || true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python deps
        run: |
          set -x
          python -m pip install --upgrade pip
          python -m pip install beautifulsoup4

      - name: Fetch latest Enrollware HTML snapshot
        run: |
          set -x
          mkdir -p docs/data
          curl -fsSL "https://coastalcprtraining.enrollware.com/schedule" \
            -H "User-Agent: ew2landers-snapshot" \
            -o docs/data/enrollware-schedule.html
          echo "=== Snapshot Head ==="
          head -20 docs/data/enrollware-schedule.html || true

      - name: Build schedule.json
        run: |
          set -x
          python parse_enrollware.py docs/data/enrollware-schedule.html docs/data/schedule.json
          echo "=== schedule.json (first 40 lines) ==="
          head -40 docs/data/schedule.json || true

      - name: Enrich schedule.json
        run: |
          set -x
          python enrich_schedule_with_course_ids.py \
            --html docs/data/enrollware-schedule.html \
            --schedule docs/data/schedule.json
          echo "=== schedule.json after enrichment ==="
          head -40 docs/data/schedule.json || true

      - name: Write status.json
        run: |
          set -x
          python - << 'PY'
          import json, pathlib, datetime
          p = pathlib.Path("docs/data/schedule.json")
          data = json.loads(p.read_text(encoding="utf-8"))
          status = {
              "generated_at": data.get("generated_at"),
              "course_count": len(data.get("courses", [])),
              "session_count": len(data.get("sessions", [])),
          }
          pathlib.Path("docs/data/status.json").write_text(
              json.dumps(status, indent=2),
              encoding="utf-8"
          )
          print("Wrote status.json")
          PY
          echo "=== status.json ==="
          cat docs/data/status.json || true

      - name: Build index.html
        run: |
          set -x
          python build-index.py
          echo "=== index.html head ==="
          head -20 docs/index.html || true

      - name: Commit files if changed
        run: |
          set -x
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add docs/data/enrollware-schedule.html
          git add docs/data/schedule.json
          git add docs/data/status.json
          git add docs/index.html

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "chore: update schedule + snapshot + index"
          git push

name: Refresh Enrollware Snapshot

on:
  schedule:
    - cron: "11 * * * *"   # hourly at :11
  workflow_dispatch:

permissions:
  contents: write

jobs:
  snapshot:
    runs-on: ubuntu-latest
    env:
      TZ: America/New_York
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install parser deps
        run: |
          python -m pip install --upgrade pip
          pip install beautifulsoup4 python-dateutil

      - name: Pull Enrollware schedule HTML
        run: |
          mkdir -p docs/data
          curl -fSL \
            -A "910CPR-LanderBot/1.0 (+https://brian910cpr.github.io/ew2landers/)" \
            https://coastalcprtraining.enrollware.com/schedule \
            -o docs/data/enrollware-schedule.html

      - name: Build docs/data/schedule.json from HTML
        run: |
          python - << 'PY'
          import json, re, os
          from datetime import datetime, timedelta
          from zoneinfo import ZoneInfo
          from bs4 import BeautifulSoup
          from dateutil import parser as dparser

          TZ = ZoneInfo("America/New_York")
          NOW = datetime.now(TZ)
          WINDOW_DAYS = 56

          html_path = "docs/data/enrollware-schedule.html"
          out_path  = "docs/data/schedule.json"

          if not os.path.exists(html_path):
            raise SystemExit(f"Missing {html_path}")

          with open(html_path, "r", encoding="utf-8", errors="ignore") as f:
            html = f.read()

          soup = BeautifulSoup(html, "html.parser")
          anchors = soup.select('a[href*="enroll?id="]')
          items = []

          def ctype(title):
            t = (title or "").lower()
            if "acls" in t: return "ACLS"
            if "pals" in t: return "PALS"
            if "bls" in t: return "BLS"
            if "heartsaver" in t: return "Heartsaver"
            if "hsi" in t or "first aid" in t: return "HSI"
            return "Other"

          def pd(t):
            try:
              dt = dparser.parse(t, fuzzy=True, default=NOW.replace(hour=0, minute=0, second=0, microsecond=0))
              if dt.tzinfo is None:
                dt = dt.replace(tzinfo=TZ)
              return dt.astimezone(TZ)
            except Exception:
              return None

          for a in anchors:
            href = a.get("href","")
            url = href if href.startswith("http") else f"https://coastalcprtraining.enrollware.com/{href.lstrip('/')}"
            m = re.search(r"id=(\d+)", url)
            if not m: 
              continue
            cid = int(m.group(1))

            container = a.find_parent("tr") or a.find_parent(class_=re.compile(r"(row|card|class|item)", re.I)) or a.parent
            text = " ".join((container.get_text(" ", strip=True) if container else a.get_text(" ", strip=True)).split())

            h = None
            if container:
              h = container.find(["h1","h2","h3","h4"]) or container.select_one(".title,.name")
            title = (h.get_text(" ", strip=True) if h else a.get_text(" ", strip=True)) or text

            loc = ""
            for key in ["Wilmington", "Burgaw", "Jacksonville", "Shipyard", "Sound Rd", "Hinton Ave", "Gum Branch", "Merlot Ct"]:
              if key.lower() in text.lower():
                loc = key
                break

            m2 = re.search(r"(Mon|Tue|Wed|Thu|Fri|Sat|Sun)[^,]*\d{1,2}[:.]\d{2}\s*(AM|PM)", text, re.I)
            dt = pd(m2.group(0)) if m2 else pd(text)
            start_iso = dt.isoformat() if dt else None

            items.append({
              "id": cid,
              "classType": ctype(title),
              "title": title,
              "start": start_iso,
              "end": None,
              "location": loc,
              "instructor": None,
              "seats": None,
              "url": url
            })

          limit = NOW + timedelta(days=WINDOW_DAYS)
          seen = set()
          out = []
          for it in items:
            s = it.get("start")
            if not s: 
              continue
            try:
              dt = dparser.parse(s)
              if dt.tzinfo is None:
                dt = dt.replace(tzinfo=TZ)
            except Exception:
              continue
            if dt >= NOW and dt <= limit and it["id"] not in seen:
              out.append(it); seen.add(it["id"])

          out.sort(key=lambda x: x["start"] or "")
          os.makedirs(os.path.dirname(out_path), exist_ok=True)
          with open(out_path, "w", encoding="utf-8") as f:
            json.dump(out, f, indent=2, ensure_ascii=False)
          print(f"Wrote {len(out)} items to {out_path}")
          PY

      - name: Commit if changed (HTML or JSON)
        run: |
          if git diff --quiet -- docs/data/enrollware-schedule.html docs/data/schedule.json; then
            echo "No changes."
            exit 0
          fi
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add docs/data/enrollware-schedule.html docs/data/schedule.json
          git commit -m "chore: refresh Enrollware snapshot and schedule.json"
          git push
